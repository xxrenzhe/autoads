generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider     = "postgresql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

// --- Event Sourcing Core Table ---
model Event {
  id            String   @id @default(cuid())
  aggregateId   String
  aggregateType String
  eventType     String
  payload       Json
  version       Int
  createdAt     DateTime @default(now())

  @@index([aggregateId, aggregateType])
  @@index([eventType])
}

// --- Read Models (Projections) ---

// --- Core Entities ---
model Plan {
  id          String   @id
  name        String   @unique // "Free", "Pro", "Max"
  description String
  price       Float
  tokenCredit Int      @default(0)
  
  subscriptions Subscription[]
}

model User {
  id                      String    @id
  email                   String    @unique
  name                    String?
  passwordHash            String?
  role                    String    @default("USER")
  createdAt               DateTime
  lastLoginAt             DateTime?
  notificationPreferences Json?

  subscription      Subscription?
  tokens            UserToken?
  workflows         UserWorkflowProgress[]
  checklistProgress UserChecklistProgress[]
  notifications     Notification[]
  offers            Offer[]
  batchopenTasks    BatchopenTask[]
  siterankAnalyses  SiterankAnalysis[]
}

model Subscription {
  id               String    @id
  userId           String    @unique
  planId           String
  planName         String
  status           String
  trialEndsAt      DateTime?
  currentPeriodEnd DateTime
  stripeCustomerId String?

  user User @relation(fields: [userId], references: [id])
  plan Plan @relation(fields: [planId], references: [id])
}

model UserToken {
  userId    String   @id
  balance   BigInt
  updatedAt DateTime

  user User @relation(fields: [userId], references: [id])
}

// --- Global Offer Library ---
model Offer {
  id            String   @id
  userId        String
  name          String
  originalUrl   String
  status        String
  siterankScore Float?
  createdAt     DateTime

  user             User               @relation(fields: [userId], references: [id])
  batchopenTasks   BatchopenTask[]
  siterankAnalysis SiterankAnalysis?
  
  @@index([userId])
}

// --- Workflow & Onboarding ---
model WorkflowTemplate {
  id          String @id
  name        String @unique
  description String
  steps       Json

  userWorkflows UserWorkflowProgress[]
}

model UserWorkflowProgress {
  id          String @id
  userId      String
  templateId  String
  currentStep Int
  status      String
  context     Json   @default("{}")

  user     User             @relation(fields: [userId], references: [id])
  template WorkflowTemplate @relation(fields: [templateId], references: [id])

  @@index([userId])
}

model OnboardingChecklist {
  id           String @id
  step         Int    @unique
  title        String
  description  String
  targetUrl    String
  rewardTokens Int

  userProgress UserChecklistProgress[]
}

model UserChecklistProgress {
  id          String    @id
  userId      String
  stepId      String
  isCompleted Boolean
  completedAt DateTime?

  user User                @relation(fields: [userId], references: [id])
  step OnboardingChecklist @relation(fields: [stepId], references: [id])

  @@unique([userId, stepId])
}

// --- Notification System ---
model Notification {
  id        String   @id
  userId    String
  title     String
  content   String
  isRead    Boolean  @default(false)
  createdAt DateTime

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

// --- Feature Module Read Models ---
model BatchopenTask {
  id               String   @id
  userId           String
  offerId          String
  simulationConfig Json
  status           String
  progress         Float    @default(0)
  createdAt        DateTime

  user  User  @relation(fields: [userId], references: [id])
  offer Offer @relation(fields: [offerId], references: [id])

  @@index([userId, offerId])
}

model SiterankAnalysis {
  id        String   @id
  userId    String
  offerId   String   @unique
  status    String // "pending", "completed", "failed"
  result    Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id])
  offer Offer @relation(fields: [offerId], references: [id])

  @@index([userId])
}
