swagger: "2.0"
info:
  title: autoads-gateway
  version: 1.0.0
schemes:
  - https
produces:
  - application/json

# Firebase JWT 验证（GAE/API Gateway 扩展）
securityDefinitions:
  firebase:
    type: oauth2
    flow: "implicit"
    authorizationUrl: ""
    x-google-issuer: "https://securetoken.google.com/gen-lang-client-0944935873"
    x-google-jwks_uri: "https://www.googleapis.com/service_accounts/v1/jwk/securetoken@system.gserviceaccount.com"
    x-google-audiences: "gen-lang-client-0944935873"

paths:
  # Global health endpoints
  /api/health:
    get:
      operationId: healthAggregate
      x-google-backend:
        address: https://identity-yt54xvsg5q-an.a.run.app/api/health
        path_translation: CONSTANT_ADDRESS
      responses:
        '200':
          description: OK

  /api/health/console:
    get:
      operationId: healthConsole
      x-google-backend:
        address: https://console-yt54xvsg5q-an.a.run.app/health
        path_translation: CONSTANT_ADDRESS
      responses:
        '200':
          description: OK
  # Offer 服务
  /api/v1/offers:
    get:
      operationId: offersList
      security:
        - firebase: []
      x-google-backend:
        address: https://offer-yt54xvsg5q-an.a.run.app
      responses:
        '200':
          description: OK
    post:
      operationId: offersCreate
      security:
        - firebase: []
      x-google-backend:
        address: https://offer-yt54xvsg5q-an.a.run.app
      responses:
        '202':
          description: Accepted

  # Workflow 服务（模板查询与启动）
  /api/v1/workflows:
    get:
      operationId: workflowsList
      security:
        - firebase: []
      x-google-backend:
        address: https://workflow-yt54xvsg5q-an.a.run.app
      responses:
        '200': { description: OK }
    post:
      operationId: workflowsStart
      security:
        - firebase: []
      x-google-backend:
        address: https://workflow-yt54xvsg5q-an.a.run.app
      responses:
        '202': { description: Accepted }

  # Billing 服务（示例：我的订阅、我的 Token）
  /api/v1/billing/subscriptions/me:
    get:
      operationId: billingMySubscription
      security:
        - firebase: []
      x-google-backend:
        address: https://billing-yt54xvsg5q-an.a.run.app
      responses:
        '200': { description: OK }

  /api/v1/billing/tokens/me:
    get:
      operationId: billingMyTokens
      security:
        - firebase: []
      x-google-backend:
        address: https://billing-yt54xvsg5q-an.a.run.app
      responses:
        '200': { description: OK }

  # Adscenter 服务（示例：受保护资源）
  # OAuth 回调（公开）
  /api/v1/adscenter/oauth/callback:
    get:
      operationId: adscenterOauthCallback
      x-google-backend:
        address: https://adscenter-yt54xvsg5q-an.a.run.app
        path_translation: APPEND_PATH_TO_ADDRESS
      responses:
        '200': { description: OK }

  /api/v1/adscenter/*:
    get:
      operationId: adscenterWildcardGet
      security: [ { firebase: [] } ]
      x-google-backend:
        address: https://adscenter-yt54xvsg5q-an.a.run.app
      responses: { '200': { description: OK } }
    post:
      operationId: adscenterWildcardPost
      security: [ { firebase: [] } ]
      x-google-backend:
        address: https://adscenter-yt54xvsg5q-an.a.run.app
      responses: { '201': { description: Created } }

  # Identity 服务（健康检查/受保护接口按需添加）
  /api/v1/identity/healthz:
    get:
      operationId: identityHealthz
      x-google-backend:
        address: https://identity-yt54xvsg5q-an.a.run.app/healthz
        path_translation: CONSTANT_ADDRESS
      responses:
        '200': { description: OK }

x-google-endpoints:
  - name: autoads-gateway.endpoints.gen-lang-client-0944935873.cloud.goog
    allowCors: true

# 使用说明：
# 1) 将 REPLACE_WITH_RUN_URL 替换为各 Cloud Run 服务的 HTTPS 域名
#    例如：offer-abc123-asia-northeast1.a.run.app
# 2) 创建/更新 API 与网关：
#    gcloud api-gateway apis create autoads-api --project=gen-lang-client-0944935873 || true
#    gcloud api-gateway api-configs create autoads-v1 \
#      --api=autoads-api --openapi-spec=deployments/api-gateway/gateway.yaml \
#      --project=gen-lang-client-0944935873
#    gcloud api-gateway gateways create autoads-gw \
#      --api=autoads-api --api-config=autoads-v1 --location=asia-northeast1 \
#      --project=gen-lang-client-0944935873
# 说明：
# - API Gateway 负责 JWT 校验；自定义 `role=ADMIN` 需要在后端微服务中间件中基于 Firebase Token 的自定义 Claim 再次判定。
# - 对 `/console` 前端路由，继续使用 Next.js middleware（Edge）做角色限制。
