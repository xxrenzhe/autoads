events {}

http {
    upstream billing_service {
        server billing:8080;
    }
    upstream offer_service {
        server offer:8080;
    }
    upstream siterank_service {
        server siterank:8080;
    }
    upstream batchopen_service {
        server batchopen:8080;
    }
    upstream adscenter_service {
        server adscenter:8080;
    }
    upstream console_service {
        server console:8080;
    }

    server {
        listen 80;

        # Identity 服务已移除，统一由 API Gateway 进行 Firebase Bearer 校验

        location /api/v1/billing/ {
            proxy_pass http://billing_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
        }

        location /api/v1/offer/ {
            proxy_pass http://offer_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
        }

        location /api/v1/siterank/ {
            proxy_pass http://siterank_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
        }

        location /api/v1/batchopen/ {
            proxy_pass http://batchopen_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
        }

        location /api/v1/adscenter/ {
            proxy_pass http://adscenter_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
        }

        # Workflow 服务已移除，事件驱动架构替代

        # 移除桥接服务路由；生产使用 API Gateway；前端 Blog 走 Firebase Web SDK 直读 Firestore

        # Health check for the gateway itself
        location /healthz {
            return 200 'OK';
        }

        # Admin Console (隐藏入口，仅URL直达)
        location /console/ {
            proxy_pass http://console_service/console/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
        }

        # Console API
        location /api/v1/console/ {
            proxy_pass http://console_service/api/v1/console/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
        }
    }
}
