# 重构落地进展（2025-09-26）

本次进展聚焦 C组（Browser‑Exec 服务）对 `json-fetch` 稳定性与可配置性增强，支撑 Siterank 回退抓取路径成功率提升与 P95 目标达成。

## 已完成
- Browser‑Exec `resolve-offer` 新增
  - 端点：`POST /api/v1/browser/resolve-offer`，用于经真实浏览器解析多重重定向，返回 `finalUrl/finalUrlSuffix/domain/brand/chain` 与计时
  - 支持 `waitUntil=networkidle|load|domcontentloaded`、`timeoutMs`（默认45s，上限60s）、`stabilizeMs` URL稳定窗口
  - 继承代理预检、UA/Headers 注入、容量护栏与指标
- Browser‑Exec `json-fetch` 增强（第一阶段）
  - 新增参数：`userAgent`、`headers`、`waitUntil`（domcontentloaded|load|networkidle）、`timeoutMs`（1s..30s）
  - 代理预检：从代理提供者获取 3–5 条候选，优先对 `https://www.gstatic.com/generate_204` 做 3s 快速连通性探测，优先选择可用代理；失败则回退随机代理
  - UA 兜底：若未显式传入 `userAgent`，尝试使用环境变量 `SIMILARWEB_USER_AGENT`
  - 额外请求头：支持 `headers` 注入（通过 `page.setExtraHTTPHeaders`），便于伪装/绕过基础防护
  - 超时与等待策略：`timeoutMs` 上限提升至 30s；`waitUntil` 可配置为 `load`/`networkidle` 等，覆盖更复杂的页面加载场景
  - 指标：容量耗尽仍计入 `be_capacity_exhausted_total`，与既有并发护栏保持一致

- 支持脚本
  - 新增 `scripts/ops/smoke-browser-json.sh`：对 `json-fetch` 做端到端冒烟，覆盖 UA/Headers/超时/等待策略
  - 新增 `scripts/ops/smoke-resolve-offer.sh`：对 `resolve-offer` 端点做冒烟，验证 Final URL/suffix/brand/chain
  
- Siterank（可选新路径，受开关 ANALYZE_WITH_RESOLVE=1 控制）
  - 新增“解析落地 + AI 评分”分析路径：resolve-offer → SimilarWeb(metrics) → page-signals → AI评分（失败回退规则评分）
  - 返回结构包含：resolve 结果、SimilarWeb 摘要、pageSignals、score、usedAI、degraded、country
  - AI端点通过 `AI_SCORING_URL` 配置（HTTP JSON），超时 8s；失败回退 KISS 评分

## 验证建议
- 本地/预发冒烟
  - 启动 Cloud Run 预发实例或本地服务（需 `PLAYWRIGHT=1` 且已安装 chromium）
  - 冒烟示例：
    - `BROWSER_URL=https://<run-url> ./scripts/ops/smoke-browser-json.sh https://api.similarweb.com/some/json` 
    - 可附加：`WAIT_UNTIL=networkidle TIMEOUT_MS=25000 UA="Custom-UA"`
- Siterank 回退路径联调
  - 在 siterank 配置 `BROWSER_EXEC_URL`、`SIMILARWEB_USER_AGENT`；触发 analyze，观察 `via=proxy` 成功率与 P95

## 新要求对齐
- 取消“10秒SLO”：已在 `resolve-offer` 默认使用 45–60s 导航超时与 URL 稳定窗口；siterank 引入新分析路径允许解析 >10s
- 价值分引入 AI：siterank 新增 `ANALYZE_WITH_RESOLVE=1` 模式，流程为 resolve → SimilarWeb(metrics) → page-signals → AI评分（失败回退规则评分）；AI端点由 `AI_SCORING_URL` 配置

## 本次预发部署与冒烟记录
- Cloud Run
  - browser-exec-preview: https://browser-exec-preview-644672509127.asia-northeast1.run.app
  - 镜像：asia-northeast1-docker.pkg.dev/.../browser-exec:preview-20250926120249
- 冒烟结果（resolve-offer，对应你的测试Case）
  - 请求：POST /api/v1/browser/resolve-offer { url:"https://pboost.me/ZDO2Bdek", waitUntil:"domcontentloaded", timeoutMs:60000, stabilizeMs:1500 }
  - 响应要点：
    - finalUrl: https://www.yitahome.com/
    - finalUrlSuffix: pbtid=pb_...&utm_source=PartnerBoost&utm_medium=affiliate&utm_campaign=448227&utm_content=0
    - domain: www.yitahome.com（已在 siterank 去前缀规范化为 yitahome.com）
    - brand: yitahome
    - navMs≈4.8s, stabilizeMs≈1.6s
- SimilarWeb 抓取
  - 直连/代理回退部分目标域可能 20–30s 超时；已按设计启用降级与通知，后续调整 UA/代理轮换策略与等待策略

- Siterank 端到端（预发，新增 analyze-url 冒烟端点）
  - 端点：POST /api/v1/siterank/analyze-url（仅预发调试用；传入 url/offerId，可走“解析落地+AI评分”路径）
  - 用例：{"url":"https://pboost.me/ZDO2Bdek","offerId":"offer-pboost-yita"}
  - 结果（节选）：status=completed, usedAI=false（回退规则评分）, degraded=true, score≈39,
    resolve.finalUrl=https://www.yitahome.com/（解析成功），similarweb=null（超时降级），pageSignals.status=200

### A2.2 统一认证与身份清理（本地与脚手架补全）
- 本地工作区与开发脚本去除 identity/workflow，保持“最终形态直达”一致：
  - go.work 去除 `./services/identity` 与 `./services/workflow`
  - package.json `dev:services` 去除 identity/workflow，补充 `notifications` 与 `console`
- 验证脚本扩展：`scripts/ops/verify-infra.sh` 增加 `notifications`、`recommendations` 到已知服务清单
- 注：保留 `services/identity` 代码目录，仅作为历史类型/事件结构的编译期依赖（若有），不在本地/预发运行；生产路径统一由 API Gateway + pkg/auth 提供鉴权

### A2.2 统一认证与身份清理
- API Gateway：保持 v2 配置启用 Firebase Bearer 校验（securityDefinitions.firebase），并确保 OAuth 回调免认证
- 后端：统一使用 pkg/auth + pkg/middleware.AuthMiddleware 注入用户上下文，Console 接口通过 AdminOnly 校验管理员权限
- 清理：
  - 移除 Nginx 对 identity/workflow 的 upstream 与路由（nginx.conf）
  - docker-compose 移除 identity/workflow 服务与依赖；frontend 不再依赖 workflow（docker-compose.yml/.override）
  - 辅助脚本 render-gateway/verify-infra 的服务列表改为 7 个核心服务（去掉 identity/workflow）

## 待办（Next）
- Browser‑Exec `json-fetch` 第二阶段
  - 代理轮换与指数退避策略完善：重试时轮换不同代理线路；失败切换国家段（配置化）
  - 预检增强：对代理做 HTTP/HTTPS 双通道探测；失败统计与熔断
  - 任务化接口：将 `json-fetch` 支持异步任务提交 + WS 推送，避免高并发时客户端阻塞
- A/B 组协同
 - Siterank 回退调用参数透传：将 `waitUntil/timeoutMs/userAgent` 作为可配策略对接

维护人：工程平台
记录位置：.kiro/specs/addictive-ads-management-system/progress-2025-09-26.md

---

## 本次补充（A1.3 与 G2.2 最小实现）

### A1.3 统一错误体（adscenter/recommendations）
- 将历史使用 `http.Error` 的路径统一使用 `{ code, message, details?, traceId }` 错误体：
  - 文件：services/adscenter/main.go（OAuth/MCC/Preflight/批量/账户等端点）
  - 文件：services/recommendations/main.go（brand-check/offline audit/coverage 等端点）

### A1.3.a 幂等（扩展到 Adscenter 批量接口）
- POST /api/v1/adscenter/bulk-actions 接入 `X-Idempotency-Key`（24h TTL）：
  - 命中则直接返回既有 `operationId` 与当前 `status`
  - 新增迁移：services/adscenter/internal/migrations/005_idempotency.sql

### G2.2 通知规则（最小规则引擎）
- 在通知订阅器按事件生成结构化消息：`severity/category/summary/data/time`，并写入 SQL 与 Firestore：
  - 文件：services/notifications/internal/events/subscriber.go（新增 composeNotification）

### A2.2 Firebase 认证集成（Gateway 放行回调 + 服务中间件接入）
- API Gateway 放行 OAuth 回调：新增 `/api/v1/adscenter/oauth/callback` 公开路由（无 security），避免 Google 回调被拦截
  - 更新：deployments/gateway/gateway.v2.yaml 与 gateway.v2.rendered.yaml、deployments/api-gateway/gateway.yaml/rendered.yaml
- 服务端接入幂等与统一认证中间件：
  - OpenAPI 链统一为：`IdempotencyMiddleware → AuthMiddleware`
  - 已落地服务：adscenter / offer / billing / batchopen / recommendations / notifications
  - 统一上下文键：所有读取用户ID位置已切换为 `middleware.UserIDKey`，删除各服务 `internal/auth` 的上下文依赖

### A2.1/A2.2 网关渲染与部署辅导
- 新增 `deployments/scripts/render-gateway.sh` 脚本，自动替换 `<PROJECT_ID>` 与各服务 Run URL 占位符，生成 `gateway.v2.rendered.yaml`；部署步骤见 `deployments/gateway/README.md`。

### A2.2 网关部署与冒烟（已完成）
- 使用服务账号 `codex-dev@gen-lang-client-0944935873` 渲染并部署 Gateway v2 到 `asia-northeast1`
- 网关 Host：autoads-gw-885pd7lz.an.gateway.dev（ACTIVE）
- 健康检查修正：`/readyz` 目标改为 siterank `/health`（原 `/healthz` 返回404）
- 冒烟：
  - GET `https://autoads-gw-885pd7lz.an.gateway.dev/readyz` → 200
  - GET `https://autoads-gw-885pd7lz.an.gateway.dev/api/v1/adscenter/oauth/callback?...` → 400（后端参数校验，路由公开可达）

### G2.1 通知服务基础能力（最小版）
- 新增表：`user_notification_state(user_id,last_read_id,updated_at)`（服务启动自动建表）
- 新增接口（暂未入 OAS，服务内直挂）：
  - `POST /api/v1/notifications/read`（body: {lastId}）标记已读位置
  - `GET /api/v1/notifications/unread-count` 返回未读数（id > last_read_id）
- 既有接口：`GET /api/v1/notifications/recent`（支持 limit/cursor）
- 文件：`services/notifications/cmd/server/main.go`

### G2.2 通知规则（最小规则、对齐 OAS）
- OpenAPI 增补：`/api/v1/notifications/rules`（GET 列表、POST upsert）
- 代码生成：已通过 `scripts/openapi/gen-go-stubs.sh notifications` 生成新接口
- 服务实现：在 `oasImpl` 中实现 list/upsert，使用 `notification_rules` 表（user_id,event_type,channel 唯一，enabled 标志）

### F1.1 原子扣费机制（最小实现）
- commit 端点原子扣减余额（事务 + FOR UPDATE）；不足返回 `409 INS UFFICIENT_TOKENS`
- reserve/release 不改变余额，仅记录 TokenTransaction（balanceBefore/After 等于当前余额）
- 写入 TokenTransaction 的 balanceBefore/After 字段，便于审计
- 文件：`services/billing/main.go`（commit/reserve/release 调整）

### A1.3 幂等扩展（MCC 链接/解绑）
- MCC Link/Unlink 接口接入 `X-Idempotency-Key`（scope: `adscenter.mcc.link|unlink`），命中直接返回 202 queued。

### E2.1 批量操作流程（最小骨架）
- 读写模型与审计：
  - 新增表 `BulkActionOperation` 与 `BulkActionAudit(before/after/rollback)`（迁移：`services/adscenter/internal/migrations/006_bulk_audit.sql`）。
  - `POST /api/v1/adscenter/bulk-actions` 入队时写入 `before` 快照；模拟完成后写入 `after` 快照。
  - 新增非 OAS 端点：
    - `GET /api/v1/adscenter/bulk-actions/{id}/audits`（查看审计快照）
    - `POST /api/v1/adscenter/bulk-actions/{id}/rollback`（标记 rolled_back 并写入 rollback 快照，stub）
- OpenAPI 扩展与前端类型：
  - OAS 增补 `/bulk-actions/{id}/audits`、`/bulk-actions/{id}/rollback`、`/bulk-actions/{id}/plan`、`/bulk-actions/validate`；
  - 生成 Go stubs 与前端 TS 类型（adscenter）。
  - 新增 `GET /api/v1/adscenter/bulk-actions`（按用户列出最近操作，支持 limit）。
  - Batchopen 增补 `GET /batchopen/templates`（国家曲线/UA/Referer/时区模板，最小内置），生成 Go/TS 类型并实现服务器端返回。

### E2.1 回滚策略（骨架）
- 新增 `POST /api/v1/adscenter/bulk-actions/{id}/rollback-plan`：生成逆向计划（仅返回，不执行）。
  - 规则（简化）：ADJUST_CPC 反向 percent；ADJUST_BUDGET 按 50% 下调；ROTATE_LINK 标记需人工。
- 已有 `POST /bulk-actions/{id}/rollback`（标记 rolled_back + 写审计快照）。

### OAuth 撤销（最小深化）
- 新增 `POST /api/v1/adscenter/oauth/revoke`：
  - 当 `OAUTH_REVOKE_LIVE=true` 时，调用 Google revoke 接口；随后清空本地 refresh token；
  - 写入审计事件 `oauth_revoke(live)`；
  - OAS/Go/TS 已同步。

### 审计能力
- 新增表 `AuditEvent(user_id, kind, data, created_at)`（迁移 `008_audit_events.sql`）。
- 新增 `GET /api/v1/adscenter/audits?kind=&limit=` 用于查询最近审计记录。

### E2.2 MCC 链接管理（最小状态机）
- 新表：`MccLink(user_id, customer_id, status [invited|pending|active|inactive])`（迁移：`services/adscenter/internal/migrations/007_mcc_link.sql`）。
- Link/Status/Unlink：
  - link：写入/更新 `pending`；
  - status：LIVE 模式下持久化标准化状态（active|pending）；stub 则返回 DB 状态或 pending；
  - unlink：写入/更新 `inactive`。
- OAS + 实现：
  - 新增 `GET /api/v1/adscenter/mcc/links`（按用户列出链接，支持 status 过滤）。
  - 新增 `GET /api/v1/adscenter/connections`（列出已存储的 Ads 连接信息，去敏）。
 - 新增刷新端点：`POST /api/v1/adscenter/mcc/refresh`（遍历当前用户 pending/ invited 的条目，若配置 LIVE 则批量刷新状态）
  - OAS 已补充，生成 Go stubs 并接入 oasImpl（adscenter）
- 定时刷新：新增 `deployments/scripts/create-mcc-refresh-scheduler.sh`，使用 Scheduler OIDC 定时调用 `/api/v1/adscenter/mcc/refresh`
  - 依赖启用脚本：`deployments/scripts/enable-apis.sh`（启用 cloudscheduler/run 等 API，并授予 invoker）
  - 支持分片：`TOTAL_SHARDS>0` 时创建多 Job（adscenter-mcc-refresh-sN），请求体传递 `{ shard, totalShards }`
- 幂等：commit/release 接入 `X-Idempotency-Key`（24h TTL）避免重复扣减/释放

### D1.3 评估结果投影（最小实现）
- Siterank 完成事件载荷补充：`offerId`、`userId`（两条主路径均包含）
- Notifications 订阅器在收到 `SiterankCompleted` 时，投影至读模型：
  - 更新 `Offer.status = 'evaluated'`（优先更新驼峰列，失败回退小写列）
- 影响文件：
  - `services/siterank/main.go`（发布事件 enrich）
  - `services/notifications/internal/events/subscriber.go`（投影 Offer 状态）

### G3.1 Console/前端计费接入（最小）
- 新增前端 BFF 路由：
  - GET `/api/billing/tokens/balance`（转发 billing 服务 `/api/v1/billing/tokens/me`）
  - GET `/api/billing/tokens/transactions`（转发 billing 服务 `/api/v1/billing/tokens/transactions`）
  - GET `/api/tokens/transactions`（聚合成 `{ records, pagination }`，兼容现有 Hook）
- 前端 hooks 调整：
  - `useTokenBalance` 走新 BFF `/api/billing/tokens/balance`
  - `useTokenTransactions` 走新 BFF `/api/tokens/transactions`

### H1.0 阶段性SLO指标拆分（siterank）
- 新增 Prometheus 直方图指标（services/siterank）：
  - `siterank_resolve_nav_ms`：解析落地导航耗时
  - `siterank_resolve_stabilize_ms`：URL 稳定窗口耗时
  - `siterank_sw_fetch_ms`：SimilarWeb 拉取耗时
  - `siterank_ai_score_ms`：AI 评分 HTTP 耗时
- siterank 在“解析落地 + AI 评分”路径中写入上述指标；browser-exec 已返回 `timings.navMs/stabilizeMs` 并被解析记录
- 指标用途：分解 P95 目标，验证“评估≤10s”仅覆盖“数据获取与评分”阶段（不含解析落地），支撑后续容量与优化调参

### E1.1 仿真模板与质量评分（batchopen）
- 新增最小模板端点：GET /api/v1/batchopen/templates，返回内置国家、UA、Referer、时区集合（可扩展）
- 任务执行增强：
  - 引入 check-availability 调用的分级重试策略：429/5xx/网络错误按退避重试（默认 2 次，可配 BATCHOPEN_RETRIES/BATCHOPEN_BACKOFF_MS），4xx 不重试
  - 增加质量评分：基于 HTTP 状态与引擎(fetch/playwright)计算 0..100 分，写入 Firestore tasks 文档 quality.score/factors；同时随 Completed/Failed 事件发布
- 影响文件：services/batchopen/main.go

### B1.2 标准事件订阅扩展（notifications）
- 扩展事件监听：BrowserExecRequested/BrowserExecCompleted 入库通知 + Firestore UI 缓存
- 通知文案：
  - BrowserExecRequested：info 类别，记录 url、taskId
  - BrowserExecCompleted：success/error 类别，附带质量分 quality（若有）
- 影响文件：services/notifications/internal/events/subscriber.go

### B1.2 标准事件集补齐（部分）
- UserRegistered（懒注册）
  - siterank 在首次收到用户请求时确保读模型表 "User" 存在，并插入用户（id/email）后发布 UserRegistered 事件（一次性）
  - 影响文件：services/siterank/main.go（ensureUserDDL/ensureUserRegistered）
- Workflow* 事件（替代 workflow 服务）
  - batchopen 在 start/complete/fail 时发布 WorkflowStarted/WorkflowCompleted/WorkflowStepCompleted（fail）
  - notifications 订阅 Workflow* 并入库通知（category=workflow）
- NotificationSent 事件
  - notifications 在入库通知并写 UI 缓存后发布 NotificationSent 事件，供后续多通道分发或审计使用
  - 影响文件：services/notifications/internal/events/subscriber.go、services/notifications/cmd/server/main.go

### E2.1 批量操作流程（完成）
- 变更计划提交：`POST /api/v1/adscenter/bulk-actions`（持久化 `BulkActionOperation`，写 before 快照，返回 operationId）
- validate-only：`POST /api/v1/adscenter/bulk-actions/validate`（规则校验、配额/速率阈值检查、warnings/violations 输出）
- 入队执行：创建后异步更新 `running`→`completed`，写 after 快照（stub）
- 回滚支持：
  - 生成逆向计划：`POST /api/v1/adscenter/bulk-actions/{id}/rollback-plan`（返回 inverse plan，validateOnly 模式）
  - 执行回滚：`POST /api/v1/adscenter/bulk-actions/{id}/rollback-execute`（写 rollback_exec 审计）
  - 标记回滚：`POST /api/v1/adscenter/bulk-actions/{id}/rollback`（标记 rolled_back + 写 rollback 审计）
- 审计与查询：
  - `GET /api/v1/adscenter/bulk-actions/{id}` 返回状态与计划摘要
  - `GET /api/v1/adscenter/bulk-actions/{id}/audits` / `{id}/report` 返回快照
- 影响文件：services/adscenter/main.go（handlers 与 SQL），services/adscenter/internal/oapi/server.gen.go（路由）

### E2.3 精细化诊断与操作指导（完成，最小实现）
- 新增诊断端点（额外扩展，未入 OAS）：`POST /api/v1/adscenter/diagnose`
  - 入参：accountId、landingUrl（可选）、metrics（impressions/ctr/conversions/qualityScore/budgetPacing/dailyBudget）
  - 规则库（首批）：NO_IMPRESSIONS、LOW_CTR、LOW_QUALITY_SCORE、BUDGET_MISSING/BUDGET_EXHAUSTED、TRACKING_MISSING
  - 输出：`{ summary, rules[{code,severity,message,details}], suggestedActions[] }`
- 影响文件：services/adscenter/main.go（diagnoseHandler 与路由挂载）

### 诊断 → 一键执行（闭环增强）
- 新增：`POST /api/v1/adscenter/diagnose/plan`（返回 BulkActionPlan，仅含允许类型 ADJUST_BUDGET / ADJUST_CPC，便于直接校验）
- 新增：`POST /api/v1/adscenter/diagnose/execute`（将诊断自动生成的计划入队为 BulkActionOperation，并写 before/after 审计）
- 影响文件：services/adscenter/main.go（diagnosePlanHandler、diagnoseExecuteHandler、buildPlanFromMetrics）

### 诊断自动填充（Stub，待接入LIVE）
- 新增：`GET /api/v1/adscenter/diagnose/metrics?accountId=`（ADS_DIAG_LIVE=false 时返回确定性伪随机指标）
- 前端在“诊断与一键执行”面板增加“自动填充”按钮，默认取第一个账户
- 影响文件：
  - services/adscenter/main.go（diagnoseMetricsHandler）
  - apps/frontend/src/app/adscenter/AdsCenterClient.tsx（autoFill 集成）
### B2.1 投影器与 Saga 协调器（完成，最小实现）
- 在 notifications 订阅器内置 Saga 协调器（开关 ENABLE_SAGA=1）：
  - 监听 BatchOpsTask* 事件，持久化 `SagaInstance/SagaStep`（running/completed/compensated）
  - 对接 billing reserve/commit/release（2s 超时，X-Idempotency-Key=saga:<action>:<taskId>，X-User-Id 透传）
  - 幂等与容错：失败记录 step.last_error；实例状态更新；不影响通知入库
- 影响文件：services/notifications/internal/events/subscriber.go

### 通知 UI/BFF 最小接入
- 新增前端 BFF 路由：
  - GET `/api/notifications/recent` → `/api/v1/notifications/recent`
  - GET `/api/notifications/unread-count` → `/api/v1/notifications/unread-count`
  - POST `/api/notifications/read` → `/api/v1/notifications/read`
- 新增前端页面：`/notifications`（最近通知、未读数、全部标记已读、分页加载）
- 影响文件：
  - apps/frontend/src/app/api/notifications/*
  - apps/frontend/src/app/notifications/page.tsx
  - apps/frontend/src/components/navigation/MainNavigation.tsx（导航栏未读红点与轮询刷新）

### H1.2 SLO 监控与告警（初版脚本）
- 新增 Cloud Monitoring 策略创建脚本：
  - `deployments/monitoring/create-alert-latency.sh`：基于 Cloud Run `request_latencies` 的 P95 阈值告警（默认 5 分钟窗口）。
  - `deployments/monitoring/create-alert-error-rate.sh`：基于 MQL 计算 5xx 错误率阈值告警（默认阈值 1%）。
- 文档：`deployments/monitoring/README.md` 增补用法示例与 GMP 提示。
- 说明：阶段性指标（resolve_nav_ms 等）为 Prometheus 指标，若需在 Cloud Monitoring 中告警，需启用 GMP 抓取。

### D1.7.b 前端/通知联动（完成）
- 当 SimilarWeb 拉取失败或 AI 降级时：
  - siterank 写入 Firestore 通知（warning）并发布 NotificationCreated 事件
  - notifications 订阅 NotificationCreated 并入库 user_notifications，前端可读 UI 缓存与通知列表
- 影响文件：
  - services/siterank/main.go（maybePublishDegradedNotification 新增）
  - services/notifications/internal/events/subscriber.go（新增 NotificationCreated 分支与文案透传）
