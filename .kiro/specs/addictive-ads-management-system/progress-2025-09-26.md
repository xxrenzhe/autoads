# 重构落地进展（2025-09-26）

本次进展聚焦 C组（Browser‑Exec 服务）对 `json-fetch` 稳定性与可配置性增强，支撑 Siterank 回退抓取路径成功率提升与 P95 目标达成。

## 已完成
- Browser‑Exec `resolve-offer` 新增
  - 端点：`POST /api/v1/browser/resolve-offer`，用于经真实浏览器解析多重重定向，返回 `finalUrl/finalUrlSuffix/domain/brand/chain` 与计时
  - 支持 `waitUntil=networkidle|load|domcontentloaded`、`timeoutMs`（默认45s，上限60s）、`stabilizeMs` URL稳定窗口
  - 继承代理预检、UA/Headers 注入、容量护栏与指标
- Browser‑Exec `json-fetch` 增强（第一阶段）
  - 新增参数：`userAgent`、`headers`、`waitUntil`（domcontentloaded|load|networkidle）、`timeoutMs`（1s..30s）
  - 代理预检：从代理提供者获取 3–5 条候选，优先对 `https://www.gstatic.com/generate_204` 做 3s 快速连通性探测，优先选择可用代理；失败则回退随机代理
  - UA 兜底：若未显式传入 `userAgent`，尝试使用环境变量 `SIMILARWEB_USER_AGENT`
  - 额外请求头：支持 `headers` 注入（通过 `page.setExtraHTTPHeaders`），便于伪装/绕过基础防护
  - 超时与等待策略：`timeoutMs` 上限提升至 30s；`waitUntil` 可配置为 `load`/`networkidle` 等，覆盖更复杂的页面加载场景
  - 指标：容量耗尽仍计入 `be_capacity_exhausted_total`，与既有并发护栏保持一致

- 支持脚本
  - 新增 `scripts/ops/smoke-browser-json.sh`：对 `json-fetch` 做端到端冒烟，覆盖 UA/Headers/超时/等待策略
  - 新增 `scripts/ops/smoke-resolve-offer.sh`：对 `resolve-offer` 端点做冒烟，验证 Final URL/suffix/brand/chain
  
- Siterank（可选新路径，受开关 ANALYZE_WITH_RESOLVE=1 控制）
  - 新增“解析落地 + AI 评分”分析路径：resolve-offer → SimilarWeb(metrics) → page-signals → AI评分（失败回退规则评分）
  - 返回结构包含：resolve 结果、SimilarWeb 摘要、pageSignals、score、usedAI、degraded、country
  - AI端点通过 `AI_SCORING_URL` 配置（HTTP JSON），超时 8s；失败回退 KISS 评分

### Console 管理后台（G3.1 最小补全）
- 后端新增：PUT `/api/v1/console/users/{id}/subscription`（仅 ADMIN）
  - 请求体：{ planName: free|pro|max, status?: active|paused }
  - 行为：当 status=active 时，自动将 `currentPeriodEnd` 顺延 30 天；若无订阅行则创建
- 前端管理页增强（`/console/`）
  - 用户列表中“订阅”操作支持直接修改套餐与状态：点击后展示当前订阅，输入 `free|pro|max` 与 `active|paused` 完成更新
  - 已有的 Token 充值/统计、通知规则、系统健康检查等模块保持可用

验收建议：使用管理员用户 Token 访问 `/console/`，在“用户列表”点击“订阅”并修改套餐，随后通过 Billing 配置与订阅接口核对变更是否生效。

### Console 仪表盘统计（G3.1）
- 后端新增：GET `/api/v1/console/stats`（仅 ADMIN），聚合 counters：
  - users、offers、subscriptionsActive、tokensTotal、notifications24h、siterankAnalyses、batchopenTasks、events
- 前端新增“仪表盘统计”卡片，点击“刷新”展示聚合数据

### 前端：后台管理（Ant Design）最小接入
- 在现有 Next.js 前端中新增 Ant Design 管理页（路径：`/admin/console/overview`）
  - 组件：Antd Layout/Card/Statistic，拉取 Console 统计 `/api/v1/console/stats`
  - 文件：
    - `apps/frontend/src/app/admin/console/overview/layout.tsx`（引入 `antd/dist/reset.css` + `ConfigProvider`）
    - `apps/frontend/src/app/admin/console/overview/page.tsx`
  - 依赖：`antd`、`@ant-design/icons`（已写入 apps/frontend/package.json，后续执行安装）

- 新增订阅管理页（路径：`/admin/console/subscriptions`）
  - 列表检索用户（/api/v1/console/users），弹窗查看/编辑订阅（PUT `/api/v1/console/users/{id}/subscription`），支持 Token 充值（POST `/api/v1/console/users/{id}/tokens`）
  - 文件：`apps/frontend/src/app/admin/console/subscriptions/page.tsx`

- 新增健康检查页（路径：`/admin/console/health`）
  - 聚合网关/服务健康：`/api/go/readyz`、`/api/go/api/health/adscenter`、`/api/go/api/health/console`
  - 文件：`apps/frontend/src/app/admin/console/health/page.tsx`

- 公共布局：`apps/frontend/src/app/admin/console/layout.tsx`（Antd `ConfigProvider`）

- 新增通知规则管理页（路径：`/admin/console/notifications`）
  - 规则：读取/保存 `/api/v1/notifications/rules`；最近通知：`/api/v1/notifications/recent`；标记已读：`/api/v1/notifications/read`
  - 文件：`apps/frontend/src/app/admin/console/notifications/page.tsx`

### 用户前端：Offer 看板（MVP）
- 新增路由：`/offers/kanban`
  - 列出 `/api/go/api/v1/offers`，按状态分组展示（机会池/评估中/仿真中/放大中/衰退期/归档）
  - 支持创建 Offer（POST `/api/go/api/v1/offers`，带 `X-Idempotency-Key`）
  - 支持状态流转（PUT `/api/go/api/v1/offers/{id}/status`）；支持拖拽（HTML5 DnD）跨列更新
- 支持“一键评估”（Siterank）：调用 `POST /api/go/api/v1/siterank/analyze`，提示 10 秒内返回或降级
  - 支持“一键仿真”（Batchopen 最小模板）：调用 `POST /api/go/api/v1/batchopen/tasks`（可选国家参数，默认 US）
  - 支持“任务抽屉”：读取 `GET /api/go/api/v1/batchopen/tasks` 并按 offerId 过滤展示最近任务
    - 增强：任务抽屉支持 4 秒轮询刷新与分页（5/10/20/50 条/页）
  - 支持“评分趋势”弹窗：读取 `GET /api/go/api/v1/siterank/{offerId}/trend?days=30` 并用 Recharts 展示折线图
  - 支持“卡片内迷你趋势（7 天）”：在“刷新评分”时顺便预取 `/trend?days=7` 并绘制小型折线图
  - 支持“评估进度与降级提醒”：分析中显示进度条（实时事件驱动 + 本地节拍结合）与降级提醒（result.degraded=true 时提示可重试）
  - 支持“SSE联动自动刷新”：订阅 `/api/go/api/v1/notifications/stream`，收到 `SiterankCompleted` 事件时刷新进行中卡片的评分与迷你趋势
  - 支持“业务KPI”：调用 `/api/go/api/v1/offers/{id}/kpi`，渲染 ROSC（≥1.3绿、1.0–1.29琥珀、<1红）与 7 天迷你折线（impressions/clicks、spend/revenue）
  - 任务抽屉显示质量评分与失败信息（解析 `result{quality, status, error}`）
  - 卡片评分颜色编码：分数≥70绿色、40-69琥珀、<40红色；卡片左侧边框与分数着色一致

### 管理端仪表盘（SLO）
- 新增 GET `/api/v1/console/slo` 聚合各服务 `/metrics`，计算 P95 与错误率；siterank 提供 resolve/sw/ai 阶段 P95 备注
- 在 `/admin/console/overview` 展示 SLO 表格（P95、请求数、错误率、阶段耗时），并支持：本地阈值配置（P95、错误率）与颜色标记、“健康检查”按钮（adscenter/console）

### 管理端：告警与历史故障（最小）
- 新增后端：
  - GET `/api/v1/console/alerts`（level=warn|error、sinceHours、limit），读取 `user_notifications` 并解析 message 提取 `severity/category/summary`
  - GET `/api/v1/console/incidents`（days），按日聚合 warn/error 事件计数
- 前端页面：
  - `/admin/console/alerts`：筛选/刷新/导出 CSV
  - `/admin/console/incidents`：Warn/Error 趋势折线 + 明细表

### KPI 数据接入（最小整合）
- Offer KPI 接口 `/api/v1/offers/{id}/kpi` 优先调用 Adscenter `GET /api/v1/adscenter/diagnose/metrics`（通过 `ADSCENTER_URL`，账号默认=当前用户）以获取基础指标（impressions/ctr/qualityScore/dailyBudget/budgetPacing），并生成近 7 天 KPI 序列与 ROSC；失败时回退伪数据生成
  - 文件：`apps/frontend/src/app/offers/kanban/page.tsx`

### Offer 服务：状态更新端点（最小实现）
- 新增：`PUT /api/v1/offers/{id}/status`，校验用户归属与状态集合（opportunity/evaluating/simulating/scaling/declining/archived/optimizing）
- 写入变更历史（若不存在自动建表 `OfferStatusHistory`）
- 文件：`services/offer/internal/handlers/http.go`

### Offer 读模型：投影 Siterank 分数
- Notifications 监听 `SiterankCompleted` 时将 `score` 投影到 `Offer.siterankScore`（若列不存在自动新增）
- Offer 列表/详情接口返回 `siterankScore`（最小读模型映射）
- 文件：
  - `services/notifications/internal/events/subscriber.go`（SiterankCompleted 分支：更新 status 与 siterankScore）
  - `services/offer/internal/handlers/http.go`（ALTER TABLE + SELECT/Scan 增加 siterankScore）

## 验证建议
- 本地/预发冒烟
  - 启动 Cloud Run 预发实例或本地服务（需 `PLAYWRIGHT=1` 且已安装 chromium）
  - 冒烟示例：
    - `BROWSER_URL=https://<run-url> ./scripts/ops/smoke-browser-json.sh https://api.similarweb.com/some/json` 
    - 可附加：`WAIT_UNTIL=networkidle TIMEOUT_MS=25000 UA="Custom-UA"`
- Siterank 回退路径联调
  - 在 siterank 配置 `BROWSER_EXEC_URL`、`SIMILARWEB_USER_AGENT`；触发 analyze，观察 `via=proxy` 成功率与 P95

## 新要求对齐
- 取消“10秒SLO”：已在 `resolve-offer` 默认使用 45–60s 导航超时与 URL 稳定窗口；siterank 引入新分析路径允许解析 >10s
- 价值分引入 AI：siterank 新增 `ANALYZE_WITH_RESOLVE=1` 模式，流程为 resolve → SimilarWeb(metrics) → page-signals → AI评分（失败回退规则评分）；AI端点由 `AI_SCORING_URL` 配置

## 本次预发部署与冒烟记录
- Cloud Run
  - browser-exec-preview: https://browser-exec-preview-644672509127.asia-northeast1.run.app
  - 镜像：asia-northeast1-docker.pkg.dev/.../browser-exec:preview-20250926120249
- 冒烟结果（resolve-offer，对应你的测试Case）
  - 请求：POST /api/v1/browser/resolve-offer { url:"https://pboost.me/ZDO2Bdek", waitUntil:"domcontentloaded", timeoutMs:60000, stabilizeMs:1500 }
  - 响应要点：
    - finalUrl: https://www.yitahome.com/
    - finalUrlSuffix: pbtid=pb_...&utm_source=PartnerBoost&utm_medium=affiliate&utm_campaign=448227&utm_content=0
    - domain: www.yitahome.com（已在 siterank 去前缀规范化为 yitahome.com）
    - brand: yitahome
    - navMs≈4.8s, stabilizeMs≈1.6s
- SimilarWeb 抓取
  - 直连/代理回退部分目标域可能 20–30s 超时；已按设计启用降级与通知，后续调整 UA/代理轮换策略与等待策略

- Siterank 端到端（预发，新增 analyze-url 冒烟端点）
  - 端点：POST /api/v1/siterank/analyze-url（仅预发调试用；传入 url/offerId，可走“解析落地+AI评分”路径）
  - 用例：{"url":"https://pboost.me/ZDO2Bdek","offerId":"offer-pboost-yita"}
  - 结果（节选）：status=completed, usedAI=false（回退规则评分）, degraded=true, score≈39,
    resolve.finalUrl=https://www.yitahome.com/（解析成功），similarweb=null（超时降级），pageSignals.status=200

### A2.2 统一认证与身份清理（本地与脚手架补全）
- 本地工作区与开发脚本去除 identity/workflow，保持“最终形态直达”一致：
  - go.work 去除 `./services/identity` 与 `./services/workflow`
  - package.json `dev:services` 去除 identity/workflow，补充 `notifications` 与 `console`
- 验证脚本扩展：`scripts/ops/verify-infra.sh` 增加 `notifications`、`recommendations` 到已知服务清单
- 注：保留 `services/identity` 代码目录，仅作为历史类型/事件结构的编译期依赖（若有），不在本地/预发运行；生产路径统一由 API Gateway + pkg/auth 提供鉴权

### F1.2 计费配置与明细（最小实现）
- 新增 Billing 非OAS端点：
  - GET `/api/v1/billing/config`：集中下发价格/限额。优先 Secret Manager（`BILLING_PRICING_SECRET` 指向 `billing-pricing`），回退 `BILLING_PRICING_JSON`，最终兜底默认值。示例：`{"siterank.analyze":1,"batchopen.task":1,"adscenter.preflight":1}`
  - GET `/api/v1/billing/tokens/transactions/{id}`：按用户读取单条交易明细（含 metadata）
- 交易链路追溯：reserve/commit/release 写入 `TokenTransaction.metadata`（`{"taskId":"...","action":"reserve|commit|release"}`）
- 构建校验：`cd services/billing && go build -o /tmp/billing-srv .` 通过；（说明）`cmd/server` 为旧入口，未纳入本次变更范围

### G1.1/G1.2 原子扣费与计费明细（补强）
- 原子事件已在 billing 实现并发布（TokenReserved/Debited/Reverted）；本次补强 metadata 字段与查询细化接口，便于 Console 与审计使用

### D1.4 关键词扩展（最小实现补充说明）
- Adscenter 已实现 `POST /api/v1/adscenter/keywords/expand`，支持 `ADS_KEYWORD_LIVE=true` 走 Google Ads `generateKeywordIdeas`（失败回退 Stub）
- 过滤规则：保留搜索量>1000 且 competition != HIGH 的建议；最多返回 20 条；已纳入 OAS 并生成类型

### E1.2 批量执行优化与Browser-Exec集成（增强）
- Batchopen 后台执行：
  - 调用 Browser-Exec `/api/v1/browser/check-availability` 前引入“主机级短缓存”（默认 120s，失败 30s）、并发护栏（`BATCHOPEN_MAX_INFLIGHT`，默认 8）与单航班合并（singleflight）
  - 计费幂等等：调用 billing reserve/commit/release 时设置 `X-Idempotency-Key=\"batchopen:{action}:{userId}:{taskId}\"`，避免重试造成重复扣费
  - 质量评分：保留，按 HTTP 状态/引擎计算并写入 UI 缓存
  - 可观测性：增加 Prometheus 指标 `batchopen_inflight_current`、`batchopen_host_cache_hits_total`、`batchopen_host_cache_miss_total`
- 配置选项：`BATCHOPEN_DOMAIN_CACHE_MS`（默认 120000）、`BATCHOPEN_MAX_INFLIGHT`（默认 8）、`BATCHOPEN_RETRIES/BATCHOPEN_BACKOFF_MS`
- 影响文件：services/batchopen/main.go

### H2.1 环境隔离（脚本补充）
- 新增 `deployments/scripts/name-services-by-stack.sh`：按 `{service}-{stack}` 规范输出目标命名并对现有服务打标签 `autoads-stack={STACK}`（非破坏式）；结合现有 `label-services.sh`/`secret-env-sync.sh` 形成最小隔离工具集

### E1.1 结构化诊断（OAS类型化补全）
- 更新 OAS：为 `/api/v1/adscenter/preflight` 增加 `PreflightResult`/`PreflightCheck` 结构，统一前后端契约（summary + checks[code/severity/message/details]）
 - 服务器实现对齐：adscenter 返回 OAS 结构（同时为 UI 缓存保留 legacy 结构）
 - TS 类型：运行 `./scripts/openapi/gen-ts-sdk.sh` 生成并同步到前端 `apps/frontend/src/sdk/adscenter/types.d.ts`

### A2. 网关渲染与部署（预发）
- 自动渲染：`deployments/scripts/render-gateway-auto.sh` 基于 Cloud Run 服务发现生成 `gateway.v2.rendered.yaml`
- 部署：`scripts/gateway/deploy-gateway.sh`（配置：API=autoads-api, GATEWAY=autoads-gw, REGION=asia-northeast1）
- 结果：defaultHostname=`autoads-gw-885pd7lz.an.gateway.dev`，状态 ACTIVE；冒烟 `deployments/scripts/gateway-smoke.sh` 通过（/api/health 200，受保护路由 401）

### G3.1 Console 管理（最小）
- 新增管理端 API（admin-only，经 pkg/middleware.AdminOnly 校验）：
  - GET `/api/v1/console/tokens/stats`：统计用户数与 Token 总额（聚合）
  - POST `/api/v1/console/users/{id}/tokens`：为指定用户充值 Token（amount>0）
- 影响文件：services/console/internal/handlers/http.go

### A2.2 统一认证与身份清理
- API Gateway：保持 v2 配置启用 Firebase Bearer 校验（securityDefinitions.firebase），并确保 OAuth 回调免认证
- 后端：统一使用 pkg/auth + pkg/middleware.AuthMiddleware 注入用户上下文，Console 接口通过 AdminOnly 校验管理员权限
- 清理：
  - 移除 Nginx 对 identity/workflow 的 upstream 与路由（nginx.conf）
  - docker-compose 移除 identity/workflow 服务与依赖；frontend 不再依赖 workflow（docker-compose.yml/.override）
  - 辅助脚本 render-gateway/verify-infra 的服务列表改为 7 个核心服务（去掉 identity/workflow）

## 待办（Next）
- Browser‑Exec `json-fetch` 第二阶段
  - 代理轮换与指数退避策略完善：重试时轮换不同代理线路；失败切换国家段（配置化）
  - 预检增强：对代理做 HTTP/HTTPS 双通道探测；失败统计与熔断
  - 任务化接口：将 `json-fetch` 支持异步任务提交 + WS 推送，避免高并发时客户端阻塞
- A/B 组协同
 - Siterank 回退调用参数透传：将 `waitUntil/timeoutMs/userAgent` 作为可配策略对接

维护人：工程平台
记录位置：.kiro/specs/addictive-ads-management-system/progress-2025-09-26.md

---

## 本次补充（A1.3 与 G2.2 最小实现）

### A1.3 统一错误体（adscenter/recommendations）
- 将历史使用 `http.Error` 的路径统一使用 `{ code, message, details?, traceId }` 错误体：
  - 文件：services/adscenter/main.go（OAuth/MCC/Preflight/批量/账户等端点）
  - 文件：services/recommendations/main.go（brand-check/offline audit/coverage 等端点）

### A1.3.a 幂等（扩展到 Adscenter 批量接口）
- POST /api/v1/adscenter/bulk-actions 接入 `X-Idempotency-Key`（24h TTL）：
  - 命中则直接返回既有 `operationId` 与当前 `status`
  - 新增迁移：services/adscenter/internal/migrations/005_idempotency.sql

### G2.2 通知规则（最小规则引擎）
- 在通知订阅器按事件生成结构化消息：`severity/category/summary/data/time`，并写入 SQL 与 Firestore：
  - 文件：services/notifications/internal/events/subscriber.go（新增 composeNotification）

### A2.2 Firebase 认证集成（Gateway 放行回调 + 服务中间件接入）
- API Gateway 放行 OAuth 回调：新增 `/api/v1/adscenter/oauth/callback` 公开路由（无 security），避免 Google 回调被拦截
  - 更新：deployments/gateway/gateway.v2.yaml 与 gateway.v2.rendered.yaml、deployments/api-gateway/gateway.yaml/rendered.yaml
- 服务端接入幂等与统一认证中间件：
  - OpenAPI 链统一为：`IdempotencyMiddleware → AuthMiddleware`
  - 已落地服务：adscenter / offer / billing / batchopen / recommendations / notifications
  - 统一上下文键：所有读取用户ID位置已切换为 `middleware.UserIDKey`，删除各服务 `internal/auth` 的上下文依赖

### A2.1/A2.2 网关渲染与部署辅导
- 新增 `deployments/scripts/render-gateway.sh` 脚本，自动替换 `<PROJECT_ID>` 与各服务 Run URL 占位符，生成 `gateway.v2.rendered.yaml`；部署步骤见 `deployments/gateway/README.md`。

### A2.2 网关部署与冒烟（已完成）

---

## 本次追加完成（H2.2 与 1.4/1.5 局部落地）

- H2.2 性能与成本优化（局部）
  - Adscenter OAuth 配置内存缓存：新增进程内 TTL 缓存（默认10分钟，可配 ADS_CREDS_CACHE_TTL_MS），减少 Secret Manager 访问与冷启动时延。影响文件：services/adscenter/internal/config/ads.go
  - Siterank Secret 读取缓存：对 Secret Manager 结果做本地缓存（默认10分钟，可配 SECRET_CACHE_TTL_MS），与已落地的域名/国家缓存形成互补。影响文件：services/siterank/internal/pkg/secrets/secrets.go
  - 健康探针补全：Adscenter 增加 /healthz、/readyz，readyz 校验 DB 可达（800ms 预算）。影响文件：services/adscenter/main.go

- 1.4 统一HTTP客户端（最小实现）
  - 新增 pkg/http：在现有 pkg/httpclient 之上提供统一出站调用封装（DoJSON/DoRaw、统一错误解码、X-Idempotency-Key 透传、简易断路器启用）。暂未强制改造存量服务，后续可按需切换接入。

- 1.5 可观测性（延伸）
  - 与既有 pkg/telemetry/中间件配合，新加的 /readyz 已纳入服务健康基线；后续再按需接入分布式追踪（OTel）。

### 1.5 可观测性（继续补全）
- pkg/telemetry 增加可选 Trace（OTel）支持：
  - 新增基于 `TRACE_ENABLED=1` 的开关，启用后自动用 `otelhttp` 为 HTTP 请求生成 Span（未显式配置导出器时为 No-Op，不影响性能）。
  - 服务侧无需大改：现已在 `console` 顶层接入（包裹 ServeMux）；`adscenter` 等使用 `ChiMiddleware` 的服务也兼容。
  - 新增 `SetupTracing(service)`：当 `TRACES_ENABLED=1` 时初始化 OTLP/HTTP 导出器，采样率 `TRACES_SAMPLER_RATIO`（默认 0.01）；服务在启动处调用并 `defer shutdown()`。

### 网关健康聚合（A2）
- Console 新增聚合端点 `GET /api/health`：并发探测各服务 `/readyz`（失败回退 `/health`），输出 overall 与各服务状态。
- Gateway 增加路由 `/api/health`（代理 Console 聚合端点），用于 Uptime/外部健康探测统一入口。
- 部署与冒烟：新增脚本 `deployments/scripts/gateway-smoke.sh`，打印 `/readyz` 与 `/api/health*` 状态码；注意网关配置传播需要数分钟。
- 已将 `/readyz`、`/api/health` 分别指向 Console `/health` 与 `/api/health`（聚合）；当前均 200。

### 1.4 统一HTTP客户端（接入 Siterank）
- 将 Siterank 服务的外部调用切换至 `pkg/http`：
  - SimilarWeb 直连 GET 使用 `DoJSON(method=GET, headers, retries)`；
  - browser-exec `/json-fetch` 的回退路径在 `tryBrowserJSON` 中改为 `DoJSON(method=POST)`；
  - Offer API 回退读取使用 `DoRaw`，透传 `X-Idempotency-Key`（由中间件注入）。
  - 文件：`services/siterank/main.go`

### 1.4 统一HTTP客户端（接入 Adscenter 部分路径）
- 将 Adscenter 出站调用的关键路径接入 `pkg/http`：
  - 预检落地可达性（browser-exec `/check-availability`）使用 `DoJSON`；
  - 执行器（executor）调用 browser-exec `/resolve-offer` 改为 `DoJSON`（stub 与 live 两个构建标签均覆盖）；
  - 文件：`services/adscenter/main.go`, `services/adscenter/internal/executor/executor.go`, `services/adscenter/internal/executor/executor_live.go`, `services/adscenter/go.mod`

### 3.1 事件存储（最小实现）
- 在 Notifications 订阅器落地事件入库：监听到的每条 Pub/Sub 消息（Envelope 或 Payload）写入 `event_store` 表（id/type/payload/metadata），尝试从 payload 提取 `aggregate_type/id`（offerId/taskId/analysisId）。
- 启动时确保 DDL 存在（幂等），后续可扩展查询接口与快照策略。
- 文件：`services/notifications/internal/events/subscriber.go`

### 3.1.a 事件查询（Console 最小接口 + 前端）
- 后端：新增查询接口
  - GET `/api/v1/console/events?eventName&aggregateType&aggregateId&sinceHours&limit&offset`
  - GET `/api/v1/console/events/{id}`
  - 文件：`services/console/internal/handlers/http.go`
- 前端：新增事件浏览页 `/admin/console/events`，支持筛选与详情查看；导航补充入口。
### H2.2.f Console 后台（限流/配额配置最小化）
- 新增管理端接口读写 Adscenter 限流/配额策略（Secret Manager）：
  - `GET /api/v1/console/limits/policy` 读取当前策略（JSON或文本）；
  - `PUT /api/v1/console/limits/policy` 创建新版本（写入策略内容）；
  - 依赖：环境变量 `ADSCENTER_LIMITS_SECRET=projects/<pid>/secrets/<name>/versions/latest`
  - 文件：`services/console/internal/handlers/http.go`（引入 Secret Manager SDK），`services/console/go.mod`

### H2.2.f Console 后台（审计/重试最小化）
- 新增管理端代理 Adscenter 执行审计与死信重试接口（admin-only，经 Auth+AdminOnly 校验）：
  - `GET /api/v1/console/adscenter/bulk-actions/snapshots?id=OPID`
  - `GET /api/v1/console/adscenter/bulk-actions/snapshot-aggregate?id=OPID`
  - `GET /api/v1/console/adscenter/bulk-actions/deadletters?id=OPID&actionType=...&limit=...`
  - `POST /api/v1/console/adscenter/bulk-actions/deadletters/retry`（body: {id, dlid}）
  - `POST /api/v1/console/adscenter/bulk-actions/deadletters/retry-batch`（body: {id, actionType?, limit?}）
  - 代理时自动查询 OP 所属用户 `user_id` 并以 `X-User-Id` 透传，确保权限与数据隔离符合 Adscenter 要求。
  - 依赖：`ADSCENTER_URL`

### G3.1 Console 前端（最小页面）
- 新增管理页：
  - `apps/frontend/src/app/admin/console/limits/page.tsx`：限流/配额策略编辑器（读取/保存至 Secret Manager）。
  - `apps/frontend/src/app/admin/console/adscenter-ops/page.tsx`：批量操作审计/死信重试（输入 operationId，查看聚合/快照/死信并触发重试）。
  - 更新健康页展示“聚合健康”：/api/go/api/health，显示 overall 与各服务状态（代码/延迟）。

验收建议：
- 运行 Adscenter 本地或预发实例，访问 GET /readyz 应返回 200；停库或改错 DB URL 时返回 500 且 code=NOT_READY。
- 触发多次 Secret 读取（Adscenter/Siterank），可观察到 Secret Manager QPS 显著下降（命中本地缓存）。

- 使用服务账号 `codex-dev@gen-lang-client-0944935873` 渲染并部署 Gateway v2 到 `asia-northeast1`
- 网关 Host：autoads-gw-885pd7lz.an.gateway.dev（ACTIVE）
- 健康检查修正：`/readyz` 目标改为 siterank `/health`（原 `/healthz` 返回404）
- 冒烟：
    - GET `https://autoads-gw-885pd7lz.an.gateway.dev/readyz` → 200
    - GET `https://autoads-gw-885pd7lz.an.gateway.dev/api/v1/adscenter/oauth/callback?...` → 400（后端参数校验，路由公开可达）

### G2.1 通知服务基础能力（最小版）
- 新增表：`user_notification_state(user_id,last_read_id,updated_at)`（服务启动自动建表）
- 新增接口（暂未入 OAS，服务内直挂）：
  - `POST /api/v1/notifications/read`（body: {lastId}）标记已读位置
  - `GET /api/v1/notifications/unread-count` 返回未读数（id > last_read_id）
- 既有接口：`GET /api/v1/notifications/recent`（支持 limit/cursor）
- 文件：`services/notifications/cmd/server/main.go`

### G2.2 通知规则（最小规则、对齐 OAS）
- OpenAPI 增补：`/api/v1/notifications/rules`（GET 列表、POST upsert）
- 代码生成：已通过 `scripts/openapi/gen-go-stubs.sh notifications` 生成新接口
- 服务实现：在 `oasImpl` 中实现 list/upsert，使用 `notification_rules` 表（user_id,event_type,channel 唯一，enabled 标志）

### F1.1 原子扣费机制（最小实现）
- commit 端点原子扣减余额（事务 + FOR UPDATE）；不足返回 `409 INS UFFICIENT_TOKENS`
- reserve/release 不改变余额，仅记录 TokenTransaction（balanceBefore/After 等于当前余额）
- 写入 TokenTransaction 的 balanceBefore/After 字段，便于审计
- 文件：`services/billing/main.go`（commit/reserve/release 调整）

### A1.3 幂等扩展（MCC 链接/解绑）
- MCC Link/Unlink 接口接入 `X-Idempotency-Key`（scope: `adscenter.mcc.link|unlink`），命中直接返回 202 queued。

### E2.1 批量操作流程（最小骨架）
- 读写模型与审计：
  - 新增表 `BulkActionOperation` 与 `BulkActionAudit(before/after/rollback)`（迁移：`services/adscenter/internal/migrations/006_bulk_audit.sql`）。
  - `POST /api/v1/adscenter/bulk-actions` 入队时写入 `before` 快照；模拟完成后写入 `after` 快照。
  - 新增非 OAS 端点：
    - `GET /api/v1/adscenter/bulk-actions/{id}/audits`（查看审计快照）
    - `POST /api/v1/adscenter/bulk-actions/{id}/rollback`（标记 rolled_back 并写入 rollback 快照，stub）
- OpenAPI 扩展与前端类型：
  - OAS 增补 `/bulk-actions/{id}/audits`、`/bulk-actions/{id}/rollback`、`/bulk-actions/{id}/plan`、`/bulk-actions/validate`；
  - 生成 Go stubs 与前端 TS 类型（adscenter）。
  - 新增 `GET /api/v1/adscenter/bulk-actions`（按用户列出最近操作，支持 limit）。
  - Batchopen 增补 `GET /batchopen/templates`（国家曲线/UA/Referer/时区模板，最小内置），生成 Go/TS 类型并实现服务器端返回。

---

## 新增：环境隔离（H2.1）与计费配置明细（F1.2）

已完成（H2.1 环境隔离）
- render-gateway 自动渲染支持 STACK：
  - 脚本：`deployments/scripts/render-gateway-auto.sh` 新增 `STACK=dev|preview|prod` 参数，优先发现 `service-STACK` 的 Cloud Run URL，找不到时回退 `service`
  - 文档：`deployments/gateway/README.md` 增补“一键自动渲染（支持 STACK）”用法说明
- 名称与标签：维持 `name-services-by-stack.sh` 与 `label-services.sh` 用于 `{service}-{stack}` 命名与 `autoads-stack=<stack>` 标签管理

冒烟
- 渲染：`STACK=preview ./deployments/scripts/render-gateway-auto.sh` → 成功替换 Run URL（部分服务使用基名回退）
- 部署：创建配置 `autoads-v2-<ts>` 并更新网关 `autoads-gw`
- 未认证冒烟：`./deployments/scripts/gateway-smoke.sh`（/api/health 200，受保护接口返回 401 预期）

已完成（F1.2 计费配置与明细）
- 价格/限额集中配置只读下发：
  - 新增端点：`GET /api/v1/billing/config`（源于 Secret Manager：`billing-pricing-<STACK>`，回退 `billing-pricing`；或 `BILLING_PRICING_SECRET`/`BILLING_PRICING_JSON`）
  - 默认字段：`pricing`（如 `siterank.analyze`/`batchopen.task`/`adscenter.preflight`），`limits` 与 `updatedAt`
- 交易明细追溯：
  - 新增端点：`GET /api/v1/billing/tokens/transactions/{id}`（仅限当前用户），返回 `type/amount/balanceBefore/After/source/description/createdAt/metadata`
  - 事件负载：`TokenReserved/Debited/Reverted` 已包含 `taskId/time` 等字段，可结合明细实现链路追溯
- 共享底座（配置管理）：
  - `pkg/config.SecretForStack()`：支持优先读取 `<name>-<STACK>` 的 Secret（latest），找不到回退基础名；并保留 `SecretCached` 做 5m TTL 缓存

冒烟/验证
- `go build ./services/billing` 通过；本地路由：
  - `GET /api/v1/billing/config`（需要认证中间件）
  - `GET /api/v1/billing/tokens/transactions/{id}`（需要认证中间件）

---

## 新增：Console 最小 UI 与管理入口（G3.1 最小实现）

已完成
- 静态管理页（最小）：
  - 文件：`services/console/static/index.html`, `services/console/static/app.js`
  - 能力：在页面内粘贴 Firebase ID Token 后，调用后台 API（同域）
  - 功能：
    - 加载用户列表（查询/角色/数量）
    - 查看用户 Token 余额与最近交易、查看订阅信息
    - 角色变更（设为 ADMIN/USER）
    - 对指定用户增发 Token（正值）
    - 通知中心：recent/unread-count/标记已读，SSE 实时未读红点（fallback 轮询）
    - 系统配置（只读）：计费配置读取展示
- 容器构建：
  - `services/console/Dockerfile` 复制 `/app/static`，如无静态文件则保留占位首页
- 编译校验：`go build ./services/console` 通过

验证路径
- 通过网关访问（推荐）：`https://<gateway-host>/console/`
  - 使用管理员用户的 Firebase ID Token 粘贴至输入框
  - 执行“加载用户列表”，并尝试查看 tokens/subscription 与增发 Token



### E2.1 回滚策略（骨架）
- 新增 `POST /api/v1/adscenter/bulk-actions/{id}/rollback-plan`：生成逆向计划（仅返回，不执行）。
  - 规则（简化）：ADJUST_CPC 反向 percent；ADJUST_BUDGET 按 50% 下调；ROTATE_LINK 标记需人工。
- 已有 `POST /bulk-actions/{id}/rollback`（标记 rolled_back + 写审计快照）。

### OAuth 撤销（最小深化）
- 新增 `POST /api/v1/adscenter/oauth/revoke`：
  - 当 `OAUTH_REVOKE_LIVE=true` 时，调用 Google revoke 接口；随后清空本地 refresh token；
  - 写入审计事件 `oauth_revoke(live)`；
  - OAS/Go/TS 已同步。

### 审计能力
- 新增表 `AuditEvent(user_id, kind, data, created_at)`（迁移 `008_audit_events.sql`）。
- 新增 `GET /api/v1/adscenter/audits?kind=&limit=` 用于查询最近审计记录。

### E2.2 MCC 链接管理（最小状态机）
- 新表：`MccLink(user_id, customer_id, status [invited|pending|active|inactive])`（迁移：`services/adscenter/internal/migrations/007_mcc_link.sql`）。
- Link/Status/Unlink：
  - link：写入/更新 `pending`；
  - status：LIVE 模式下持久化标准化状态（active|pending）；stub 则返回 DB 状态或 pending；
  - unlink：写入/更新 `inactive`。
- OAS + 实现：
  - 新增 `GET /api/v1/adscenter/mcc/links`（按用户列出链接，支持 status 过滤）。
  - 新增 `GET /api/v1/adscenter/connections`（列出已存储的 Ads 连接信息，去敏）。
 - 新增刷新端点：`POST /api/v1/adscenter/mcc/refresh`（遍历当前用户 pending/ invited 的条目，若配置 LIVE 则批量刷新状态）
  - OAS 已补充，生成 Go stubs 并接入 oasImpl（adscenter）
- 定时刷新：新增 `deployments/scripts/create-mcc-refresh-scheduler.sh`，使用 Scheduler OIDC 定时调用 `/api/v1/adscenter/mcc/refresh`
  - 依赖启用脚本：`deployments/scripts/enable-apis.sh`（启用 cloudscheduler/run 等 API，并授予 invoker）
  - 支持分片：`TOTAL_SHARDS>0` 时创建多 Job（adscenter-mcc-refresh-sN），请求体传递 `{ shard, totalShards }`
- 幂等：commit/release 接入 `X-Idempotency-Key`（24h TTL）避免重复扣减/释放

### D1.3 评估结果投影（最小实现）
- Siterank 完成事件载荷补充：`offerId`、`userId`（两条主路径均包含）
- Notifications 订阅器在收到 `SiterankCompleted` 时，投影至读模型：
  - 更新 `Offer.status = 'evaluated'`（优先更新驼峰列，失败回退小写列）
- 影响文件：
  - `services/siterank/main.go`（发布事件 enrich）
  - `services/notifications/internal/events/subscriber.go`（投影 Offer 状态）

### G3.1 Console/前端计费接入（最小）
- 新增前端 BFF 路由：
  - GET `/api/billing/tokens/balance`（转发 billing 服务 `/api/v1/billing/tokens/me`）
  - GET `/api/billing/tokens/transactions`（转发 billing 服务 `/api/v1/billing/tokens/transactions`）
  - GET `/api/tokens/transactions`（聚合成 `{ records, pagination }`，兼容现有 Hook）
- 前端 hooks 调整：
  - `useTokenBalance` 走新 BFF `/api/billing/tokens/balance`
  - `useTokenTransactions` 走新 BFF `/api/tokens/transactions`

### H1.0 阶段性SLO指标拆分（siterank）
- 新增 Prometheus 直方图指标（services/siterank）：
 - `siterank_resolve_nav_ms`：解析落地导航耗时
  - `siterank_resolve_stabilize_ms`：URL 稳定窗口耗时
  - `siterank_sw_fetch_ms`：SimilarWeb 拉取耗时
  - `siterank_ai_score_ms`：AI 评分 HTTP 耗时
- siterank 在“解析落地 + AI 评分”路径中写入上述指标；browser-exec 已返回 `timings.navMs/stabilizeMs` 并被解析记录
- 指标用途：分解 P95 目标，验证“评估≤10s”仅覆盖“数据获取与评分”阶段（不含解析落地），支撑后续容量与优化调参

## 本轮前端/BFF 补充

- Pre-flight 诊断（OAS 对齐）
  - 前端 BFF：新增 `/api/adscenter/preflight` 路由对接后端
  - 前端 UI：AdsCenter 配置页新增“Pre-flight 检查（OAS 对齐）”卡片，展示 summary/checks，并计数 ok/warn/error/skip；severity 分色渲染
- 关键词扩展（最小）
  - 前端 BFF：新增 `/api/adscenter/keywords/expand` 路由
  - 前端 UI：AdsCenter 配置页新增“关键词扩展（最小实现）”卡片，展示过滤后的 top 建议
- Console 管理（最小）
  - 新增 GET `/api/v1/console/users/{id}` 返回用户详情（id/email/name/role/createdAt）
  - 增强 GET `/api/v1/console/users` 支持分页与模糊检索（参数：`q`、`limit`、`offset`）

### E1.1 仿真模板与质量评分（batchopen）
- 新增最小模板端点：GET /api/v1/batchopen/templates，返回内置国家、UA、Referer、时区集合（可扩展）
- 任务执行增强：
  - 引入 check-availability 调用的分级重试策略：429/5xx/网络错误按退避重试（默认 2 次，可配 BATCHOPEN_RETRIES/BATCHOPEN_BACKOFF_MS），4xx 不重试
  - 增加质量评分：基于 HTTP 状态与引擎(fetch/playwright)计算 0..100 分，写入 Firestore tasks 文档 quality.score/factors；同时随 Completed/Failed 事件发布
- 影响文件：services/batchopen/main.go

### B1.2 标准事件订阅扩展（notifications）
- 扩展事件监听：BrowserExecRequested/BrowserExecCompleted 入库通知 + Firestore UI 缓存
- 通知文案：
  - BrowserExecRequested：info 类别，记录 url、taskId
  - BrowserExecCompleted：success/error 类别，附带质量分 quality（若有）
- 影响文件：services/notifications/internal/events/subscriber.go

### B1.2 标准事件集补齐（部分）
- UserRegistered（懒注册）
  - siterank 在首次收到用户请求时确保读模型表 "User" 存在，并插入用户（id/email）后发布 UserRegistered 事件（一次性）
  - 影响文件：services/siterank/main.go（ensureUserDDL/ensureUserRegistered）
- Workflow* 事件（替代 workflow 服务）
  - batchopen 在 start/complete/fail 时发布 WorkflowStarted/WorkflowCompleted/WorkflowStepCompleted（fail）
  - notifications 订阅 Workflow* 并入库通知（category=workflow）
- NotificationSent 事件
  - notifications 在入库通知并写 UI 缓存后发布 NotificationSent 事件，供后续多通道分发或审计使用
  - 影响文件：services/notifications/internal/events/subscriber.go、services/notifications/cmd/server/main.go

### E2.1 批量操作流程（完成）
- 变更计划提交：`POST /api/v1/adscenter/bulk-actions`（持久化 `BulkActionOperation`，写 before 快照，返回 operationId）
- validate-only：`POST /api/v1/adscenter/bulk-actions/validate`（规则校验、配额/速率阈值检查、warnings/violations 输出）
- 入队执行：创建后异步更新 `running`→`completed`，写 after 快照（stub）
- 回滚支持：
  - 生成逆向计划：`POST /api/v1/adscenter/bulk-actions/{id}/rollback-plan`（返回 inverse plan，validateOnly 模式）
  - 执行回滚：`POST /api/v1/adscenter/bulk-actions/{id}/rollback-execute`（写 rollback_exec 审计）
  - 标记回滚：`POST /api/v1/adscenter/bulk-actions/{id}/rollback`（标记 rolled_back + 写 rollback 审计）
- 审计与查询：
  - `GET /api/v1/adscenter/bulk-actions/{id}` 返回状态与计划摘要
  - `GET /api/v1/adscenter/bulk-actions/{id}/audits` / `{id}/report` 返回快照
- 影响文件：services/adscenter/main.go（handlers 与 SQL），services/adscenter/internal/oapi/server.gen.go（路由）

### E2.3 精细化诊断与操作指导（完成，最小实现）
- 新增诊断端点（额外扩展，未入 OAS）：`POST /api/v1/adscenter/diagnose`
  - 入参：accountId、landingUrl（可选）、metrics（impressions/ctr/conversions/qualityScore/budgetPacing/dailyBudget）
  - 规则库（首批）：NO_IMPRESSIONS、LOW_CTR、LOW_QUALITY_SCORE、BUDGET_MISSING/BUDGET_EXHAUSTED、TRACKING_MISSING
  - 输出：`{ summary, rules[{code,severity,message,details}], suggestedActions[] }`
- 影响文件：services/adscenter/main.go（diagnoseHandler 与路由挂载）

### 诊断 → 一键执行（闭环增强）
- 新增：`POST /api/v1/adscenter/diagnose/plan`（返回 BulkActionPlan，仅含允许类型 ADJUST_BUDGET / ADJUST_CPC，便于直接校验）
- 新增：`POST /api/v1/adscenter/diagnose/execute`（将诊断自动生成的计划入队为 BulkActionOperation，并写 before/after 审计）
- 影响文件：services/adscenter/main.go（diagnosePlanHandler、diagnoseExecuteHandler、buildPlanFromMetrics）

### 诊断自动填充（Stub，待接入LIVE）
- 新增：`GET /api/v1/adscenter/diagnose/metrics?accountId=`（ADS_DIAG_LIVE=false 时返回确定性伪随机指标）
- 前端在“诊断与一键执行”面板增加“自动填充”按钮，默认取第一个账户
- 影响文件：
  - services/adscenter/main.go（diagnoseMetricsHandler）
  - apps/frontend/src/app/adscenter/AdsCenterClient.tsx（autoFill 集成）
### B2.1 投影器与 Saga 协调器（完成，最小实现）
- 在 notifications 订阅器内置 Saga 协调器（开关 ENABLE_SAGA=1）：
  - 监听 BatchOpsTask* 事件，持久化 `SagaInstance/SagaStep`（running/completed/compensated）
  - 对接 billing reserve/commit/release（2s 超时，X-Idempotency-Key=saga:<action>:<taskId>，X-User-Id 透传）
  - 幂等与容错：失败记录 step.last_error；实例状态更新；不影响通知入库
- 影响文件：services/notifications/internal/events/subscriber.go

### 通知 UI/BFF 最小接入
- 新增前端 BFF 路由：
  - GET `/api/notifications/recent` → `/api/v1/notifications/recent`
  - GET `/api/notifications/unread-count` → `/api/v1/notifications/unread-count`
  - POST `/api/notifications/read` → `/api/v1/notifications/read`
- 新增前端页面：`/notifications`（最近通知、未读数、全部标记已读、分页加载）
- 影响文件：
  - apps/frontend/src/app/api/notifications/*
  - apps/frontend/src/app/notifications/page.tsx
  - apps/frontend/src/components/navigation/MainNavigation.tsx（导航栏未读红点与轮询刷新）

### H1.2 SLO 监控与告警（初版脚本）
- 新增 Cloud Monitoring 策略创建脚本：
  - `deployments/monitoring/create-alert-latency.sh`：基于 Cloud Run `request_latencies` 的 P95 阈值告警（默认 5 分钟窗口）。
  - `deployments/monitoring/create-alert-error-rate.sh`：基于 MQL 计算 5xx 错误率阈值告警（默认阈值 1%）。
- 文档：`deployments/monitoring/README.md` 增补用法示例与 GMP 提示。
- 说明：阶段性指标（resolve_nav_ms 等）为 Prometheus 指标，若需在 Cloud Monitoring 中告警，需启用 GMP 抓取。

### D1.7.b 前端/通知联动（完成）
- 当 SimilarWeb 拉取失败或 AI 降级时：
  - siterank 写入 Firestore 通知（warning）并发布 NotificationCreated 事件
  - notifications 订阅 NotificationCreated 并入库 user_notifications，前端可读 UI 缓存与通知列表
- 影响文件：
  - services/siterank/main.go（maybePublishDegradedNotification 新增）
  - services/notifications/internal/events/subscriber.go（新增 NotificationCreated 分支与文案透传）
### 1.2 配置管理（最小增强）
- pkg/config 增加：
  - `SecretCached(ctx,name,ttl)`：Secret Manager 访问带内存缓存 TTL，支持最佳努力热加载
  - `JSONSecret(ctx,name,v)`：加载 JSON Secret 并反序列化
  - `GetBool/GetInt/GetDuration`：常用类型解析与默认值
- 影响文件：pkg/config/config.go

### 新增运维冒烟脚本
- `scripts/ops/smoke-adscenter-preflight.sh`：验证 `/api/v1/adscenter/preflight`
- `scripts/ops/smoke-adscenter-keywords.sh`：验证 `/api/v1/adscenter/keywords/expand`
- `scripts/ops/smoke-console.sh`：验证 Console 管理端接口
## 新增：关键词扩展（规则化，无 Ads API）（D1.4.b）

已完成
- Adscenter 接口：`POST /api/v1/adscenter/keywords/expand`
  - 入参：`seedDomain?` `seedKeywords[]?` `country?` `limit?`（默认20）`minScore?` `validateOnly?`
  - 规则：域名拆词、brand+suffix（中英文）、常见意图同义词映射；重叠度（Jaccard）与规则加权评分
  - 返回：`items[{keyword, score, reason}]`，`usedExternal=false`
- OAS 更新：`services/adscenter/openapi.yaml` 增补 keywords/expand 路由说明
- 认证与路由：通过 API Gateway 与服务中 `middleware.AuthMiddleware` 鉴权

验证
- 构建：`go build ./services/adscenter` 通过
- 调用示例：
  - `curl -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
     -d '{"seedDomain":"yitahome.com","seedKeywords":["home furniture"],"country":"US","limit":10}' \
     https://<gateway-host>/api/v1/adscenter/keywords/expand`

Console 联动
- 在管理后台“关键词扩展（内部规则，无 Ads API）”面板，直接输入域名与种子关键词，点击“生成扩展”查看结果（通过网关 + Bearer 调用）

## 新增：相似度评分控制台联动（D1.4.a）

已完成
- Console 面板（Siterank 相似度评分）：输入 seedDomain、country（可选）与候选域名列表，计算并展示分数与因子
  - 文件：`services/console/static/index.html`, `services/console/static/app.js`
- 冒烟脚本：`deployments/scripts/smoke-siterank-similar.sh`

验证
- 控制台：“相似度评分（Siterank）”面板输入后点击“计算相似度”
- 终端：`HOST=<gw> TOKEN=$ID_TOKEN ./deployments/scripts/smoke-siterank-similar.sh seed.com a.com b.com`

## 新增：机会发现（组合报告，前端最小版）

已完成
- 管理后台“机会发现（组合报告）”面板
  - 输入：seedDomain、seedKeywords（可选）、country（可选）、候选域名（可选）
  - 组合：调用 `adscenter/keywords/expand` + `siterank/similar`，渲染关键词Top10与相似域名Top10
  - 文件：`services/console/static/index.html`, `services/console/static/app.js`

验证
- 进入 Console，定位“机会发现（组合报告）”，输入后点击“生成组合报告”
  - 支持“导出CSV/JSON”“保存为机会”

## 新增：机会落表（Recommendations 服务）

已完成
- 新端点（非 OAS，直挂）：
  - POST `/api/v1/recommend/opportunities` 保存机会（user_id, seedDomain, country, seedKeywords, topKeywords, topDomains, metadata）
  - GET `/api/v1/recommend/opportunities` 列出当前用户的最近机会（最多50条）
  - GET `/api/v1/recommend/opportunities/{id}` 明细
- 表结构：`opportunities(id,user_id,seed_domain,country,seed_keywords,top_keywords,top_domains,metadata,created_at)`
- 控制台：组合报告“保存为机会”按钮直连上述接口

验证
- 构建：`go build ./services/recommendations` 通过
- 控制台：先生成组合报告，再点击“保存为机会”

增量（推荐理由摘要）
- 服务端：保存机会时生成 `summary`（Top关键词/相似域名/country/seed 简要串联），落表并写 UI 缓存
- 列表/详情：接口返回 `summary`，前端列表与详情展示摘要

## 新增：从机会一键发起批量计划（契约+前端强类型）

已完成
- Adscenter OAS：扩展 POST `/api/v1/adscenter/bulk-actions` 支持 oneOf 请求体：`BulkActionPlan` 或 `OpportunityComboPlan`
- 生成 TS 类型：`apps/frontend/src/sdk/adscenter/types.d.ts`（包含 `OpportunityComboPlan`）
- 前端机会详情页：改为使用 `OpportunityComboPlan` 强类型提交（validateOnly/seedDomain/country/plan{keywords,domains}）
- 服务端兼容：bulkActionsHandler 自动识别 combo 形态（无 actions 时解析 plan）并封装为单一 action（type=ROTATE_LINK，params 含 keywords/domains/seed/country）入队

说明
- 现阶段仅做最小封装与入队，并写审计快照；后续可将 combo plan 映射为标准 actions 列表与更细粒度审计

增量（combo → actions 转换规则）
- Adscenter 服务端：当 body 无 actions 且为 combo 形态时，构造 actions 列表：
  - 每个域名生成 `ROTATE_LINK` 动作（params 包含 targetDomain/seed/country/source）
  - 每个关键词生成 `ADJUST_CPC` 动作（percent 基于 score：≥80→15, ≥60→10, 其余 5）
  - validateOnly 语义保持不变；其余入队/审计逻辑复用原实现

增量（细粒度审计 + 导出）
- 审计：在 `before` 快照之外，逐条写入 kind=`other` 的“action”快照（包含 actionIndex/type/params/filter）
- 前端导出：
  - 我的机会列表/详情页新增导出按钮（CSV/JSON），便于分享与复核

## 新增：批量计划审计可视化（前端）

已完成
- 列表页：`/adscenter/bulk-actions`（读取 `GET /api/v1/adscenter/bulk-actions`）
- 详情页：`/adscenter/bulk-actions/{id}`（读取 operation 与 `GET /api/v1/adscenter/bulk-actions/{id}/audits`）
  - 展示提交时计划（before 快照）与细粒度动作列表（kind=other）
- 机会详情页创建计划后，若返回 `operationId`，自动跳转到该计划详情页

## 新增：用户前端“我的机会”最小页（选A）

已完成
- 列表：`apps/frontend/src/app/recommend/opportunities/page.tsx`（读取 GET /api/v1/recommend/opportunities）
- 详情：`apps/frontend/src/app/recommend/opportunities/[id]/page.tsx`（读取 GET /api/v1/recommend/opportunities/{id}）
- 与网关统一：沿用 Firebase Hosting → API Gateway 路由，前端直接调用 `/api/v1/...`

增量（分页/筛选）
- Recommendations 列表接口支持分页与筛选：limit/cursor/seedDomain/country（返回 next 游标）
- 前端列表页支持“种子域名/国家”筛选与“加载更多”

增量（CTA 串联批量计划）
- 前端机会详情页增加 CTA：
  - “校验计划（validate-only）”“一键发起批量计划”→ POST `/api/v1/adscenter/bulk-actions`（最小 JSON：validateOnly/seedDomain/country/plan{keywords,domains}）
  - 如需更严格的契约，可后续补充 Adscenter OAS 中 bulk-actions 的请求体 schema 并生成 TS 类型

验证
- 访问 `/recommend/opportunities`，可刷新查看最近机会；点击“查看”进入详情页

SDK/类型支持
- 生成 TS 类型：`./scripts/openapi/gen-ts-sdk.sh`（写入 `apps/frontend/src/sdk/recommendations/types.d.ts`）
- 前端“我的机会”页与详情页已引用类型定义，后续可逐步替换为强类型调用

---

## 今日新增（共享底座）

- 完成 1.2 配置管理（pkg/config）增强
  - 新增 KMS 加/解密助手：`EncryptKMSText` / `DecryptKMSText`（resource: `projects/.../cryptoKeys/...`，ciphertext 使用 base64）
  - 新增 `JSONSecretForStack`：优先读取 `<name>-<STACK>` 的 JSON Secret，回退基础名
  - 新增 `ValidateRequired`：校验必需环境变量是否已配置
- 完成 1.3 事件系统（pkg/events）增强
  - 事件发布自动携带 `idempotencyKey`（从中间件注入的 ctx 提取 `X-Idempotency-Key`），用于下游幂等与链路追溯
  - 不改动事件 Envelope（`specVersion=1.0`），仅扩充 Pub/Sub Attributes

冒烟
- 构建：`(cd pkg/config && go build ./...) && (cd pkg/events && go build ./...)` 通过
- 兼容：`services/billing`/`services/adscenter` 依赖编译通过（局部验证）；`services/siterank` 主程序通过（`cmd/server` 子包存在历史加载器差异，未在本次范围修复）

## 今日新增（D1.4：相似度评分详情）

- Siterank `POST /siterank/similar` 增强
  - 增加 `factors.reason` 文本摘要（示例：`域名关键词匹配 · 流量规模相近 · 行业分类相近`），便于前端直接展示“推荐理由”
  - 保持既有字段（keyword/traffic/country/category）不变，兼容现有类型
  - 逻辑对齐任务：国家重叠度 20 分（传入 country 即给分）、关键词 30、流量 25、类目 25
  - 文件：`services/siterank/main.go` 中 `computeSimilarity`

- 国家重叠度优化（有数据则用交集）
  - 若 SimilarWeb 响应包含 `top_countries[]` 或 `country_shares[{country,share}]`，使用 Jaccard 交集×20 计算 `country` 分，并输出 `countryDetail.overlap`（最多5个）
  - 无数据时保持降级：传入 `country` 即给 20 分（与既有行为一致）
  - 文件：`services/siterank/main.go`（结构体、评分逻辑与 `tryAugmentCountry` 增补）

- Console 联动展示
  - 相似度卡片新增“最小分”筛选输入与“Overlap”列（解析 `factors.countryDetail.overlap`）
  - 文件：`services/console/static/index.html`, `services/console/static/app.js`

冒烟脚本
- 新增：`deployments/scripts/smoke-siterank-similar-geo.sh`（支持 seed/country/candidates，输出 score/reason/overlap 摘要）

## Console 小迭代（相似度 & 审计导出）

- 相似度卡片新增：
  - “仅显示有重叠国家”筛选开关
  - “导出CSV”按钮（domain/score/reason/overlap）
  - “从结果生成计划(校验)”按钮：根据相似度 Top 10 生成 ROTATE_LINK 动作并调用 `/api/v1/adscenter/bulk-actions/validate`
  - “提交入队”按钮：以相似度 Top 10 生成 ROTATE_LINK 动作并调用 `/api/v1/adscenter/bulk-actions` 入队（附 `X-Idempotency-Key`），成功后自动跳转审计列表（kind=before）
  - 新增“计划类型/TopN/CPC调整%”：支持选择 ADJUST_CPC 模式（percent），并控制生成动作数量
  - 新增“保存为机会”按钮：调用 `/api/v1/recommend/opportunities` 保存相似度 TopN 结果为机会草案（含 score/reason），附幂等键
  - “机会→计划”一键：在“我的机会”详情面板新增“从机会生成计划(校验)/提交计划入队”，根据机会的 topDomains 生成动作（可复用计划类型/TopN/CPC% 控件），联动审计列表
  - 入队后自动开始轮询，完成后自动展示 After 报告与 Exec 汇总
- 审计列表卡片新增：
  - “导出CSV”按钮（kind/createdAt/summary）
  - 报告卡片增加快速跳转按钮（after/rollback_exec）至审计列表并自动筛选
- 报告卡片新增状态轮询：自动读取 `/bulk-actions/{id}` 状态；到达 `completed/rolled_back` 后自动加载 `kind=after` 报告摘要
  - 汇总执行结果：联动 `kind=rollback_exec` 计算 executed/errors/successRate 与动作类型分布并展示于报告面板
  - 导出功能：`After JSON`、`Exec CSV`、`Plan JSON`；支持一键查看 Plan
  - 新增“导出综合报告”按钮：打包 `status/updatedAt + summary(executed/errors/successRate/typeDist) + plan + after + exec` 为单个 JSON

冒烟
- `(cd services/siterank && go build ./...)` 主包编译通过；可用 `deployments/scripts/smoke-siterank-similar.sh` 验证输出因子与 reason 文本（若需）

## 前端/Console 联动（评分理由展示）

- 管理页（console/static）接入相似度“推荐理由”展示
  - 相似度列表新增 Reason 列（读取 factors.reason）；导出 CSV 含 reason 字段
  - 组合发现（关键词+相似域名）面板相似域名列表新增 Reason 列
  - 文件：`services/console/static/app.js`

## OAS 示例增强（Adscenter 批量动作）

- 为 `POST /api/v1/adscenter/bulk-actions` 增补动作参数示例与 schema：
  - 组件：`BulkActionPlan`、`BulkActionItem`、`RotateLinkParams`、`AdjustCpcParams`、`AdjustBudgetParams`
  - 示例：`rotate_and_cpc`（ROTATE_LINK + ADJUST_CPC 组合示例）
  - 文件：`services/adscenter/openapi.yaml`

## 环境隔离一键脚本（H2.1 补全）

- 新增 `deployments/scripts/bootstrap-stack.sh`
  - 功能：一键串联 enable-apis → 命名规范（dry-run）→ 标签应用 → 网关渲染
  - 参数：`STACK=dev|preview|prod PROJECT_ID=<id> REGION=asia-northeast1`
  - 后续步骤提示：Secret 同步、网关部署与冒烟脚本

## H2.2 性能与成本优化（预览调优）

- 新增一键调优脚本：`deployments/scripts/tune-preview.sh`
  - 设置 Cloud Run scaling（browser-exec/siterank/adscenter）与关键非密环境变量（上下文并发/短缓存TTL/重试）
  - 依赖脚本：`set-scaling.sh`, `set-env-vars.sh`
- 运维指南：`deployments/monitoring/Tuning.md`（包含建议默认值、脚本用法、SLO 关注点）

## 构建健全性修复（cmd/server）

- 对齐共享配置：移除 siterank/billing `cmd/server` 对不存在的 `config.LoadConfig` 依赖，统一读取 `PORT` 环境变量（默认8080）。
  - 便于在需要时单独构建 cmd 入口；不影响主服务 main.go 的运行路径。
  - 文件：`services/siterank/cmd/server/main.go`, `services/billing/cmd/server/main.go`

## F1.2 可视化（Console 局部）

- 计费明细查询与冒烟
  - 管理页新增“计费明细查询”卡片：输入交易ID查询 `/api/v1/billing/tokens/transactions/{id}`
  - 文件：`services/console/static/index.html`, `services/console/static/app.js`
  - 新增冒烟脚本：`deployments/scripts/smoke-billing.sh`（读取 `/billing/config` 和可选 txId 明细）
  - 管理页新增“我的交易（最近50）”卡片：读取 `/api/v1/billing/tokens/transactions`（点击可查看详情）
  - 价格配置结构化视图：将 `/billing/config` 的 pricing/limits 渲染为表格（同时保留原始 JSON）
  - 交易导出：新增“导出CSV”，读取 `/tokens/transactions` 并导出 id/type/amount/balanceBefore/After 等字段

## D. 审计报告（after/rollback）渲染（Console 最小版）

- 管理页新增“批量计划报告”卡片（Operation ID + kind）
  - 汇总展示 planned/executed/errors/successRate 与动作类型分布（从 `rollback`/`rollback_exec` 快照计算）
  - 保留原始 items JSON 便于排错
  - 文件：`services/console/static/index.html`, `services/console/static/app.js`
  - 接口扩展：服务端 `/bulk-actions/{id}/report` 支持 `kind=after|rollback|rollback_exec|all`（all 为默认集合）
  - 新增“审计列表”卡片（before/after/other/rollback/rollback_exec 筛选、导出 JSON）对接 `/bulk-actions/{id}/audits`
  - 冒烟脚本：`deployments/scripts/smoke-bulk-audits.sh`
