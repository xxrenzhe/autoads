# 重构落地进展（2025-09-25）

本次进展聚焦于“网关配置迁移、统一认证抽象与错误体、健康/就绪探活、试点服务改造”四个方向，确保 A/B 组基础设施与契约具备可发布的一致性。

## 已完成
- 部署配置规范化
  - 迁移 Gateway 契约到 deployments/
    - deployments/gateway/gateway.v1.yaml（原 v1）
    - deployments/gateway/gateway.v2.yaml（去除 identity/workflow，新增 notifications 占位与 /readyz）
  - 更新脚本引用路径（scripts/gateway/render-gateway-config.sh）。
- 统一底座
  - pkg/logger（zerolog JSON）
  - pkg/errors（统一错误体：{ error: { code, message, details?, traceId } }）
  - pkg/auth（从 X-User-Id / X-Endpoint-API-UserInfo / 内部JWT 提取 userId）
  - 调整 pkg/middleware.AuthMiddleware → 基于 pkg/auth.ExtractUserID 设置上下文 userID（统一使用 context key：middleware.UserIDKey）。
- BFF 配合
  - /api/go 与 /api/go（容器内）在注入内部 JWT 的同时显式设置 X-User-Id。
- 服务改造（试点 + 覆盖）
  - siterank：统一错误体；新增 /healthz, /readyz（DB Ping）
  - offer：改造 internal/auth 使用 pkg/auth；handler 统一错误体；新增 /readyz
  - adscenter：改造 internal/auth 使用 pkg/auth；新增 /readyz；修正取 userID 的 context key
  - batchopen：改造 internal/auth 使用 pkg/auth；新增 /readyz
  - billing：复用 pkg/middleware（已切换 pkg/auth）；新增 /readyz；统一错误体；修复 Subscription 查询 404（http.StatusNotFound）
- 数据库 Schema（最小集）
  - schemas/sql/001_event_store.sql（事件存储表）
  - schemas/sql/002_read_models.sql（User、Offer、SiterankAnalysis）

- OpenAPI 与代码生成工具链（A1.2）
  - 新增 Go stubs 生成脚本：scripts/openapi/gen-go-stubs.sh（oapi-codegen，输出到 services/*/internal/oapi）
  - 新增 OpenAPI 校验脚本：scripts/openapi/validate.sh（@redocly/cli 优先）
  - 新增最小契约检查脚本：scripts/openapi/contract-test.sh（校验 + 生成）
  - 已生成 stubs：offer/siterank/adscenter/batchopen/billing/notifications

- 共享底座：配置与密钥
  - 新增 pkg/config：环境装载（STACK/PROJECT_ID）、Secret Manager 助手（支持简写 name[:version]）
  - go.work 纳入 pkg/config；独立 go.mod 完成 tidy

- Siterank：SimilarWeb域名数据全局缓存
  - 新增 schemas/sql/004_domain_cache.sql 表：host / payload(JSONB) / ok / expires_at
  - siterank 服务在调用 SimilarWeb 前先读取全局缓存：
    - 成功命中 → 直接完成分析（status=completed），并发布 SiterankCompleted（cacheHit=true）
    - 未命中/过期 → 调用 SimilarWeb；成功写入7天TTL；失败写入1天TTL
  - 同时保留本地内存5分钟短缓存以减少数据库读负载

- A1.3 幂等处理（siterank/analyze 先行）
  - 新增 schemas/sql/005_idempotency.sql 表：idempotency_keys（key/user_id/scope/target_id/expires_at）
  - siterank createAnalysis 支持 X-Idempotency-Key：重复请求返回同一分析任务
  - 冲突时（相同 offer+user）如带 key，则绑定至最新记录并返回 202

- 数据库迁移辅助
  - 新增脚本 scripts/db/apply-sql.sh：按顺序应用 schemas/sql/*.sql（psql + DATABASE_URL）
  - 新增 Go 版本迁移器 scripts/db/apply-sql.go：无需 psql，读取 DATABASE_URL 顺序执行 SQL 文件
  - 新增 Cloud Run Job 方案（方式A）：
    - 迁移镜像 Dockerfile：deployments/db-migrator/Dockerfile（构建 db-migrator 二进制）
    - 预发 Job 配置：deployments/db-migrator/job.preview.yaml（VPC Connector + Secret Manager）
    - 一键脚本：deployments/scripts/run-db-migrator.sh（Cloud Build 构建 + Jobs 部署与执行）

- 路由契约与 OAS 清理
  - Siterank 绑定生成的 chi server + 中间件
  - 批量补齐 batchopen/billing/notifications 的 license/operationId；browser-exec 补齐安全与 operationId

- Siterank 路由契约对齐（chi + oapi-codegen）
  - 绑定生成的 chi server 到 /api/v1（services/siterank/main.go），启用 AuthMiddleware + IdempotencyMiddleware
  - 修正 DB 列名不一致（sa.offer_id）

- 共享幂等中间件
  - 新增 pkg/idempotency（上下文读写、校验）
  - 新增 pkg/middleware/IdempotencyMiddleware（提取 X-Idempotency-Key 注入 context）

- OpenAPI 清理
  - 为 batchopen/billing/notifications 补齐 license 与 operationId；重新生成 Go/TS 代码

- 事件系统与UI缓存（本次新增）
  - 新增 pkg/events：事件信封 Envelope（specVersion/id/type/time/data）、发布器封装（Pub/Sub），标准事件名常量（B1.2）
  - siterank 改造：迁移到 pkg/events 发布 SiterankRequested/SiterankCompleted，携带 source/subject
  - notifications 订阅器：兼容 Envelope，自动解包 data 字段后入库与投影
  - siterank 实现 Firestore UI 缓存（B2.3 最小实现）：完成后写入 users/{uid}/siterank/{offerId}（FIRESTORE_ENABLED=1 时启用，最佳努力）

- Browser‑Exec 构建与部署（解阻）
  - 修复 Dockerfile：COPY 整个目录，确保包含 pool.js
  - Cloud Build 成功：build=6f0d0d39-a392-4b62-9503-faaa8910ed87（browser-exec:preview-json）
  - Cloud Run 部署成功：browser-exec URL：https://browser-exec-yt54xvsg5q-an.a.run.app；已注入 PLAYWRIGHT=1 与 PROXY_URL_US
  - 自检：/parse-url OK、/check-availability OK；/api/v1/browser/json-fetch 访问 SimilarWeb 返回超时（12s）

- Siterank 修复与验证
  - 修复 DB 列名查询不一致：使用 Offer.originalurl（与当前库实际列对齐）
  - 重新构建并部署：build=0656a60c-2a43-4beb-b1b5-e8a05eb9b9e6（siterank:preview-fixcol2）
  - 注入环境：BROWSER_EXEC_URL、SIMILARWEB_RETRIES/USER_AGENT、FIRESTORE_ENABLED=1
  - 端到端：创建 offer=https://nike.com → analyze → running → SimilarWeb 403（直连被拒）；browser‑exec 回退仍未成功（代理抓取超时）

## 验证建议
- Gateway 预发验证
  - 渲染：PROJECT_ID=gen-lang-client-0944935873 SITERANK_URL=... ./scripts/gateway/render-gateway-config.sh deployments/gateway/gateway.v2.yaml out/gateway.yaml
  - 部署：scripts/gateway/deploy-gateway.sh（指向 out/gateway.yaml）
  - 烟囱：scripts/ops/smoke-gateway-v2.sh（/readyz 200；受保护路由 401/403）
- 服务探活
  - 各服务 /healthz 与 /readyz 可用，BFF readiness gate 可直接使用 /readyz

## 待办（Next）
- A组：OpenAPI 契约与 SDK
  - 为 offers/siterank/adscenter/billing/batchopen 输出 OpenAPI 3 规范；生成 Go stubs + TS SDK；纳入 CI 契约测试
- B组：事件驱动与投影
  - 完整标准事件集（schemas/events/*）；投影器样板；一次性迁移脚本
- C组：Browser-Exec 服务（Node.js 22 + Playwright）
  - 架构骨架与 /parse-url /check-availability /simulate-click /batch-execute MVP
- 其余服务改造
  - 移除对 Identity/Workflow 的外部依赖；通过 Gateway 完成鉴权；以事件流替代 Workflow
- 监控与SLO
  - /readyz 纳入 Cloud Run 健康检查；Error/Latency 指标埋点（后续 pkg/telemetry）

- Browser‑Exec JSON 抓取稳定性提升（优先）
  - 将 /json-fetch 支持 timeoutMs 与自定义 headers，并在 Playwright 中设置 UA 与 extraHeaders
  - 将 waitUntil 调整为 'load' 或 'networkidle' 可配置；超时提升至 20–30s
  - 代理获取改为 ips=3–5 并轮换重试（指数退避），失败时切换国家段
  - 预检代理连通性（对公共域 204/200）再调用目标，降低整体超时

## 风险与说明
- 当前个别服务 go.mod 依赖尚未补全（如 redis/godotenv 等），本次未统一整理。后续在对应服务落地阶段逐一 tidy 与构建。
- pkg/auth 内部 JWT 模式需在预发/本地配置 INTERNAL_JWT_PUBLIC_KEY/PRIVATE_KEY 才能启用严格校验；生产建议优先通过 API Gateway 注入 X-Endpoint-API-UserInfo。

---
维护人：工程平台
记录位置：.kiro/specs/addictive-ads-management-system/progress-2025-09-25.md
- 预发迁移（方式A）
  - gcloud 已登录后执行：PROJECT_ID=gen-lang-client-0944935873 REGION=asia-northeast1 ./deployments/scripts/run-db-migrator.sh
  - 确认表：domain_cache 与 idempotency_keys 已创建
  - 执行 smoke：SITERANK_URL=<run-url> OFFER_ID=<id> ./scripts/ops/smoke-siterank.sh
