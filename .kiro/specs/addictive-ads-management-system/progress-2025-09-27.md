# 2025-09-27 进展纪要（预发）

## 已完成

- 预发 DB Migrator 执行（Cloud Run Job）
  - 构建镜像并部署 `db-migrator-preview`，通过 VPC Connector 访问 Cloud SQL
  - 执行成功，读模型/事件表迁移到位（预发）

- API Gateway v2（preview）渲染与部署
  - 自动发现 Cloud Run 服务 URL 渲染 `gateway.v2.rendered.yaml`
  - 部署 API `autoads-api` / Config `autoads-v2` / Gateway `autoads-gw`
  - 公共健康探针冒烟 200：`/readyz`、`/api/health`、`/api/health/console`、`/api/health/adscenter`

- 网关鉴权冒烟（Firebase ID Token）
  - Secret Manager 创建 `NEXT_PUBLIC_FIREBASE_API_KEY`
  - 生成 ID Token 并通过网关鉴权调用受保护端点（返回 200/404，鉴权与路由链路 OK）

- Cloud Run 运维
  - `siterank-preview`、`adscenter-preview`：并发/实例数调整 + 打标 `autoads-stack=preview`
  - 创建 Cloud Scheduler Job：`adscenter-preview-execute-tick`（每 5 分钟）

- 监控与告警
  - 创建 P95 时延告警策略：siterank/batchopen/adscenter/billing（Cloud Run）
  - 创建 Uptime Check：API Gateway `/readyz`

- 4.1 Offer 服务 CRUD 端点（最小落地）
  - OpenAPI 契约补齐：GET/PUT/DELETE `/api/v1/offers/{id}`，PUT `/api/v1/offers/{id}/status`，GET `/api/v1/offers/{id}/kpi`
  - 生成 Go chi-server 与 types（oapi-codegen）；已绑定到 `services/offer`
  - 处理幂等与鉴权复用既有中间件；更新/删除具备按 `userid` 归属校验
  - `offer` 服务编译通过

- 15.1 Siterank 服务增强（阶段性）
  - 新增关键词扩展建议 API（不依赖 Google Ads）：`POST /api/v1/siterank/keywords/suggest`
    - 基于域名拆词 + 页面标题/SiteName 信号（browser-exec）+ 简单规则评分（0..1）
    - 支持参数：`seedDomain`、`country?`、`topN?`（默认20）、`minScore?`（默认0.4）
    - 返回字段：`items[].{keyword, score, reason?}`
  - OpenAPI 已更新并生成 Go stubs（oapi-codegen），落地到 `services/siterank/internal/oapi`
  - 编译通过：`services/siterank` 构建成功
  - 新增冒烟脚本：`scripts/ops/smoke-siterank-keywords.sh`

- Siterank 相似度算法（复核）
  - `/api/v1/siterank/similar` 端点具备：域名关键词(30%) + 流量规模相似(25%) + 国家重叠(20%) + 行业分类(25%)
  - 与 15.1 的“简化相似度算法”一致（规则口径已在代码中实现）。

## 进行中

- 15.2 Adscenter 服务诊断增强（MVP 已有骨架）
  - 已存在诊断端点（未入 OAS）：
    - `POST /api/v1/adscenter/diagnose`（规则引擎：无曝光、低CTR、低质量分、预算问题、跟踪缺失等；返回结构化规则与建议）
    - `POST /api/v1/adscenter/diagnose/plan`（从指标推导出 validate-only 批量计划骨架）
    - `GET  /api/v1/adscenter/diagnose/metrics`（提供示例/伪实时指标；后续可接 Ads 实时）
- 新增冒烟脚本：`scripts/ops/smoke-adscenter-diagnose.sh`
  - 规则增强：新增“无转化”“预算耗尽细化”“跟踪缺失”影响预估；建议动作附带 `impact`（如 expectedCtrDelta/expectedConvDelta）
  - 后续：将诊断端点纳入 OAS；与批量执行链路挂钩；扩充规则库与建议模板

## 新增链路脚本

- 诊断→计划→校验→入队→执行（最小闭环）
  - `scripts/ops/diagnose-plan-enqueue.sh`：
    1) GET `/api/v1/adscenter/diagnose/metrics`
    2) POST `/api/v1/adscenter/diagnose/plan`（validateOnly）
    3) POST `/api/v1/adscenter/bulk-actions/validate`
    4) POST `/api/v1/adscenter/bulk-actions`（带 X-Idempotency-Key）
    5) POST `/api/v1/adscenter/bulk-actions/execute-tick?max=1`
  - 便于预发环境快速联通全链路
- execute-tick 公平性优化
  - 对全局队列按 owner(user_id) 分组，每轮从不同 owner 各挑1个 shard 执行，避免单用户长队列饿死
  - 代码：services/adscenter/main.go（executeTickHandler 轮询逻辑）

- 基于建议的诊断闭环（建议→计划）
  - `scripts/ops/diagnose-suggest-plan-enqueue.sh`：
    1) POST `/api/v1/adscenter/diagnose`（获取 `suggestedActions`）
    2) POST `/api/v1/adscenter/diagnose/plan`（传入 suggestedActions 构建计划）
    3) POST `/api/v1/adscenter/bulk-actions/validate`
    4) POST `/api/v1/adscenter/bulk-actions`
    5) POST `/api/v1/adscenter/bulk-actions/execute-tick?max=1`

## 使用说明

- 关键词建议
  - 请求示例：
    ```bash
    ./scripts/ops/smoke-siterank-keywords.sh http://localhost:8080/api/v1 example.com US
    ```
  - 返回示例（节选）：
    ```json
    { "items": [ { "keyword": "brand x", "score": 0.82, "reason": "品牌+标题" }, ... ] }
    ```

- 相似度计算：参考 `POST /api/v1/siterank/similar`（已存在）
  
- Adscenter 诊断（本地/预发服务）：
  - 指标获取与诊断：
    ```bash
    ./scripts/ops/smoke-adscenter-diagnose.sh http://localhost:8080
    ```
  - 返回结构包含 summary/rules/suggestedActions 与从 metrics 推导的计划

- 机会到批量计划：
  ```bash
  BASE=http://localhost:8080 AUTH="Bearer <token>" ./scripts/ops/opportunity-to-bulk.sh <opportunityId>
  ```

- 执行调度与SLO告警：
  - 创建定时执行tick：
    ```bash
    PROJECT_ID=gen-lang-client-0944935873 REGION=asia-northeast1 STACK=preview \
    MAX=2 SCHEDULE="*/5 * * * *" ./deployments/scripts/create-execute-tick-scheduler.sh
    ```
  - 创建SLO告警：
    ```bash
    PROJECT_ID=gen-lang-client-0944935873 ./deployments/monitoring/bootstrap-slo-alerts.sh
    ```

  - 离线品牌审计调度：
    ```bash
    PROJECT_ID=gen-lang-client-0944935873 REGION=asia-northeast1 STACK=preview \
    SEED_DOMAIN=example.com COUNTRY=US DAYS=30 SHARD=0 TOTAL_SHARDS=1 SCHEDULE="0 * * * *" \
  ./deployments/scripts/create-brand-audit-scheduler.sh
  ```

- API Gateway 健康检查
  - `PROJECT_ID=gen-lang-client-0944935873 REGION=asia-northeast1 ./deployments/scripts/gateway-smoke.sh`
  - 网关域名（预发）：`autoads-gw-885pd7lz.an.gateway.dev`

- 4.y Offer KPI 真数据落地（阶段1）
  - 新增读模型表：`OfferAccountMap`、`OfferDailyKPI`（schemas/sql/012_offer_kpi.sql）
  - Offer 服务 `GET /api/v1/offers/{id}/kpi` 优先读取 `OfferDailyKPI`（最近7天），存在真实数据则返回真实数据，否则回退伪数据
  - 返回体新增 `source` 字段：`real` 或 `synthetic` 用于前端标注
  - 后续计划（下一步）：
    - 聚合任务（Scheduler/Functions/Job）从 Ads 数据源写入 `OfferDailyKPI`
    - 前端看板卡片优先读取真实 KPI 并做空值占位

- 4.y Offer KPI 聚合最小落地（阶段2-局部）
  - 新增聚合端点：`POST /api/v1/offers/{id}/kpi/aggregate?date=YYYY-MM-DD`（按天聚合并 UPSERT 至 `OfferDailyKPI`）
  - 聚合策略：
    - 优先调用 Adscenter `GET /api/v1/adscenter/diagnose/metrics?accountId=...`（按 `OfferAccountMap` 关联的 account 汇总）
    - 无映射或失败时回退合成估算（与 KPI 伪数据口径一致）
  - 调度脚本：
    - `deployments/scripts/aggregate-offer-kpi.sh`（冒烟）
    - `deployments/scripts/create-offer-kpi-scheduler.sh`（创建带 OIDC + `X-User-Id` 的 Cloud Scheduler Job，日更）
  - OAS 补齐：`.kiro/specs/.../openapi/offer.yaml` 增加 `POST /offers/{id}/kpi/aggregate`

- 16. Google Ads 账号授权与关联（映射最小实现）
  - 新增 Offer 侧映射接口：
    - `GET  /api/v1/offers/{id}/accounts` 列表
    - `POST /api/v1/offers/{id}/accounts` 新增映射（去重）
    - `DELETE /api/v1/offers/{id}/accounts/{accountId}` 删除映射
  - 读模型：`OfferAccountMap`（已在 012_offer_kpi.sql）
  - 脚本：`deployments/scripts/link-offer-account.sh`
  - 用途：为 KPI 聚合与批量操作提供 Offer→Account 关联依据

- 前端看板最小接入（真实 KPI + 映射管理）
  - Offer 看板：`apps/frontend/src/app/offers/kanban/page.tsx`
    - 加载并渲染 `GET /offers/{id}/kpi` 的近7天曲线（曝光/点击、花费/收入），显示 ROSC
    - 若 `source!=real` 则自动触发 `POST /offers/{id}/kpi/aggregate` 聚合，1.5s 后自动刷新；UI 显示“占位/真实”徽标与“同步中…”提示
    - 新增“账号”管理弹窗：列出/新增/删除 Offer→Account 映射
  - SDK 扩展：`apps/frontend/src/sdk/offer/client.ts` 新增 `aggregateOfferKPI`/`listOfferAccounts`/`linkOfferAccount`/`unlinkOfferAccount`

- KPI 聚合健壮性（DLQ与重试）
  - 新增表：`OfferKpiDeadLetter`（schemas/sql/013_offer_kpi_dlq.sql）
  - 内部接口：
    - `GET  /api/v1/offers/internal/kpi/deadletters?limit=50`（X-Service-Token）
    - `POST /api/v1/offers/internal/kpi/retry?id=..|max=..`（X-Service-Token）
  - 分片日更时失败写入 DLQ，重试成功标记 resolved
  - 调度脚本：`deployments/scripts/create-offer-kpi-retry-scheduler.sh`

- Console 后台（DLQ 运维接口）
  - API：
    - `GET  /api/v1/console/offers/kpi/deadletters?limit=50`（直接读库）
    - `POST /api/v1/console/offers/kpi/retry { id? , max? }`（代理到 Offer 内部重试端点，使用 `OFFER_URL` 与 `INTERNAL_SERVICE_TOKEN`）
  - 文件：`services/console/internal/handlers/http.go` 路由已注册，编译通过

- G3.3 告警规则编辑器（Console 最小实现）
  - 表：`notification_rules`（schemas/sql/014_notification_rules.sql）
  - API：GET/POST/PUT/DELETE `/api/v1/console/notifications/rules`（管理员鉴权）
  - 页面：`/console/rules/index.html`（静态页，支持列表/新建/删除；编辑走 PUT 接口可按需扩展）
  - 说明：最小版聚焦“规则配置持久化 + 管理入口”，告警联动由 deployments/monitoring 脚本统一创建策略并逐步融合

- H1.4 SLO 深化与告警联动（最小闭环）
  - Console `getSLO` 增加缓存（TTL=60s），避免频繁抓取 /metrics
  - 新增评估端点：`POST /api/v1/console/notifications/rules/evaluate`（管理员鉴权）
    - 基于 `getSLO` 快照评估 `notification_rules`（p95_latency_ms、error_rate、dlq_size）
    - 触发阈值时向 `user_notifications` 写入 `ALERT`（10分钟去重），Console Alerts 列表可见
  - 文件：`services/console/internal/handlers/http.go`

- 9.1 Cloud Scheduler + Pub/Sub 架构（最小实现）
  - Cloud Functions Gen2：`services/functions/dispatcher`（订阅主题，读取 `{url, method, headers, body}` 并发起 HTTP 调用；`X-Service-Token=ENV` 自动注入环境令牌）
  - 部署脚本：`deployments/scripts/create-pubsub-dispatcher.sh`
  - 调度脚本：`deployments/scripts/create-scheduler-pubsub-dispatch.sh`（向 Topic 发布 JSON 载荷）
  - 用例：将此前的 HTTP 定时作业（如 KPI 聚合、规则评估）替换为 Scheduler→Pub/Sub→Functions→目标服务的链路

- 11.1 管理员仪表盘（最小实现）
  - 页面：`/console/admin/index.html`（统计/SLO/告警/事件汇总，支持强制刷新）
  - 数据源：`/api/v1/console/stats`、`/api/v1/console/slo`、`/api/v1/console/alerts`、`/api/v1/console/incidents`
  - 说明：静态最小版，后续可扩展跳转至告警详情、规则管理等

- 3.1 事件存储基础设施（offer 最小接入）
  - Offer 创建事件写入 `event_store`（best-effort，按 offerId 幂等）
  - 代码：`services/offer/internal/handlers/http.go` 在发布 `OfferCreated` 后调用 `pkg/eventstore.WriteWithDB`
  - 读写保障：服务启动/调用时 `EnsureDDL` 确保表存在

## 风险与后续

- 关键词建议当前基于启发式规则，未接入外部搜索趋势或 Ads 关键词规划师；后续可引入：
  - 通过 Firebase AI Logic 生成候选短语并再打分（与 AI_SCORING_URL 对齐）
  - 引入“国家别停用词/映射表”，增强多语言适配
  - 可追加“组合词（2-grams）”与“去重归一化”策略
  
- 部署阻塞（需环境允许）：
  - Cloud Build 使用 Dockerfile 构建失败（step 0 docker），疑似基础镜像拉取/工具链版本；已尝试 Kaniko+scratch/Go builder 方案。
  - 准备方案：采用 Cloud Build + Go 构建二进制 + Kaniko 装入 distroless；或由 GitHub Actions 触发官方流水线构建。

- 告警策略补充：5xx 错误率 MQL 语法优化后重试创建（当前已上线 P95 时延告警）

## 配置与依赖

- 环境变量（可选）：
  - `BROWSER_EXEC_URL`：用于 resolve-offer 与 page-signals（无则仅用域名信号）
- 不涉及 Secrets 改动；未触发 Cloud 侧变更。
 - 新增 SQL 迁移：`schemas/sql/010_adscenter_bulk.sql`（BulkActionOperation/Shards/Audit/MccLink 等表）

## 结论

- 15.1 的“关键词扩展建议”已落地一个可用的 MVP，满足“无需 Ads API、基于 SimilarWeb/页面信号 的简化实现”的要求；后续可迭代评分模型与多语言/国家适配。
