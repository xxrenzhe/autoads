# 进展纪要（2025-09-27）

本次提交围绕 UI 导航与信息架构优化（U1/U2）推进了前端重构落地，符合 MustKnowV3 的“最终形态直达、KISS、一次成型”原则。

## 完成事项

- 顶部导航重构（U1）
  - 导航聚焦为：Offers / Operations / Insights / Settings
  - 移除 Billing 顶级入口（计费入口聚合到 Settings 页内）
  - 移除 Workflow 顶级入口（工作流由事件驱动替代）
  - 未登录时在“更多”菜单里显示 Pricing（定价页仅未登录展示）
  - 变更文件：
    - apps/frontend/src/components/Navigation.tsx

- 页面路由整合（U2，第一步）
  - 新增聚合入口：
    - /operations：批量矩阵与诊断（Adscenter）、真实点击/仿真（Batchopen）
      - 文件：apps/frontend/src/app/operations/page.tsx
    - /insights：评估与趋势（Siterank）、通知与预警
      - 文件：apps/frontend/src/app/insights/page.tsx
  - 从导航移除历史独立入口（Batchopen/Siterank 等不再作为顶级导航项）
  - robots 已屏蔽 /ops/*（无需调整），sitemap 未收录测试/后台路径（保持不变）

- 旧路由处置与 SEO 收敛
  - /workflows 路由改为 307 重定向至 /operations（删除 Workflow 入口）
    - 文件：apps/frontend/src/app/workflows/page.tsx
  - robots 增加对 /monitoring 与 /test-environment 的屏蔽（生产不索引）
    - 文件：apps/frontend/src/app/robots.ts

- Settings 聚合计费入口
  - 在 Settings 页面增加“订阅与计费”入口，取代 Billing 顶级导航
  - 文件：apps/frontend/src/app/settings/page.tsx

- Offer 详情页（合流起步）
  - 新增 /offers/[id]：集成 Siterank 一键评估与结果展示（临时入口，后续扩展相似机会模块）
    - 文件：apps/frontend/src/app/offers/[id]/page.tsx
  - Offer 列表名称链接跳转到详情页
    - 文件：apps/frontend/src/app/offers/page.tsx
  - 相似机会与关键词扩展模块接入（评分明细/推荐理由展示，支持一键“添加到机会池”）
    - 文件：apps/frontend/src/app/offers/[id]/page.tsx
  - 历史记录与趋势展示（近30天趋势、最近10条历史）
    - 文件：apps/frontend/src/app/offers/[id]/page.tsx、apps/frontend/src/sdk/siterank/client.ts
  - 一键诊断并执行（简化链路）：读取关联账号 → 获取诊断指标 → 生成计划 → 校验 → 入队
    - 文件：apps/frontend/src/app/offers/[id]/page.tsx

- /siterank 旧路由收敛
  - 将 /siterank 重定向至 /insights（避免双入口）
    - 文件：apps/frontend/src/app/siterank/page.tsx

- 管理员可见性
  - 中间件为 /ops 增加管理员校验与 X-Robots-Tag:noindex
    - 文件：apps/frontend/src/middleware.ts

- Operations 聚合页 Tab化
  - 增加 Tabs，将 Adscenter 与 Batchopen 分组展示，支持 query 同步（?tab=batchopen）
  - 文件：apps/frontend/src/app/operations/page.tsx
  - 新增“最近执行历史”概览，展示最近10条批量计划并链接详情
    - 文件：apps/frontend/src/app/operations/page.tsx
  - 批量详情页新增“回滚”能力（加载回滚计划 / 执行回滚）
    - 文件：apps/frontend/src/app/adscenter/bulk-actions/[id]/page.tsx

- /batchopen 旧路由收拢
  - /batchopen 重定向至 /operations?tab=batchopen
    - 文件：apps/frontend/src/app/batchopen/page.tsx

- 事件存储（3.1 最小查询）
  - 统一 event_store DDL（event_id 使用 TEXT，与运行时一致）
    - 文件：schemas/sql/001_event_store.sql
  - 在 notifications 增加最小事件查询端点：GET /api/v1/console/events
    - 支持过滤：type/aggregateType/aggregateId/since/until；分页：cursor(id) + limit
    - 仅返回与当前用户相关的事件（payload/metadata.userId）
    - 文件：services/notifications/cmd/server/main.go
  - 增加 NDJSON 导出：GET /api/v1/console/events/export（最大1000条，沿用相同过滤器）
    - 文件：services/notifications/cmd/server/main.go
  - 增加 CSV 导出（format=csv）
    - 文件：services/notifications/cmd/server/main.go

- 后台管理系统（11.7 起步）
  - 新增系统事件页面：/admin/system/events，调用 /ops/api/v1/console/events 展示最近事件、支持“加载更多”
    - 文件：apps/frontend/src/app/admin/system/events/page.tsx
  - 增加筛选（type/aggregateType/aggregateId/since/until）与导出（NDJSON/CSV）
    - 文件：apps/frontend/src/app/admin/system/events/page.tsx
  - 新增事件类型聚合端点与下拉选择
    - API：GET /api/v1/console/events/types（返回前100类按计数降序）
    - 文件：services/notifications/cmd/server/main.go；前端下拉：apps/frontend/src/app/admin/system/events/page.tsx
  - 快捷时间选择（近24小时/近7天），联动加载与导出
    - 文件：apps/frontend/src/app/admin/system/events/page.tsx
  - 类型多选筛选与“导出列选择”（前端侧生成CSV）
    - 文件：apps/frontend/src/app/admin/system/events/page.tsx；后端 list 支持 type 多值 IN 过滤

- Offer 诊断-建议-计划编辑-执行（前端交互）
  - 一键诊断（获取建议）→ 根据建议生成计划 → 校验 → 入队
    - 文件：apps/frontend/src/app/offers/[id]/page.tsx
  - 建议勾选生成计划、规则按严重级别过滤（error/warn/info）
    - 文件：apps/frontend/src/app/offers/[id]/page.tsx
  - 计划编辑自动校验（600ms 去抖），通过/问题即时提示
    - 文件：apps/frontend/src/app/offers/[id]/page.tsx

- Operations 聚合页增强
  - 新增“分片进度”展开查看（逐操作拉取 /shards，统计 queued/running/completed/failed）
    - 文件：apps/frontend/src/app/operations/page.tsx
  - 新增“动作审计”展开查看（逐操作拉取 /audits，展示最新3条与总条目）
    - 文件：apps/frontend/src/app/operations/page.tsx
  - 新增“执行下一片”按钮（逐操作调用 /bulk-actions/{id}/execute-next）
    - 文件：apps/frontend/src/app/operations/page.tsx
  - 新增“全局推进 N 片”控制（调用 /bulk-actions/execute-tick?max=N）
    - 文件：apps/frontend/src/app/operations/page.tsx
  - 新增“失败分片快速定位”（采样最近 N 个操作，聚合显示失败分片，提供推进与详情/回滚入口）
    - 文件：apps/frontend/src/app/operations/page.tsx
  - 新增“回滚历史汇总”（统计最近 N 个操作的回滚次数，列出最近回滚）
    - 文件：apps/frontend/src/app/operations/page.tsx
  - 新增“失败原因 Top K”（从动作审计聚合近因）
    - 文件：apps/frontend/src/app/operations/page.tsx
  - 新增“回滚趋势（近7天）”（基于最近 N 操作的回滚执行审计）
    - 文件：apps/frontend/src/app/operations/page.tsx
  - 新增“全局分片进度总览”（最近20个操作汇总）
    - 文件：apps/frontend/src/app/operations/page.tsx

## 未完成与后续计划

- U2 深化：
  - 将 /siterank 能力完全融入 Offer 详情/看板（替代独立路由），并提供迁移期重定向
  - 将换链接等旧入口统一以 Operations 子页/Tab 呈现

- 管理入口与可见性：仅管理员可见 /ops/console（需接入角色判定）

- 关联设置聚合：Settings 中补充 Billing（订阅/计费）入口的 UI 文案与跳转

## 备注

- 未改动 tasks.md 的任务内容，仅按 U1/U2 标注完成对应子项（代码已落地）
- 无破坏性迁移：旧路由暂保留可访问，后续补充显式 3xx 重定向
