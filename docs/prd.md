# AutoAds 多租户 SaaS 系统重构 PRD

## 文档信息
- **项目名称**: AutoAds 多租户 SaaS 系统重构
- **版本**: v1.0
- **创建日期**: 2025-01-09
- **最后更新**: 2025-01-09
- **负责人**: 产品团队

## 1. 项目概述

### 1.1 项目背景
AutoAds 目前是一个单租户的自动化营销平台，提供三大核心业务功能：BatchOpen（真实点击）、SiteRank（网站排名分析）和 AdsCenter（智能广告管理）。为了支持业务扩展和提升系统架构，需要将现有系统重构为多租户的 SaaS 架构，并集成 GoFly 后台管理系统。

### 1.2 项目目标
- 将现有系统重构为支持多租户的 SaaS 架构
- 集成 GoFly 框架，利用其成熟的后台管理功能
- 保持三大核心业务功能的完整性和稳定性
- 提升系统的可扩展性和维护性
- 优化性能和资源利用率

### 1.3 成功标准
- 完成多租户架构改造，支持租户隔离
- 三大核心功能正常运行且性能不降级
- 集成 GoFly 后台管理系统
- 实现平滑的数据迁移
- 系统稳定性达到 99.9% 以上

## 2. 业务需求

### 2.1 多租户 SaaS 需求

#### 2.1.1 租户管理
- **租户注册**: 支持自助注册和管理员创建
- **租户配置**: 每个租户可配置独立的品牌、域名、主题
- **资源隔离**: 租户间数据完全隔离，确保安全性
- **权限管理**: 基于角色的访问控制（RBAC）

#### 2.1.2 订阅和计费
- **套餐管理**: 提供不同级别的服务套餐
- **用量限制**: 基于 token 的使用量控制
- **计费系统**: 集成 Stripe 支付，支持自动续费
- **发票管理**: 自动生成和发送发票

### 2.2 核心业务功能保留

#### 2.2.1 BatchOpen（真实点击）
- **功能保持**: 维持现有的批量 URL 访问功能
- **代理管理**: 支持代理 IP 池管理和轮换
- **任务调度**: 批量任务的创建、执行和监控
- **报告生成**: 详细的执行报告和统计分析

#### 2.2.2 SiteRank（网站排名分析）
- **API 集成**: 保持与 SimilarWeb API 的集成
- **批量查询**: 支持大批量网站排名查询
- **数据导出**: 多格式的数据导出功能
- **缓存机制**: 优化 API 调用，降低成本

#### 2.2.3 AdsCenter（智能广告管理）
- **多账户管理**: 支持多个 Google Ads 账户
- **AdsPower 集成**: 维持与 AdsPower 的自动化集成
- **链接管理**: 智能的链接替换和管理
- **执行监控**: 实时监控任务执行状态

### 2.3 GoFly 框架集成需求

#### 2.3.1 后台管理系统
- **管理后台**: 使用 GoFly 的 admin 模块
- **业务后台**: 使用 GoFly 的 business 模块
- **权限控制**: 利用 GoFly 的 RBAC 系统
- **API 管理**: 统一的 API 网关和管理

#### 2.3.2 数据库架构
- **多租户数据库**: 基于 business_id 的数据隔离
- **数据迁移**: 现有数据的平滑迁移
- **性能优化**: 数据库查询优化和索引设计
- **备份恢复**: 完善的数据备份和恢复机制

## 3. 技术架构

### 3.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    负载均衡层 (Nginx)                          │
├─────────────────────────────────────────────────────────────┤
│  应用服务层 (Go Services + Next.js Frontend)                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │   租户A     │ │   租户B     │ │   租户C     │            │
│  │  服务实例   │ │  服务实例   │ │  服务实例   │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
├─────────────────────────────────────────────────────────────┤
│                    数据库层 (PostgreSQL)                      │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
│  │ 租户A 数据  │ │ 租户B 数据  │ │ 租户C 数据  │            │
│  │  (Schema)   │ │  (Schema)   │ │  (Schema)   │            │
│  └─────────────┘ └─────────────┘ └─────────────┘            │
├─────────────────────────────────────────────────────────────┤
│                    缓存层 (Redis)                              │
│                    消息队列 (可选)                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 技术栈选择

#### 3.2.1 后端技术栈
- **主语言**: Go (基于 GoFly 框架)
- **Web 框架**: Gin (GoFly 内置)
- **ORM**: GoFly 自研 ORM (gform)
- **数据库**: PostgreSQL
- **缓存**: Redis
- **认证**: JWT

#### 3.2.2 前端技术栈
- **框架**: Next.js 14 (保持现有)
- **语言**: TypeScript (保持现有)
- **UI 组件**: Radix UI + Tailwind CSS (保持现有)
- **状态管理**: Zustand + React Query (保持现有)

### 3.3 多租户实现方案

#### 3.3.1 数据隔离策略
- **方案选择**: Shared Database, Separate Schema
- **优点**: 资源利用率高，维护相对简单
- **实现**: 通过 business_id 字段和数据库 Schema 结合

#### 3.3.2 租户上下文管理
- **中间件**: 在请求处理时自动识别租户
- **数据库连接**: 根据租户 ID 动态切换连接
- **缓存隔离**: 使用租户 ID 作为缓存 key 前缀

## 4. 功能需求

### 4.1 租户管理模块

#### 4.1.1 租户注册流程
1. 用户填写注册信息（公司名称、域名、管理员账号）
2. 系统创建租户和初始数据库 Schema
3. 发送验证邮件
4. 激活租户账户

#### 4.1.2 租户设置
- **基本信息**: 公司名称、Logo、联系方式
- **域名配置**: 自定义域名配置
- **主题设置**: 品牌色彩和 Logo 上传
- **通知设置**: 邮件和系统通知偏好

### 4.2 订阅管理模块

#### 4.2.1 套餐设计
- **免费版**: 有限的 token 数量和功能
- **基础版**: 适中的 token 和基础功能
- **专业版**: 更多 token 和高级功能
- **企业版**: 无限 token 和定制功能

#### 4.2.2 计费功能
- **订阅周期**: 月付、年付选项
- **自动续费**: 到期前提醒和自动续费
- **升级降级**: 支持套餐灵活变更
- **使用统计**: 实时 token 使用量监控

### 4.3 用户管理模块

#### 4.3.1 用户角色
- **超级管理员**: 系统级管理权限
- **租户管理员**: 租户内的所有权限
- **普通用户**: 基本功能使用权限
- **只读用户**: 查看权限

#### 4.3.2 权限控制
- **功能权限**: 控制模块访问
- **数据权限**: 控制数据访问范围
- **操作权限**: 控制具体操作

## 5. 数据库设计

### 5.1 多租户表结构

#### 5.1.1 租户相关表
```sql
-- 租户主表
CREATE TABLE tenants (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    domain VARCHAR(255) UNIQUE,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 租户配置表
CREATE TABLE tenant_configs (
    id BIGSERIAL PRIMARY KEY,
    tenant_id BIGINT REFERENCES tenants(id),
    config_key VARCHAR(100) NOT NULL,
    config_value TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### 5.1.2 现有表改造
所有现有表需要添加 tenant_id 字段：
```sql
ALTER TABLE users ADD COLUMN tenant_id BIGINT REFERENCES tenants(id);
ALTER TABLE subscriptions ADD COLUMN tenant_id BIGINT REFERENCES tenants(id);
-- 其他表类似...
```

### 5.2 数据迁移策略

#### 5.2.1 迁移步骤
1. 创建新表结构（包含 tenant_id）
2. 编写数据迁移脚本
3. 执行数据迁移（在维护窗口）
4. 验证数据完整性
5. 切换到新系统

#### 5.2.2 回滚方案
- 保留原始数据库备份
- 快速回滚脚本准备
- 回滚测试验证

## 6. API 设计

### 6.1 API 版本控制
- **版本前缀**: `/api/v1/`
- **兼容性**: 保持现有 API 兼容
- **废弃策略**: 提前 3 个月通知

### 6.2 租户上下文 API
```go
// 请求头传递租户信息
X-Tenant-ID: 123
// 或 JWT 中包含租户信息
{
  "sub": "user123",
  "tenant_id": "123",
  "roles": ["admin"]
}
```

## 7. 安全设计

### 7.1 数据安全
- **数据隔离**: 确保租户数据完全隔离
- **加密存储**: 敏感数据加密存储
- **访问控制**: 严格的权限验证
- **审计日志**: 记录所有关键操作

### 7.2 网络安全
- **HTTPS**: 全站 HTTPS 加密
- **CORS**: 严格的跨域控制
- **限流**: API 调用频率限制
- **防火墙**: Web 应用防火墙保护

## 8. 性能优化

### 8.1 数据库优化
- **索引设计**: 合理的索引策略
- **查询优化**: 避免 N+1 查询
- **连接池**: 数据库连接池配置
- **读写分离**: 主从数据库配置

### 8.2 缓存策略
- **多级缓存**: 应用缓存 + Redis 缓存
- **缓存预热**: 系统启动时预热热点数据
- **缓存更新**: 合理的缓存失效策略

## 9. 监控和运维

### 9.1 监控指标
- **系统指标**: CPU、内存、磁盘、网络
- **应用指标**: QPS、响应时间、错误率
- **业务指标**: 租户数量、活跃用户、API 调用量

### 9.2 日志管理
- **结构化日志**: JSON 格式日志
- **日志级别**: DEBUG、INFO、WARN、ERROR
- **日志聚合**: 集中日志收集和分析
- **告警机制**: 异常情况自动告警

## 10. 项目里程碑

### Phase 1: 基础架构改造（4 周）
- [ ] GoFly 框架集成
- [ ] 多租户基础架构搭建
- [ ] 数据库设计和迁移脚本
- [ ] 基础 API 开发

### Phase 2: 核心功能迁移（6 周）
- [ ] BatchOpen 功能迁移
- [ ] SiteRank 功能迁移
- [ ] AdsCenter 功能迁移
- [ ] 数据迁移执行

### Phase 3: 增强功能开发（4 周）
- [ ] 订阅管理系统
- [ ] 租户管理后台
- [ ] 报表和分析功能
- [ ] 性能优化

### Phase 4: 测试和上线（2 周）
- [ ] 集成测试
- [ ] 性能测试
- [ ] 安全测试
- [ ] 生产环境部署

## 11. 风险评估

### 11.1 技术风险
- **数据迁移风险**: 迁移过程中数据丢失或损坏
  - 缓解措施：完整备份、分批迁移、验证脚本
- **性能风险**: 多租户架构导致性能下降
  - 缓解措施：性能测试、优化查询、水平扩展

### 11.2 业务风险
- **服务中断**: 重构过程中影响现有用户
  - 缓解措施：分阶段迁移、灰度发布
- **用户流失**: 功能变更导致用户不适应
  - 缓解措施：提前通知、培训文档、客服支持

## 12. 成功标准

### 12.1 技术指标
- 系统响应时间 < 500ms (95%)
- 系统可用性 > 99.9%
- 支持 1000+ 租户并发
- 数据零丢失

### 12.2 业务指标
- 核心功能 100% 兼容
- 新租户注册流程完成率 > 90%
- 用户满意度 > 4.5/5.0
- 系统运维成本降低 30%

## 13. 附录

### 13.1 术语表
- **SaaS**: Software as a Service，软件即服务
- **多租户**: Multiple Tenancy，单个应用实例服务多个客户
- **RBAC**: Role-Based Access Control，基于角色的访问控制
- **Token**: 系统内使用的虚拟货币，用于计费

### 13.2 参考文档
- GoFly 框架文档: https://doc.goflys.cn
- 现有系统架构文档
- 数据库设计文档
- API 文档

### 13.3 相关资源
- 开发团队联系方式
- 测试环境信息
- 部署文档
- 监控系统链接