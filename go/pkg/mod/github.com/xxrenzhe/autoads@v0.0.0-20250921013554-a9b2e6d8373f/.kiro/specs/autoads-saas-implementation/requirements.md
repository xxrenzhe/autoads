# AutoAds SaaS平台重构需求

## 项目概述

哥，这个项目要把Next.js单体应用重构为基于GoFly的Go SaaS多用户系统。

**Linus式核心判断**：
✅ **值得做**：Next.js单体架构确实是垃圾，只能支持1个并发用户，这是真实存在的性能问题
✅ **数据结构优先**：通过user_id字段实现清晰的多用户数据隔离，消除所有租户复杂性
✅ **Never break userspace**：保持所有API接口100%兼容，前端零修改
✅ **实用主义**：直接fork本地gofly_admin_v3/源码，复用成熟组件，不重复造轮子

**关键洞察**：
- **数据结构**：所有业务表加user_id字段，简单直接的用户数据关联
- **复杂度消除**：没有租户概念，没有多级权限，每个用户独立
- **零破坏性**：API路径和响应格式完全不变，用户无感知迁移

## Linus式需求分析

### 需求1：数据结构优先的架构设计

**用户故事：** 作为系统架构师，我要先设计清晰的数据结构，然后基于GoFly框架实现，因为"Bad programmers worry about the code. Good programmers worry about data structures."

#### 验收标准

1. WHEN 设计用户数据结构 THEN 系统应能通过简单的user_id字段关联所有业务数据，消除复杂的租户隔离逻辑
2. WHEN Fork GoFly源码 THEN 系统应能直接扩展gofly_admin_v3/目录，复用CRUD生成器、定时任务调度器等成熟组件，避免重复造轮子
3. WHEN 实现认证系统 THEN 系统应能消除特殊情况：网站用户统一用JWT，管理员统一用Session，没有混合认证
4. WHEN 单进程部署 THEN 系统应能用最简单的方式：Go主进程嵌入Next.js静态文件，一个二进制文件包含所有功能
5. WHEN 保持兼容性 THEN 系统应能确保"Never break userspace"：所有API路径和响应格式100%不变

### 需求2：消除特殊情况的认证系统

**用户故事：** 作为用户，我要用最简单的方式登录系统，因为"好代码没有特殊情况"。

#### 验收标准

1. WHEN 用户认证 THEN 系统应能消除认证复杂性：网站用户只用Google OAuth，管理员只用密码，没有混合模式
2. WHEN 角色管理 THEN 系统应能只有两种角色：user和admin，没有复杂的权限树
3. WHEN 数据隔离 THEN 系统应能通过user_id字段实现最简单的数据关联，每个用户独立，没有租户概念
4. WHEN 会话管理 THEN 系统应能用最直接的方式：JWT for API，Session for Admin，没有特殊情况
5. WHEN 新用户注册 THEN 系统应能自动处理：生成邀请码、分配试用套餐，一步到位

### 需求3：简化到极致的Token系统

**用户故事：** 作为用户，我要用最简单的Token系统，因为"好代码没有特殊情况"。

#### 验收标准

1. WHEN Token设计 THEN 系统应能用最简单的数据结构：用户表直接加token_balance字段，一个交易记录表，没有复杂的钱包概念
2. WHEN Token获取 THEN 系统应能用固定规则：签到10个Token，购买按充值包，邀请固定奖励，没有阶梯和特殊情况
3. WHEN Token消费 THEN 系统应能用固定费率：SiteRank查询1Token(不管缓存)，BatchGo HTTP模式1Token/URL，Puppeteer模式2Token/URL，Chengelink提取1Token+更新3Token/广告
4. WHEN Token过期 THEN 系统应能统一365天过期，没有不同类型的Token，没有优先级消费逻辑
5. WHEN 充值包配置 THEN 系统应能支持标准充值包：¥99=10,000tokens，¥299=50,000tokens，¥599=200,000tokens，¥999=500,000tokens

### 需求4：BatchGo功能迁移

**用户故事：** 作为用户，我需要使用BatchGo功能进行批量URL访问，包括Basic、Silent、AutoClick三种模式，以便满足不同的业务需求。

#### 验收标准

1. WHEN 使用Basic模式 THEN 系统应能支持最多50个URL的window.open批量打开，通过WebSocket通知前端执行，无需浏览器插件
2. WHEN 使用Silent模式 THEN 系统应能支持并发控制的URL批量处理，包括代理轮询、重试机制、智能并发控制
3. WHEN 使用AutoClick模式 THEN 系统应能支持定时任务调度和智能时间分配(24小时智能分配)，实现自动化点击
4. WHEN Token消费 THEN 系统应能按照HTTP访问模式成功访问1个URL消耗1个Token，Puppeteer访问模式成功访问1个URL消耗2个Token的规则计费
5. WHEN API兼容性 THEN 系统应能保持与现有前端100%的API路径和响应格式兼容，包括所有错误码(0成功，1000-1999参数错误等)、分页格式、认证方式

### 需求5：SiteRankGo功能迁移

**用户故事：** 作为用户，我需要使用SiteRankGo功能查询网站排名和流量数据，以便分析竞争对手和市场情况。

#### 验收标准

1. WHEN 单域名查询 THEN 系统应能通过SimilarWeb API获取网站的全球排名、分类、访问量等数据(需验证API可用性)
2. WHEN 批量查询 THEN 系统应能支持多域名批量处理，智能分批(动态调整批次大小5-20)和速率控制
3. WHEN 优先级计算 THEN 系统应能根据排名数据自动计算域名的优先级(High/Medium/Low)
4. WHEN 数据缓存 THEN 系统应能缓存成功查询结果7天，失败查询结果1小时，避免重复API调用，支持缓存击穿防护
5. WHEN Token消费 THEN 系统应能按照成功查询1个域名消耗1个Token的规则计费，不管数据是否来自缓存

### 需求6：Chengelink功能实现

**用户故事：** 作为用户，我需要使用Chengelink功能自动更新Google Ads广告的Final URL，以便提高广告管理效率和准确性。

#### 验收标准

1. WHEN 配置自动化任务 THEN 系统应能支持广告联盟链接、AdsPower环境、Google Ads账号的配置管理
2. WHEN 执行链接提取 THEN 系统应能通过AdsPower浏览器自动访问联盟链接并提取最终URL
3. WHEN 更新Google Ads THEN 系统应能批量更新指定账号下所有广告的Final URL
4. WHEN 监控执行状态 THEN 系统应能提供详细的执行日志、成功率统计、错误信息
5. WHEN Token消费 THEN 系统应能按照链接提取(1 Token)和广告更新(3 Token/广告)规则消费Token

### 需求7：邀请和签到系统

**用户故事：** 作为用户，我需要通过邀请好友获得Pro套餐时长和Token奖励，以及每日签到获得Token奖励，以便降低使用成本并享受更多功能。

#### 验收标准

1. WHEN 用户注册 THEN 系统应能自动生成专属邀请码，直接注册获得14天Pro套餐，通过邀请注册获得30天Pro套餐(不与14天叠加)
2. WHEN 好友通过邀请注册 THEN 系统应能给被邀请用户30天Pro套餐，给邀请者30天Pro套餐(可累加)，同时邀请者和被邀请者各获得固定数量的Token奖励，即时到账
3. WHEN 每日签到 THEN 系统应能给用户固定10个Token奖励，无递增机制，并在日历中显示签到记录
4. WHEN 查看邀请统计 THEN 系统应能显示邀请总数、成功数、获得Pro套餐天数、获得Token奖励等统计信息
5. WHEN 查看签到历史 THEN 系统应能显示本月签到日历和历史签到记录

### 需求8：SaaS个人中心

**用户故事：** 作为用户，我需要一个功能完善的个人中心来管理我的账户信息、订阅状态、Token余额等，以便全面了解和控制我的账户。

#### 验收标准

1. WHEN 访问个人中心 THEN 系统应能显示用户信息、套餐状态、Token余额等核心数据概览，支持标签导航(概览、个人信息、套餐管理、Token明细、邀请好友、每日签到)
2. WHEN 管理个人信息 THEN 系统应能支持用户更新姓名、公司、头像、时区、语言等基本信息
3. WHEN 查看套餐管理 THEN 系统应能显示当前套餐、使用进度、升级建议、订阅历史记录
4. WHEN 查看Token明细 THEN 系统应能显示Token余额、交易记录查询(支持筛选)、消费统计图表、购买入口
5. WHEN 数据实时更新 THEN 系统应能通过简单轮询机制保持数据及时性(用户信息30秒、Token余额30秒、订阅状态30分钟、邀请记录60秒)

### 需求9：性能和安全要求

**用户故事：** 作为系统管理员，我需要确保系统具备良好的性能表现和安全防护，以便为用户提供稳定可靠的服务。

#### 验收标准

1. WHEN 并发访问 THEN 系统应能支持50个并发用户，P95响应时间小于200ms
2. WHEN 数据安全 THEN 系统应能对敏感数据加密存储，实现用户数据隔离
3. WHEN API安全 THEN 系统应能提供请求限流(100次/分钟)、输入验证、CORS配置、JWT Token验证等企业级安全防护
4. WHEN 审计日志 THEN 系统应能记录所有关键操作和安全事件(登录、Token消费、配置变更等)，支持问题追踪
5. WHEN 系统监控 THEN 系统应能提供基础的性能监控(CPU、内存、响应时间)和错误告警机制

### 需求10：WebSocket实时通信

**用户故事：** 作为用户，我需要实时获得任务进度更新和系统通知，特别是BatchGo Basic模式需要前端配合执行window.open操作，以便实现无插件的批量URL打开功能。

#### 验收标准

1. WHEN BatchGo Basic模式执行 THEN 系统应能通过WebSocket通知前端执行window.open操作，因为Go后端无法直接操作浏览器标签页
2. WHEN 任务进度更新 THEN 系统应能通过WebSocket实时推送任务状态、进度百分比、成功失败统计
3. WHEN 系统通知 THEN 系统应能推送重要通知(任务完成、Token不足、套餐过期等)
4. WHEN 连接管理 THEN 系统应能支持用户认证、连接保持、断线重连等基础功能
5. WHEN 消息格式 THEN 系统应能使用统一的JSON消息格式，包含type、data等标准字段

### 需求11：后台管理系统

**用户故事：** 作为系统管理员，我需要一个功能完善的后台管理系统来管理用户、Token、套餐、API等，以便有效运营SaaS平台。

#### 验收标准

1. WHEN 数据面板 THEN 系统应能展示用户、Token、任务、收入等关键指标的实时趋势图
2. WHEN 用户管理 THEN 系统应能管理用户档案、禁用用户、手动充值Token、更改套餐
3. WHEN 套餐管理 THEN 系统应能热更新配置和修改不同套餐的功能权限及参数限制
4. WHEN Token管理 THEN 系统应能配置充值包价格、热更新Token消耗规则、查看邀请排行榜和签到记录
5. WHEN API管理 THEN 系统应能查看API列表、监控访问次数和响应耗时、管理通知模板和触发条件

### 需求12：部署和运维

**用户故事：** 作为运维工程师，我需要简单高效的部署方案和运维工具，以便快速部署系统并保持稳定运行。

#### 验收标准

1. WHEN 容器化部署 THEN 系统应能通过Docker单进程部署，Go主进程嵌入Next.js静态文件，支持健康检查
2. WHEN CI/CD流程 THEN 系统应能通过GitHub Actions自动构建镜像(main分支→preview-latest，production分支→prod-latest)
3. WHEN 数据备份 THEN 系统应能提供MySQL数据库的定期备份(保留30天)和恢复方案
4. WHEN 日志管理 THEN 系统应能提供结构化日志记录(JSON格式)和基础的日志收集
5. WHEN 环境配置 THEN 系统应能支持预发(urlchecker.dev)和生产(autoads.dev)环境的差异化配置管理

## 成功标准

1. **功能完整性**：所有BatchGo、SiteRankGo、Chengelink功能100%迁移成功
2. **API兼容性**：前端无需修改，所有API接口保持完全兼容
3. **性能达标**：支持50并发用户，P95响应时间<200ms
4. **用户体验**：Google一键登录，完整的SaaS用户体验
5. **系统稳定**：单进程部署，运维简单，错误率<0.1%

## 约束条件

1. **技术约束**：必须基于GoFly Admin V3框架，需要验证框架的实际能力和集成可行性
2. **兼容性约束**：必须保持与现有前端的完全兼容，API路径和响应格式100%一致
3. **性能约束**：不能降低现有系统的性能表现，目标P95<200ms需要实际测试验证
4. **安全约束**：必须满足企业级安全要求，包括数据加密、访问控制、审计日志
5. **验证约束**：SimilarWeb API集成需要验证API可用性、费用和调用限制
6. **时间约束**：整体实施周期控制在3周内

## 验收标准

1. **完整性**：覆盖所有15个需求文档中的功能点
2. **准确性**：严格按照需求文档的规格实现
3. **可操作性**：提供具体的实施步骤和验证方法
4. **可维护性**：代码结构清晰，遵循最佳实践
5. **可扩展性**：为未来功能扩展预留接口和架构空间