# AutoAds SaaS平台实施任务

## 任务概述

基于Linus的"数据结构优先"和"实用主义"原则，将AutoAds从Next.js单体应用重构为基于GoFly的多用户SaaS平台。遵循"Never break userspace"铁律，保持API 100%兼容。

## 实施任务

- [x] 1. 项目基础设置和GoFly集成
  - Fork本地gofly_admin_v3/源码，创建autoads-saas分支
  - 配置开发环境，验证GoFly框架基础功能
  - 设置数据库连接和Redis缓存配置
  - 验证GoFly的CRUD生成器、定时任务调度器等核心组件可用性
  - _Requirements: 1.2, 1.4_

- [x] 2. 数据结构优先的用户模型设计
  - 扩展GoFly的User模型，添加email、google_id、token_balance、plan、invite_code等SaaS必需字段
  - 创建TokenTransaction模型记录Token变动历史
  - 创建Invitation和CheckinRecord模型支持邀请和签到功能
  - 实现数据库自动迁移，确保所有表结构正确创建
  - _Requirements: 1.1, 3.1_

- [x] 3. 消除特殊情况的认证系统
  - 实现Google OAuth集成，支持用户一键登录注册
  - 扩展GoFly认证中间件支持JWT Token验证
  - 实现用户数据隔离中间件，确保通过user_id字段隔离用户数据
  - 创建统一的认证处理器，消除混合认证模式
  - _Requirements: 2.1, 2.2, 2.4_

- [x] 4. 简化到极致的Token系统
  - 实现Token服务，支持余额查询、消费、充值等核心功能
  - 创建Token交易记录系统，记录所有Token变动
  - 实现Token消费规则：SiteRank查询1Token，BatchGo HTTP模式1Token/URL，Puppeteer模式2Token/URL
  - 集成充值包配置：¥99=10,000tokens，¥299=50,000tokens等标准套餐
  - _Requirements: 3.1, 3.2, 3.3, 3.5_

- [x] 5. BatchGo功能迁移和API兼容
  - 创建BatchTask数据模型，支持Basic、Silent、AutoClick三种模式
  - 实现Silent模式：并发控制的URL批量处理，包括代理轮询、重试机制
  - 实现AutoClick模式：定时任务调度和智能时间分配
  - 实现Basic模式：通过WebSocket通知前端执行window.open操作
  - 确保API路径完全兼容：/api/batchopen/silent-start等现有接口
  - _Requirements: 4.1, 4.2, 4.3, 4.5_

- [x] 6. SiteRankGo功能迁移和SimilarWeb集成
  - 创建SiteRankQuery数据模型，支持域名查询和结果缓存
  - 集成SimilarWeb API，实现网站排名、流量数据获取
  - 实现智能批量查询：动态调整批次大小5-20，速率控制
  - 实现优先级计算：根据排名数据和流量数据自动计算High/Medium/Low优先级
  - 实现缓存策略：成功查询结果7天，失败查询结果1小时
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [x] 7. Chengelink功能实现
  - 创建ChengeLinkTask数据模型，支持链接提取和Google Ads更新任务
  - 实现AdsPower浏览器集成，自动访问联盟链接并提取最终URL
  - 实现Google Ads API集成，批量更新指定账号下所有广告的Final URL
  - 实现执行状态监控：详细的执行日志、成功率统计、错误信息
  - 实现Token消费：链接提取1Token，广告更新3Token/广告
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 8. 邀请和签到系统实现
  - 实现邀请码生成：用户注册时自动生成专属邀请码
  - 实现邀请奖励机制：被邀请用户获得30天Pro套餐，邀请者获得30天Pro套餐和Token奖励
  - 实现每日签到功能：固定10个Token奖励，无递增机制
  - 创建签到日历显示：本月签到记录和历史统计
  - 实现邀请统计：邀请总数、成功数、获得Pro套餐天数等
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 9. SaaS个人中心开发
  - 基于GoFly Admin界面创建用户个人中心
  - 实现标签导航：概览、个人信息、套餐管理、Token明细、邀请好友、每日签到
  - 实现用户信息管理：姓名、公司、头像、时区、语言等基本信息更新
  - 实现套餐管理：当前套餐显示、使用进度、升级建议、订阅历史
  - 实现Token明细：余额显示、交易记录查询、消费统计图表、购买入口
  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 10. WebSocket实时通信系统
  - 实现WebSocket服务，支持用户连接管理和消息推送
  - 实现BatchGo Basic模式WebSocket通知：发送window.open指令给前端
  - 实现任务进度实时推送：任务状态、进度百分比、成功失败统计
  - 实现系统通知推送：任务完成、Token不足、套餐过期等重要通知
  - 实现连接管理：用户认证、连接保持、断线重连等基础功能
  - _Requirements: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 11. 后台管理系统开发
  - 基于GoFly Admin创建SaaS管理后台
  - 实现数据面板：用户、Token、任务、收入等关键指标的实时趋势图
  - 实现用户管理：用户档案查看、禁用用户、手动充值Token、更改套餐
  - 实现套餐管理：热更新配置、修改不同套餐的功能权限及参数限制
  - 实现Token管理：配置充值包价格、热更新Token消耗规则、查看邀请排行榜
  - _Requirements: 11.1, 11.2, 11.3, 11.4, 11.5_

- [x] 12. 性能优化和安全加固
  - 实现数据库查询优化：为常用查询字段建立索引，优化慢查询
  - 实现缓存策略：用户信息、Token余额、SiteRank结果等多级缓存
  - 实现请求限流：100次/分钟的API访问限制，防止滥用
  - 实现数据加密：敏感数据加密存储，JWT Token安全验证
  - 实现审计日志：记录所有关键操作和安全事件
  - _Requirements: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 13. 系统监控和健康检查
  - 实现健康检查接口：数据库、Redis连接状态检查
  - 实现性能监控：CPU、内存、响应时间等系统指标收集
  - 实现业务监控：用户活跃度、Token消耗量、订阅转化率等业务指标
  - 实现错误告警：系统异常、性能瓶颈的自动告警机制
  - 实现结构化日志：JSON格式日志记录，支持日志收集和分析
  - _Requirements: 9.5, 12.4_

- [x] 14. 部署和运维配置
  - 创建Docker单镜像：单进程部署，Go主进程嵌入Next.js静态文件
  - 配置CI/CD流程：GitHub Actions自动构建镜像
  - 部署流程详见 MustKnow.md
  - 在目前 Dockerfile.standalone 的基础上进行改造，实现重构后架构的Dockerfile
  - 配置环境管理：预发(urlchecker.dev)和生产(autoads.dev)环境差异化配置
  - 实现健康检查和自动重启机制
  - _Requirements: 12.1, 12.2, 12.3, 12.5_

- [x] 15. 全面测试和验证
  - 执行API兼容性测试：确保所有现有API路径和响应格式100%兼容
  - 执行功能完整性测试：BatchGo、SiteRankGo、Chengelink功能100%迁移验证
  - 执行性能测试：50并发用户测试，P95响应时间<200ms验证
  - 执行安全测试：用户数据隔离、Token消费准确性、认证授权验证
  - 执行端到端测试：完整用户流程测试，从注册到使用所有功能
  - _Requirements: 所有需求的验收标准_

- [x] 16. 集成GoFly成熟功能模块
  - 集成邮件系统：用户注册欢迎邮件、套餐到期提醒、Token不足通知等邮件模板
  - 集成文件上传系统：用户头像上传、文件管理界面、自动缩略图生成
  - 集成审计日志系统：完整的用户操作审计、安全事件监控、管理员操作记录
  - 集成监控系统：Prometheus指标收集、健康检查、业务指标监控
  - 集成API文档生成：自动生成Swagger文档、Redoc交互式文档、Postman集合
  - _Requirements: 充分利用GoFly现有成熟功能，提升系统完整性_

- [x] 17. 用户体验优化功能
  - 充分利用GoFly现有成熟功能，不要重复造轮子
  - 集成Excel导出系统：用户数据导出、任务记录导出、Token交易记录一键导出Excel
  - 集成国际化系统：支持中英文切换，提升海外用户体验
  - 集成验证码系统：图片验证码、邮箱验证码，增强登录和敏感操作安全性
  - 集成数据字典系统：套餐类型、任务状态、优先级等配置项的动态管理
  - 集成多媒体处理：用户上传视频自动生成封面图，图片自动优化
  - _Requirements: 提升用户体验，从"好用"升级为"超好用"_

- [x] 18. 高级功能扩展
  - 充分利用GoFly现有成熟功能，不要重复造轮子
  - 集成插件系统：支持第三方集成插件、功能扩展机制、事件总线
  - 优化限流系统：基于套餐的精细化限流、用户使用分析、热更新配置
  - 集成工具库：充分利用GoFly的50+工具模块，提升开发效率
  - 实现通知系统：邮件通知、系统消息、WebSocket实时通知的统一管理
  - 完善安全系统：操作审计、异常检测、安全报告生成
  - _Requirements: 构建企业级SaaS平台的完整功能生态_

- [x] 19. 代码清理和文档完善
  - 执行Linus式代码清理：删除所有废弃文件、调试代码、TODO注释
  - 统一代码风格：运行go fmt、go vet等代码质量检查工具
  - 清理项目结构：删除空文件和空目录，保持项目整洁
  - 完善部署文档：包含完整的部署步骤、配置说明、故障排除指南
  - 验证系统稳定性：确保错误率<0.1%，系统可用性99.9%
  - _Requirements: 成功标准和验收标准_

## 关键里程碑

1. **Phase 1完成**：GoFly集成和基础用户系统（任务1-4）
2. **Phase 2完成**：核心业务功能迁移（任务5-7）
3. **Phase 3完成**：SaaS功能和管理系统（任务8-11）
4. **Phase 4完成**：性能优化和部署准备（任务12-14）
5. **Phase 5完成**：全面测试和验证（任务15）
6. **Phase 6完成**：成熟功能集成（任务16）
7. **Phase 7完成**：用户体验优化和高级扩展（任务17-18）
8. **最终验收**：代码清理和文档完善（任务19）

## 验收标准

- **功能完整性**：所有BatchGo、SiteRankGo、Chengelink功能100%迁移成功
- **API兼容性**：前端无需修改，所有API接口保持完全兼容
- **性能达标**：支持50并发用户，P95响应时间<200ms
- **用户体验**：Google一键登录，完整的SaaS用户体验
- **系统稳定**：单进程部署，运维简单，错误率<0.1%
- **代码质量**：遵循Linus原则，代码整洁无垃圾，易于维护