# Token消耗记录管理系统 - 需求规范

## 项目概述

基于现有的TokenUsage和TokenConfig模型，完善Token消耗记录管理功能，实现用户个人中心的消耗记录查看和后台管理系统的Token消耗配置管理。重点解决批量操作记录过多的问题，并提供灵活的Token消耗配置管理。

## 核心需求

### 需求1: 用户个人中心 - Token消耗记录优化

**用户故事**: 作为用户，我希望能够查看我的Token消耗记录，特别是批量操作能够合并显示，避免记录过多影响查看体验。

#### 验收标准

1. WHEN 用户访问个人中心Token页面 THEN 系统应显示Token消耗历史记录
2. WHEN 用户执行批量操作 THEN 系统应将同一批次的操作合并为一条记录显示
3. WHEN 显示批量操作记录 THEN 系统应显示批次总数、总消耗Token数和操作详情
4. WHEN 用户查看消耗记录 THEN 系统应按时间倒序排列，支持分页加载
5. WHEN 用户需要筛选记录 THEN 系统应支持按功能类型、时间范围筛选
6. WHEN 用户查看单条记录 THEN 系统应显示：时间、功能类型、消耗数量、操作详情、剩余余额

### 需求2: 批量操作记录合并逻辑

**用户故事**: 作为用户，当我执行批量查询操作时，我希望看到的是合并后的记录，而不是每个单独操作的记录。

#### 验收标准

1. WHEN 用户执行批量SiteRank查询 THEN 系统应创建一条包含所有域名的合并记录
2. WHEN 用户执行批量BatchOpen操作 THEN 系统应创建一条包含所有URL的合并记录
3. WHEN 用户执行批量AdsCenter操作 THEN 系统应创建一条包含所有链接的合并记录
4. WHEN 显示批量记录 THEN 系统应显示格式："批量[功能名] - [数量]个操作，消耗[总数]个Token"
5. WHEN 用户点击批量记录详情 THEN 系统应显示具体的操作列表和每个操作的详情

### 需求3: 后台管理系统 - Token消耗配置

**用户故事**: 作为管理员，我希望能够灵活配置不同功能的Token消耗规则，并能查看配置变更历史。

#### 验收标准

1. WHEN 管理员访问Token配置页面 THEN 系统应显示所有功能的当前Token消耗配置
2. WHEN 管理员修改Token消耗配置 THEN 系统应验证输入并实时生效
3. WHEN 配置发生变更 THEN 系统应记录变更历史，包括变更人、时间、原因
4. WHEN 管理员查看配置历史 THEN 系统应显示所有配置变更记录
5. WHEN 配置变更后 THEN 系统应立即应用新的消耗规则到后续操作
6. WHEN 管理员批量更新配置 THEN 系统应支持批量操作并确保数据一致性

### 需求4: 默认Token消耗规则

**用户故事**: 作为系统，我需要有明确的默认Token消耗规则，确保功能正常运行。

#### 验收标准

1. WHEN 系统初始化 THEN 应设置SiteRank查询每个域名消耗1个Token
2. WHEN 系统初始化 THEN 应设置BatchOpen访问每个URL消耗1个Token  
3. WHEN 系统初始化 THEN 应设置AdsCenter更换每个链接消耗2个Token
4. WHEN 添加新功能 THEN 管理员应能够为新功能配置Token消耗规则
5. WHEN 功能被禁用 THEN 对应的Token配置应能够被停用但保留历史记录

## 技术需求

### 数据库增强

1. **TokenUsage表优化**
   - 添加batchId字段用于标识批量操作
   - 添加isBatch字段标识是否为批量操作记录
   - 优化索引结构提升查询性能

2. **TokenConfig表完善**
   - 确保支持feature和action的组合配置
   - 添加配置变更历史追踪
   - 支持配置的启用/禁用状态

### API设计

1. **用户端API**
   - `GET /api/user/tokens/usage` - 获取消耗记录（支持批量合并）
   - `GET /api/user/tokens/stats` - 获取消耗统计和图表数据

2. **管理端API**
   - `GET /api/admin/token-config` - 获取Token配置列表
   - `PUT /api/admin/token-config` - 更新Token配置
   - `GET /api/admin/token-config/history` - 获取配置变更历史

### 前端组件

1. **用户个人中心**
   - TokenUsageHistory组件 - 消耗记录列表
   - TokenUsageStats组件 - 消耗统计图表
   - BatchOperationDetail组件 - 批量操作详情

2. **后台管理系统**
   - TokenConfigManagement组件 - Token配置管理
   - TokenConfigHistory组件 - 配置变更历史

## 性能要求

- Token消耗记录查询响应时间 < 500ms
- 批量操作记录合并处理时间 < 200ms
- 配置变更实时生效时间 < 100ms
- 支持大量历史记录的高效分页

## 安全要求

- 用户只能查看自己的消耗记录
- 管理员权限严格验证
- 配置变更操作完整审计
- 防止恶意配置修改和Token滥用

## 用户体验要求

- 直观的批量操作合并显示
- 清晰的消耗记录时间线
- 友好的配置管理界面
- 实时的配置变更反馈
- 响应式设计支持移动端

## 验收标准

### 功能验收
- [ ] 用户可以查看合并后的Token消耗记录
- [ ] 批量操作正确合并显示，避免记录过多
- [ ] 管理员可以配置和修改Token消耗规则
- [ ] 配置变更实时生效并有完整审计
- [ ] 所有API功能正常，性能符合要求

### 性能验收
- [ ] 页面加载和查询响应时间符合要求
- [ ] 大量历史记录处理正常
- [ ] 批量操作合并逻辑高效

### 安全验收
- [ ] 权限控制严格有效
- [ ] 数据访问安全隔离
- [ ] 操作审计记录完整

## 实施优先级

### 高优先级
1. 批量操作记录合并逻辑
2. 用户Token消耗记录页面
3. Token配置管理基础功能

### 中优先级
1. 配置变更历史和审计
2. 消耗统计和图表展示
3. 高级筛选和搜索功能

### 低优先级
1. 数据导出功能
2. 高级分析和报表
3. 移动端优化