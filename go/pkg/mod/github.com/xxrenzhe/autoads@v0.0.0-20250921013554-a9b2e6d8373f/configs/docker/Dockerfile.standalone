# ç®€åŒ–çš„å¤šç¯å¢ƒ Dockerfile for Next.js
# éµå¾ªç®€å•å®ç”¨åŸåˆ™ï¼Œæ”¯æŒ2C4Gç¯å¢ƒ

FROM node:22-alpine AS base

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    libc6-compat \
    curl \
    bash \
    # Chrome dependencies for Puppeteer
    chromium \
    nss \
    freetype \
    harfbuzz \
    ca-certificates \
    ttf-freefont \
    && rm -rf /var/cache/apk/*

WORKDIR /app

# ä¾èµ–å®‰è£…é˜¶æ®µ
FROM base AS deps

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package.json package-lock.json ./

# ä¼˜åŒ–npmé…ç½®ä»¥åŠ é€Ÿå®‰è£…
RUN npm config set registry https://registry.npmjs.org/ && \
    npm config set cache /tmp/.npm && \
    npm config set prefer-offline true && \
    npm config set maxsockets 20

# å®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆå†…å­˜ä¼˜åŒ–ï¼‰
ENV NODE_OPTIONS="--max-old-space-size=1024"
RUN npm ci --only=production --no-audit --no-fund --prefer-offline

# æ„å»ºé˜¶æ®µ
FROM base AS builder

# ä¼˜åŒ–npmé…ç½®
RUN npm config set registry https://registry.npmjs.org/ && \
    npm config set cache /tmp/.npm && \
    npm config set prefer-offline true && \
    npm config set maxsockets 20

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬devDependenciesç”¨äºæ„å»ºï¼‰
COPY package.json package-lock.json ./
RUN npm ci --no-audit --no-fund --prefer-offline

# å…ˆå¤åˆ¶Prisma schemaä»¥åˆ©ç”¨ç¼“å­˜
COPY prisma ./prisma

# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯ï¼ˆåˆ©ç”¨ç¼“å­˜ï¼‰
RUN npx prisma generate

# å¤åˆ¶æºä»£ç ï¼ˆæ”¾åœ¨Prismaä¹‹åä»¥ä¼˜åŒ–ç¼“å­˜ï¼‰
COPY . .

# è¿è¡Œå®‰å…¨æ£€æŸ¥ï¼ˆç®€å•å®ç”¨åŸåˆ™ï¼‰
RUN echo "ğŸ” è¿è¡Œå®‰å…¨æ£€æŸ¥..." && \
    chmod +x scripts/security-check.sh && \
    ./scripts/security-check.sh

# é…ç½®ç³»ç»Ÿä¼˜åŒ–éƒ¨ç½²
# æ³¨æ„ï¼šæ„å»ºé˜¶æ®µæ‰§è¡Œè¿ç§»éœ€è¦æ•°æ®åº“è¿æ¥ï¼Œä»…åœ¨ CI/CD ç¯å¢ƒä¸­æ‰§è¡Œ
ARG RUN_CONFIG_MIGRATION=false

RUN if [ "$RUN_CONFIG_MIGRATION" = "true" ]; then \
    echo "ğŸš€ å¼€å§‹é…ç½®ç³»ç»Ÿä¼˜åŒ–éƒ¨ç½²..." && \
    # æ£€æŸ¥æ•°æ®åº“è¿æ¥ \
    if [ -n "$DATABASE_URL" ]; then \
        echo "ğŸ—„ï¸ æ‰§è¡Œæ•°æ®åº“è¿ç§»..." && \
        # é¦–å…ˆå°è¯•è¿ç§»ï¼Œå¤±è´¥åˆ™ä½¿ç”¨ db push \
        npx prisma migrate deploy || npx prisma db push --accept-data-loss && \
        echo "ğŸ“‹ æ‰§è¡Œé…ç½®æ•°æ®è¿ç§»..." && \
        npx tsx scripts/migrate-configs.ts && \
        echo "âœ… é…ç½®ç³»ç»Ÿä¼˜åŒ–éƒ¨ç½²å®Œæˆ"; \
    else \
        echo "âš ï¸  DATABASE_URLæœªè®¾ç½®ï¼Œè·³è¿‡æ„å»ºæ—¶è¿ç§»"; \
        echo "ğŸ’¡ è¿ç§»å°†åœ¨å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ"; \
    fi; \
else \
    echo "â„¹ï¸  æ„å»ºæ—¶è·³è¿‡é…ç½®è¿ç§»ï¼ˆRUN_CONFIG_MIGRATION=falseï¼‰"; \
    echo "ğŸ’¡ è¿ç§»å°†åœ¨å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ"; \
fi

# æ„å»ºåº”ç”¨ï¼ˆæ”¯æŒå¤šç¯å¢ƒï¼‰
ARG NEXT_PUBLIC_DEPLOYMENT_ENV=preview
ARG NEXT_PUBLIC_DOMAIN=urlchecker.dev

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV NEXT_PUBLIC_DEPLOYMENT_ENV=${NEXT_PUBLIC_DEPLOYMENT_ENV}
ENV NEXT_PUBLIC_DOMAIN=${NEXT_PUBLIC_DOMAIN}

# æ„å»ºé˜¶æ®µéœ€è¦æ›´å¤šå†…å­˜
ENV NODE_OPTIONS="--max-old-space-size=2048"

RUN npm run build

# ç”Ÿäº§è¿è¡Œé˜¶æ®µ
FROM base AS runner

# å®‰è£…sudoå¹¶åˆ›å»ºérootç”¨æˆ·
RUN apk add --no-cache sudo && \
    addgroup -g 1001 -S nodejs && \
    adduser -u 1001 -S nextjs -G nodejs && \
    echo "nextjs ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

WORKDIR /app

# å¤åˆ¶ç”Ÿäº§ä¾èµ–
COPY --from=deps /app/node_modules ./node_modules

# ç¡®ä¿node_modulesç›®å½•æœ‰æ­£ç¡®çš„æƒé™
RUN chown -R nextjs:nodejs /app/node_modules

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
COPY --from=builder --chown=nextjs:nodejs /app/public ./public

# å¤åˆ¶ Prisma æ–‡ä»¶å’Œè„šæœ¬
COPY --from=builder --chown=nextjs:nodejs /app/prisma ./prisma
COPY --from=builder --chown=nextjs:nodejs /app/package.json ./
COPY --from=builder --chown=nextjs:nodejs /app/scripts ./scripts

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆ2C4Gä¼˜åŒ–ï¼‰
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"
# Puppeteer/Chrome ä»£ç†ç›¸å…³ç¯å¢ƒå˜é‡
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

# å†…å­˜ä¼˜åŒ–é…ç½®
# 4Gå®¹å™¨: 2048MBå †å†…å­˜ (50%è§„åˆ™)
# 2Gå®¹å™¨: 1024MBå †å†…å­˜ (50%è§„åˆ™)  
ENV NODE_OPTIONS="--max-old-space-size=2048 --max-semi-space-size=128"
ENV MEMORY_OPTIMIZED=true

# ç¦ç”¨è¿è¡Œæ—¶Prismaç”Ÿæˆï¼ˆä½¿ç”¨æ„å»ºæ—¶ç”Ÿæˆçš„å®¢æˆ·ç«¯ï¼‰
ENV PRISMA_GENERATE_SKIP_RUNTIME=true

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER nextjs

# æš´éœ²ç«¯å£
EXPOSE 3000

# ç®€åŒ–çš„å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:3000/api/health || exit 1

# ä½¿ç”¨ä¼˜åŒ–çš„å¯åŠ¨è„šæœ¬
CMD ["./scripts/optimized-start.sh"]