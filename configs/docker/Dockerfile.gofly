# GoFly Admin V3 + Next.js å¤šæ¶æ„ Dockerfile
# æ”¯æŒ Go åç«¯å’Œ Next.js å‰ç«¯çš„è”åˆæ„å»º
# éµå¾ªç®€å•å®ç”¨åŸåˆ™ï¼Œæ”¯æŒ2C4Gç¯å¢ƒ

# Go æ„å»ºé˜¶æ®µ
FROM golang:1.21-alpine AS go-builder

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    git \
    build-base \
    tzdata

WORKDIR /go/src/app

# å¤åˆ¶ Go mod æ–‡ä»¶
COPY gofly_admin_v3/go.mod gofly_admin_v3/go.sum ./

# ä¸‹è½½ä¾èµ–
RUN go mod download

# å¤åˆ¶ Go æºä»£ç 
COPY gofly_admin_v3/ .

# æ„å»º Go åº”ç”¨
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

# Next.js åŸºç¡€é•œåƒ
FROM node:22-alpine AS base

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    libc6-compat \
    curl \
    bash \
    # Chrome dependencies for Puppeteer
    chromium \
    nss \
    freetype \
    harfbuzz \
    ca-certificates \
    ttf-freefont \
    && rm -rf /var/cache/apk/*

WORKDIR /app

# ä¾èµ–å®‰è£…é˜¶æ®µ
FROM base AS deps

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package.json package-lock.json ./

# ä¼˜åŒ–npmé…ç½®ä»¥åŠ é€Ÿå®‰è£…
RUN npm config set registry https://registry.npmjs.org/ && \
    npm config set cache /tmp/.npm && \
    npm config set prefer-offline true && \
    npm config set maxsockets 20

# å®‰è£…ç”Ÿäº§ä¾èµ–ï¼ˆå†…å­˜ä¼˜åŒ–ï¼‰
ENV NODE_OPTIONS="--max-old-space-size=1024"
RUN npm ci --only=production --no-audit --no-fund --prefer-offline

# æ„å»ºé˜¶æ®µ
FROM base AS builder

# ä¼˜åŒ–npmé…ç½®
RUN npm config set registry https://registry.npmjs.org/ && \
    npm config set cache /tmp/.npm && \
    npm config set prefer-offline true && \
    npm config set maxsockets 20

# å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬devDependenciesç”¨äºæ„å»ºï¼‰
COPY package.json package-lock.json ./
RUN npm ci --no-audit --no-fund --prefer-offline

# å¤åˆ¶ Prisma schema
COPY prisma ./prisma

# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
RUN npx prisma generate

# å¤åˆ¶æºä»£ç 
COPY . .

# è¿è¡Œå®‰å…¨æ£€æŸ¥
RUN echo "ğŸ” è¿è¡Œå®‰å…¨æ£€æŸ¥..." && \
    chmod +x scripts/security-check.sh && \
    ./scripts/security-check.sh

# æ„å»ºåº”ç”¨
ARG NEXT_PUBLIC_DEPLOYMENT_ENV=preview
ARG NEXT_PUBLIC_DOMAIN=urlchecker.dev

ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV NEXT_PUBLIC_DEPLOYMENT_ENV=${NEXT_PUBLIC_DEPLOYMENT_ENV}
ENV NEXT_PUBLIC_DOMAIN=${NEXT_PUBLIC_DOMAIN}

ENV NODE_OPTIONS="--max-old-space-size=2048"
RUN npm run build

# ç”Ÿäº§è¿è¡Œé˜¶æ®µ
FROM alpine:3.19 AS runner

# å®‰è£…å¿…è¦çš„è¿è¡Œæ—¶ä¾èµ–
RUN apk add --no-cache \
    ca-certificates \
    tzdata \
    curl \
    bash \
    # Chromium for Puppeteer
    chromium \
    nss \
    freetype \
    harfbuzz \
    ttf-freefont \
    && rm -rf /var/cache/apk/*

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S appgroup && \
    adduser -u 1001 -S appuser -G appgroup

WORKDIR /app

# å¤åˆ¶ Go åº”ç”¨
COPY --from=go-builder /go/src/app/main ./main
COPY --from=go-builder /go/src/app/resource ./resource

# å¤åˆ¶ Next.js ç”Ÿäº§ä¾èµ–
COPY --from=deps /app/node_modules ./node_modules

# å¤åˆ¶ Next.js æ„å»ºäº§ç‰©
COPY --from=builder --chown=appuser:appgroup /app/.next/standalone ./
COPY --from=builder --chown=appuser:appgroup /app/.next/static ./.next/static
COPY --from=builder --chown=appuser:appgroup /app/public ./public

# å¤åˆ¶ Prisma æ–‡ä»¶å’Œè„šæœ¬
COPY --from=builder --chown=appuser:appgroup /app/prisma ./prisma
COPY --from=builder --chown=appuser:appgroup /app/package.json ./
COPY --from=builder --chown=appuser:appgroup /app/scripts ./scripts

# ç¡®ä¿æ­£ç¡®çš„æ–‡ä»¶æƒé™
RUN chown -R appuser:appgroup /app && \
    chmod +x ./main && \
    chmod +x ./scripts/optimized-start.sh

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"
ENV GO_ENV=production
ENV GO_APP_PORT=8080

# Puppeteer/Chrome ä»£ç†ç›¸å…³ç¯å¢ƒå˜é‡
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

# å†…å­˜ä¼˜åŒ–é…ç½®
ENV NODE_OPTIONS="--max-old-space-size=2048 --max-semi-space-size=128"
ENV GOGC=25

# ç¦ç”¨è¿è¡Œæ—¶Prismaç”Ÿæˆ
ENV PRISMA_GENERATE_SKIP_RUNTIME=true

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8888

# å¥åº·æ£€æŸ¥æŒ‡å‘ Go æœåŠ¡
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8888/api/health || exit 1

# ç›´æ¥å¯åŠ¨ Go æœåŠ¡ï¼ˆAPI + é™æ€å›é€€ï¼‰
CMD ["./main", "-host", "0.0.0.0", "-port", "8888"]
