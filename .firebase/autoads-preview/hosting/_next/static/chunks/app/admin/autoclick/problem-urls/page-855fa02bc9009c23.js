(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1193],{303:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>u});var a=s(54568),l=s(7620),n=s(41196),i=s(58482),c=s(73297),r=s(87606),o=s(16258),d=s(33279);function u(){var e,t;let[s,u]=(0,l.useState)(""),[h,x]=(0,l.useState)(""),[p,m]=(0,l.useState)(1),{data:j,isLoading:y}=function(){let{q:e="",userId:t="",page:s=1,limit:a=20}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(0,c.I)({queryKey:["admin","autoclick","problem-urls",e,t,s,a],queryFn:async()=>{var l;let n=new URLSearchParams;e&&n.set("q",e),t&&n.set("userId",t),n.set("page",String(s)),n.set("limit",String(a));let i=await (0,d.uC)("/ops/api/v1/console/autoclick/url-failures?".concat(n));if(!i.ok)return{rows:[],total:0};let c=await i.json(),r=(null==c?void 0:c.data)||[],o=(null==c||null==(l=c.pagination)?void 0:l.total)||r.length;return{rows:r,total:o}},staleTime:3e4})}({q:s,userId:h,page:p,limit:20}),{preferBrowser:b,resetCounters:N,remove:g}=function(){let e=(0,r.jE)(),t=()=>e.invalidateQueries({queryKey:["admin","autoclick","problem-urls"]}),s=(0,o.n)({mutationFn:async e=>{let t=await (0,d.uC)("/ops/api/v1/console/autoclick/url-failures/".concat(e,"/prefer_browser"),{method:"POST"});if(!t.ok)throw Error("failed to prefer browser");return t.json().catch(()=>({}))},onSuccess:t});return{preferBrowser:s,resetCounters:(0,o.n)({mutationFn:async e=>{let t=await (0,d.uC)("/ops/api/v1/console/autoclick/url-failures/".concat(e,"/reset_counters"),{method:"POST"});if(!t.ok)throw Error("failed to reset counters");return t.json().catch(()=>({}))},onSuccess:t}),remove:(0,o.n)({mutationFn:async e=>{let t=await (0,d.uC)("/ops/api/v1/console/autoclick/url-failures/".concat(e),{method:"DELETE"});if(!t.ok)throw Error("failed to delete");return t.json().catch(()=>({}))},onSuccess:t})}}(),f=function(){let e=(0,r.jE)();return(0,o.n)({mutationFn:async e=>{let{ids:t,op:s}=e,a=await (0,d.uC)("/ops/api/v1/console/autoclick/url-failures/batch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:t,op:s})});if(!a.ok)throw Error("batch op failed");return a.json().catch(()=>({}))},onSuccess:()=>e.invalidateQueries({queryKey:["admin","autoclick","problem-urls"]})})}(),[v,k]=(0,l.useState)([]),[w,C]=(0,l.useState)(null),[S,B]=(0,l.useState)(""),[P,T]=(0,l.useState)(!1),[E,O]=(0,l.useState)(!1),[U,F]=(0,l.useState)(null),[L,_]=(0,l.useState)(""),R=async e=>{T(!0),O(!0),F(null),_(e);try{let t=await fetch("/api/executor/puppeteer",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e,waitUntil:"domcontentloaded",timeoutMs:2e4,screenshot:!0,fullPage:!1})}),s=await t.json();F(s)}catch(e){F({ok:!1,error:"diagnosis failed"})}O(!1)},q=e=>k(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e]);return(0,a.jsx)(n.OZ,{title:"AutoClick 问题 URL",description:"查看并处理连续失败的URL记录",children:(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"".concat(i.B8.cards.simple," p-4 grid grid-cols-1 md:grid-cols-3 gap-3"),children:[(0,a.jsx)("input",{className:"border rounded px-3 py-2",placeholder:"搜索URL关键词",value:s,onChange:e=>u(e.target.value)}),(0,a.jsx)("input",{className:"border rounded px-3 py-2",placeholder:"按用户ID筛选（可选）",value:h,onChange:e=>x(e.target.value)}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("button",{className:i.B8.buttons.primary,onClick:()=>m(1),children:"搜索"}),(0,a.jsx)("button",{className:i.B8.buttons.outline,onClick:()=>{u(""),x(""),m(1)},children:"重置"})]})]}),(0,a.jsxs)("div",{className:"".concat(i.B8.cards.simple," p-0 overflow-hidden"),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-3 border-b bg-gray-50",children:[(0,a.jsxs)("div",{className:"text-sm text-gray-600",children:["已选中 ",v.length," 条"]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("button",{className:i.B8.buttons.outline,disabled:!v.length||f.isPending,onClick:()=>f.mutate({ids:v,op:"prefer"}),children:"批量优先浏览器"}),(0,a.jsx)("button",{className:i.B8.buttons.outline,disabled:!v.length||f.isPending,onClick:()=>f.mutate({ids:v,op:"reset"}),children:"批量重置计数"}),(0,a.jsx)("button",{className:i.B8.buttons.outline,disabled:!v.length||f.isPending,onClick:()=>f.mutate({ids:v,op:"clear_prefer"}),children:"批量清除优先"}),(0,a.jsx)("button",{className:i.B8.buttons.danger,disabled:!v.length||f.isPending,onClick:()=>{confirm("确认删除选中记录？")&&f.mutate({ids:v,op:"delete"})},children:"批量删除"})]})]}),(0,a.jsxs)("table",{className:"min-w-full text-sm",children:[(0,a.jsx)("thead",{className:"bg-gray-50",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-3 py-2",children:(0,a.jsx)("input",{type:"checkbox",onChange:()=>{let e=((null==j?void 0:j.rows)||[]).map(e=>e.id);k(e.every(e=>v.includes(e))?[]:e)},checked:((null==j?void 0:j.rows)||[]).length>0&&((null==j?void 0:j.rows)||[]).every(e=>v.includes(e.id))})}),(0,a.jsx)("th",{className:"px-3 py-2 text-left",children:"URL"}),(0,a.jsx)("th",{className:"px-3 py-2 text-left",children:"用户"}),(0,a.jsx)("th",{className:"px-3 py-2",children:"HTTP失败"}),(0,a.jsx)("th",{className:"px-3 py-2",children:"浏览器失败"}),(0,a.jsx)("th",{className:"px-3 py-2",children:"最近失败"}),(0,a.jsx)("th",{className:"px-3 py-2",children:"优先浏览器至"}),(0,a.jsx)("th",{className:"px-3 py-2",children:"备注"}),(0,a.jsx)("th",{className:"px-3 py-2",children:"操作"})]})}),(0,a.jsx)("tbody",{children:y?(0,a.jsx)("tr",{children:(0,a.jsx)("td",{colSpan:6,className:"px-3 py-6 text-center text-gray-500",children:"加载中..."})}):0===((null==j?void 0:j.rows)||[]).length?(0,a.jsx)("tr",{children:(0,a.jsx)("td",{colSpan:6,className:"px-3 py-6 text-center text-gray-500",children:"暂无数据"})}):((null==j?void 0:j.rows)||[]).map(e=>(0,a.jsxs)("tr",{className:"border-t",children:[(0,a.jsx)("td",{className:"px-3 py-2 text-center",children:(0,a.jsx)("input",{type:"checkbox",checked:v.includes(e.id),onChange:()=>q(e.id)})}),(0,a.jsx)("td",{className:"px-3 py-2 break-all max-w-[420px]",children:e.url}),(0,a.jsx)("td",{className:"px-3 py-2 text-gray-600",children:e.userId}),(0,a.jsx)("td",{className:"px-3 py-2 text-center",children:e.httpFailConsecutive}),(0,a.jsx)("td",{className:"px-3 py-2 text-center",children:e.browserFailConsecutive}),(0,a.jsx)("td",{className:"px-3 py-2 text-gray-600",children:e.lastFailAt?new Date(e.lastFailAt).toLocaleString("zh-CN"):"-"}),(0,a.jsx)("td",{className:"px-3 py-2 text-gray-600",children:e.preferBrowserUntil?new Date(e.preferBrowserUntil).toLocaleString("zh-CN"):"-"}),(0,a.jsx)("td",{className:"px-3 py-2 text-gray-600 max-w-[260px] truncate",title:e.notes||"",children:e.notes||"-"}),(0,a.jsx)("td",{className:"px-3 py-2",children:(0,a.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,a.jsx)("button",{className:i.B8.buttons.outline,onClick:()=>b.mutate(e.id),disabled:b.isPending,children:"优先浏览器"}),(0,a.jsx)("button",{className:i.B8.buttons.outline,onClick:()=>N.mutate(e.id),disabled:N.isPending,children:"重置计数"}),e.preferBrowserUntil&&(0,a.jsx)("button",{className:i.B8.buttons.outline,onClick:async()=>{try{await fetch("/ops/api/v1/console/autoclick/url-failures/".concat(e.id),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({clearPrefer:!0})}),location.reload()}catch(e){}},children:"清除优先"}),(0,a.jsx)("button",{className:i.B8.buttons.outline,onClick:()=>R(e.url),children:"诊断"}),(0,a.jsx)("button",{className:i.B8.buttons.outline,onClick:()=>{C(e.id),B(e.notes||"")},children:"备注"}),(0,a.jsx)("button",{className:i.B8.buttons.danger,onClick:()=>{confirm("确认删除记录？")&&g.mutate(e.id)},disabled:g.isPending,children:"删除"})]})})]},e.id))})]})]}),w&&(0,a.jsxs)("div",{className:"".concat(i.B8.cards.simple," p-4 flex items-center gap-3"),children:[(0,a.jsx)("textarea",{className:"flex-1 border rounded px-3 py-2 min-h-[80px]",value:S,onChange:e=>B(e.target.value),placeholder:"填写备注..."}),(0,a.jsx)("button",{className:i.B8.buttons.primary,onClick:async()=>{try{await fetch("/ops/api/v1/console/autoclick/url-failures/".concat(w),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({notes:S})}),C(null),k([]),location.reload()}catch(e){}},children:"保存"}),(0,a.jsx)("button",{className:i.B8.buttons.outline,onClick:()=>C(null),children:"取消"})]}),P&&(0,a.jsx)("div",{className:"fixed inset-0 bg-black/40 flex items-center justify-center z-50",children:(0,a.jsxs)("div",{className:"bg-white rounded-xl w-[720px] max-w-[95vw] p-4 shadow-xl",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsxs)("h3",{className:"font-semibold",children:["诊断：",L]}),(0,a.jsx)("button",{className:i.B8.buttons.outline,onClick:()=>T(!1),children:"关闭"})]}),E?(0,a.jsx)("div",{className:"text-gray-500 p-6",children:"诊断中..."}):U?(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("div",{className:"text-sm text-gray-700",children:[(0,a.jsxs)("div",{children:["结果：",U.ok?"成功":"失败"]}),(0,a.jsxs)("div",{children:["分类：",U.classification||"-"]}),(0,a.jsxs)("div",{children:["HTTP：",null!=(t=U.httpStatus)?t:"-"]}),(0,a.jsxs)("div",{children:["最终URL：",U.finalUrl||"-"]}),(0,a.jsxs)("div",{children:["耗时：",U.durationMs," ms"]})]}),U.screenshotBase64&&(0,a.jsx)("div",{className:"border rounded overflow-hidden",children:(0,a.jsx)("img",{src:"data:image/jpeg;base64,".concat(U.screenshotBase64),alt:"screenshot"})})]}):(0,a.jsx)("div",{className:"text-gray-500 p-6",children:"无结果"})]})}),(0,a.jsxs)("div",{className:"flex items-center justify-end gap-3",children:[(0,a.jsx)("button",{className:i.B8.buttons.outline,onClick:()=>m(e=>Math.max(1,e-1)),children:"上一页"}),(0,a.jsxs)("span",{className:"text-sm text-gray-600",children:["第 ",p," 页"]}),(0,a.jsx)("button",{className:i.B8.buttons.outline,onClick:()=>m(e=>e+1),disabled:20>((null==j||null==(e=j.rows)?void 0:e.length)||0),children:"下一页"})]})]})})}},84056:(e,t,s)=>{Promise.resolve().then(s.bind(s,303))}},e=>{var t=t=>e(e.s=t);e.O(0,[2076,4121,7358],()=>t(84056)),_N_E=e.O()}]);