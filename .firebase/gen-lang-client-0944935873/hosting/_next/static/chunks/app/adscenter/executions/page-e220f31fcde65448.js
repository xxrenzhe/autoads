(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5608],{23245:(e,s,t)=>{Promise.resolve().then(t.bind(t,59424))},59424:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>S});var a=t(54568),l=t(7620),r=t(47227),n=t(63353),i=t(64148),c=t(80244),d=t(33020),o=t(44023),x=t(18529),m=t(90721),u=t(80035),h=t(6541),j=t(89729),p=t(557),g=t(39756),f=t(22878),N=t(28359),v=t(3761),y=t(70111),w=t(51874),b=t(8039);function S(){let[e,s]=(0,l.useState)([]),[t,S]=(0,l.useState)([]),[I,k]=(0,l.useState)(!0),[L,A]=(0,l.useState)(null),[T,D]=(0,l.useState)(!1),[_,C]=(0,l.useState)(null),[R,U]=(0,l.useState)(null),[Z,O]=(0,l.useState)(null);(0,l.useEffect)(()=>(E(),C(setInterval(()=>{M()},3e4)),()=>{_&&clearInterval(_)}),[]),(0,l.useEffect)(()=>{let e=null;try{(e=new EventSource("/api/adscenter/executions/events")).onmessage=e=>{try{let t=JSON.parse(e.data||"{}");if(!t||!t.type)return;"execution_update"===t.type&&(s(e=>{let s=[...e],a=s.findIndex(e=>e.id===t.id);return -1!==a?s[a]={...s[a],status:t.status||s[a].status,progress:"number"==typeof t.progress?t.progress:s[a].progress,metadata:{...s[a].metadata,totalLinks:"number"==typeof t.totalItems?t.totalItems:s[a].metadata.totalLinks,processedLinks:"number"==typeof t.processedItems?t.processedItems:s[a].metadata.processedLinks},endTime:t.completedAt||s[a].endTime}:"created"===t.status&&t.id&&s.unshift({id:t.id,configurationId:t.configurationId||"unknown",userId:"me",status:"pending",progress:0,totalSteps:1,currentStep:"initialized",startTime:new Date().toISOString(),results:[],errors:[],metadata:{totalLinks:0,processedLinks:0,successfulUpdates:0,failedUpdates:0}}),s}),["completed","failed","cancelled"].includes(t.status)&&(s(e=>e.filter(e=>e.id!==t.id)),S(e=>[{id:t.id,configurationId:t.configurationId||"unknown",userId:"me",status:t.status,progress:100,totalSteps:1,currentStep:"finished",startTime:new Date().toISOString(),endTime:t.completedAt||new Date().toISOString(),results:[],errors:[],metadata:{totalLinks:t.totalItems||0,processedLinks:t.processedItems||0,successfulUpdates:0,failedUpdates:0}},...e])))}catch(e){}}}catch(e){}return()=>{try{null==e||e.close()}catch(e){}}},[]),(0,l.useEffect)(()=>{let e=()=>{document.hidden?_&&(clearInterval(_),C(null)):(C(setInterval(()=>{M()},3e4)),M())};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}},[_]);let E=async()=>{try{k(!0),await Promise.all([M(),W()])}catch(e){console.error("加载执行记录失败:",e)}finally{k(!1)}},M=async()=>{try{let e=await b.L.getCached("/adscenter/executions",void 0,15e3),t=(Array.isArray(e)?e:(null==e?void 0:e.data)||[]).filter(e=>"completed"!==e.status).map(e=>{var s,t,a,l;return{id:e.id,configurationId:e.configurationId,userId:"me",status:e.status||"pending",progress:null!=(s=e.progress)?s:0,totalSteps:null!=(t=e.totalSteps)?t:1,currentStep:e.currentStep||"initialized",startTime:e.started_at||e.createdAt||new Date().toISOString(),endTime:e.completed_at,results:[],errors:[],metadata:{totalLinks:null!=(a=e.total_items)?a:0,processedLinks:null!=(l=e.processed_items)?l:0,successfulUpdates:0,failedUpdates:0}}});s(t)}catch(e){console.error("加载活跃执行失败:",e)}},W=async()=>{try{let e=await b.L.getCached("/adscenter/executions",void 0,3e4),s=(Array.isArray(e)?e:(null==e?void 0:e.data)||[]).filter(e=>"completed"===e.status||"failed"===e.status||"cancelled"===e.status).map(e=>{var s,t,a,l;return{id:e.id,configurationId:e.configurationId,userId:"me",status:e.status||"completed",progress:null!=(s=e.progress)?s:100,totalSteps:null!=(t=e.totalSteps)?t:1,currentStep:e.currentStep||"finished",startTime:e.started_at||e.createdAt||new Date().toISOString(),endTime:e.completed_at||new Date().toISOString(),results:[],errors:[],metadata:{totalLinks:null!=(a=e.total_items)?a:0,processedLinks:null!=(l=e.processed_items)?l:0,successfulUpdates:0,failedUpdates:0}}});S(s)}catch(e){console.error("加载历史执行失败:",e)}},B=async e=>{try{U(e);let s=await b.L.post("/adscenter/executions/".concat(e,"/cancel"),{});s.success?(M(),w.oR.success("执行已取消")):w.oR.error("取消执行失败: "+(s.error||"请稍后重试"))}catch(e){console.error("取消执行失败:",e),w.oR.error("取消执行失败，请稍后重试")}finally{U(null)}},z=async function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;try{let t=Math.max(0,Math.min(100,e.progress+s)),a=Math.max(0,Math.min(e.metadata.totalLinks,e.metadata.processedLinks+Math.ceil(s/100*Math.max(1,e.metadata.totalLinks))));await b.L.patch("/adscenter/executions/".concat(e.id),{progress:t,processedItems:a,totalItems:e.metadata.totalLinks,startedAt:e.startTime}),await M(),w.oR.success("进度已更新")}catch(e){w.oR.error("更新进度失败")}},X=async e=>{try{await b.L.patch("/adscenter/executions/".concat(e.id),{status:"completed",progress:100,processedItems:e.metadata.totalLinks,totalItems:e.metadata.totalLinks,startedAt:e.startTime,completedAt:new Date().toISOString()}),await E(),w.oR.success("已标记为完成")}catch(e){w.oR.error("标记失败")}},$=async e=>{try{let r=await b.L.get("/adscenter/executions/".concat(e));if((null==r?void 0:r.success)===!1)w.oR.error("获取执行详情失败: "+r.error);else{var s,t,a,l;let e=(null==r?void 0:r.data)||r,n={id:e.id,configurationId:e.configurationId,userId:"me",status:e.status||"pending",progress:null!=(s=e.progress)?s:0,totalSteps:null!=(t=e.totalSteps)?t:1,currentStep:e.currentStep||"initialized",startTime:e.started_at||e.createdAt||new Date().toISOString(),endTime:e.completed_at,results:[],errors:[],metadata:{totalLinks:null!=(a=e.total_items)?a:0,processedLinks:null!=(l=e.processed_items)?l:0,successfulUpdates:0,failedUpdates:0}};A(n),D(!0)}}catch(e){console.error("获取执行详情失败:",e),w.oR.error("获取执行详情失败，请稍后重试")}},F=e=>{let s={pending:d.A,running:o.A,completed:x.A,failed:m.A,cancelled:u.A}[e]||d.A;return(0,a.jsxs)(i.E,{variant:{pending:"secondary",running:"default",completed:"default",failed:"destructive",cancelled:"secondary"}[e]||"default",className:"flex items-center gap-1",children:[(0,a.jsx)(s,{className:"h-3 w-3"}),{pending:"等待中",running:"执行中",completed:"已完成",failed:"失败",cancelled:"已取消"}[e]||e]})},G=(e,s)=>{let t=new Date(e),a=Math.floor(((s?new Date(s):new Date).getTime()-t.getTime())/1e3),l=Math.floor(a/60),r=Math.floor(l/60);return r>0?"".concat(r,"小时").concat(l%60,"分钟"):l>0?"".concat(l,"分钟").concat(a%60,"秒"):"".concat(a,"秒")},P=e=>{let{execution:s,isActive:t=!1}=e;return(0,a.jsxs)(n.Zp,{className:"hover:shadow-lg transition-shadow",children:[(0,a.jsx)(n.aR,{children:(0,a.jsxs)("div",{className:"flex justify-between items-start",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)(n.ZB,{className:"text-lg",children:["执行 #",s.id.slice(-8)]}),(0,a.jsxs)(n.BT,{children:["配置ID: ",s.configurationId.slice(-8)]})]}),F(s.status)]})}),(0,a.jsx)(n.Wu,{children:(0,a.jsxs)("div",{className:"space-y-3",children:[t&&"running"===s.status&&(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex justify-between text-sm mb-1",children:[(0,a.jsx)("span",{children:"进度"}),(0,a.jsxs)("span",{children:[s.progress,"%"]})]}),(0,a.jsx)(c.k,{value:s.progress,className:"h-2"}),(0,a.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:s.currentStep})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"总链接数:"}),(0,a.jsx)("span",{className:"ml-2",children:s.metadata.totalLinks})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"已处理:"}),(0,a.jsx)("span",{className:"ml-2",children:s.metadata.processedLinks})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"成功更新:"}),(0,a.jsx)("span",{className:"ml-2 text-green-600",children:s.metadata.successfulUpdates})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{className:"text-gray-600",children:"失败更新:"}),(0,a.jsx)("span",{className:"ml-2 text-red-600",children:s.metadata.failedUpdates})]})]}),(0,a.jsxs)("div",{className:"text-sm",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"开始时间:"}),(0,a.jsx)("span",{children:new Date(s.startTime).toLocaleString()})]}),s.endTime&&(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"结束时间:"}),(0,a.jsx)("span",{children:new Date(s.endTime).toLocaleString()})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"持续时间:"}),(0,a.jsx)("span",{children:G(s.startTime,s.endTime)})]})]}),(0,a.jsxs)("div",{className:"flex gap-2 mt-4",children:[(0,a.jsxs)(r.$,{size:"sm",variant:"outline",onClick:()=>$(s.id),children:[(0,a.jsx)(h.A,{className:"h-4 w-4 mr-1"}),"详情"]}),t&&"running"===s.status&&(0,a.jsxs)(r.$,{size:"sm",variant:"outline",disabled:R===s.id,onClick:()=>O(s.id),children:[(0,a.jsx)(j.A,{className:"h-4 w-4 mr-1 ".concat(R===s.id?"animate-pulse":"")}),R===s.id?"取消中...":"取消"]}),t&&"running"===s.status&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(r.$,{size:"sm",variant:"outline",onClick:()=>z(s,10),children:[(0,a.jsx)(p.A,{className:"h-4 w-4 mr-1"})," 进度+10%"]}),(0,a.jsxs)(r.$,{size:"sm",onClick:()=>X(s),children:[(0,a.jsx)(x.A,{className:"h-4 w-4 mr-1"})," 标记完成"]})]})]})]})})]})};return I?(0,a.jsx)("div",{className:"container mx-auto p-6",children:(0,a.jsx)("div",{className:"flex items-center justify-center h-64",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"}),(0,a.jsx)("p",{children:"加载执行记录中..."})]})})}):(0,a.jsxs)("div",{className:"container mx-auto p-6",children:[(0,a.jsx)(N.lG,{open:!!Z,onOpenChange:e=>{e||O(null)},children:(0,a.jsxs)(N.Cf,{children:[(0,a.jsxs)(N.c7,{children:[(0,a.jsx)(N.L3,{children:"取消执行"}),(0,a.jsx)(N.rr,{children:"确定要取消该执行任务吗？此操作无法恢复。"})]}),(0,a.jsxs)("div",{className:"flex justify-end gap-2",children:[(0,a.jsx)("button",{className:"px-4 py-2 rounded border",onClick:()=>O(null),children:"关闭"}),(0,a.jsx)("button",{className:"px-4 py-2 rounded bg-red-600 text-white disabled:opacity-50",disabled:R===Z,onClick:async()=>{O(null),await B(Z)},children:"确认取消"})]})]})}),(0,a.jsxs)("div",{className:"flex justify-between items-center mb-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-3xl font-bold mb-2",children:"执行记录"}),(0,a.jsx)("p",{className:"text-gray-600",children:"查看自动化执行的历史记录和实时状态"})]}),(0,a.jsxs)(r.$,{onClick:E,variant:"outline",children:[(0,a.jsx)(g.A,{className:"h-4 w-4 mr-2"}),"刷新"]})]}),(0,a.jsxs)(v.tU,{defaultValue:"active",className:"w-full",children:[(0,a.jsxs)(v.j7,{className:"grid w-full grid-cols-2",children:[(0,a.jsxs)(v.Xi,{value:"active",children:["活跃执行 (",e.length,")"]}),(0,a.jsxs)(v.Xi,{value:"history",children:["历史记录 (",t.length,")"]})]}),(0,a.jsx)(v.av,{value:"active",className:"space-y-6",children:0===e.length?(0,a.jsx)(n.Zp,{children:(0,a.jsxs)(n.Wu,{className:"flex flex-col items-center justify-center py-12",children:[(0,a.jsx)(o.A,{className:"h-12 w-12 text-gray-400 mb-4"}),(0,a.jsx)("h3",{className:"text-lg font-medium mb-2",children:"暂无活跃执行"}),(0,a.jsx)("p",{className:"text-gray-600",children:"当前没有正在执行的任务"})]})}):(0,a.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:e.map(e=>(0,a.jsx)(P,{execution:e,isActive:!0},e.id))})}),(0,a.jsx)(v.av,{value:"history",className:"space-y-6",children:0===t.length?(0,a.jsx)(n.Zp,{children:(0,a.jsxs)(n.Wu,{className:"flex flex-col items-center justify-center py-12",children:[(0,a.jsx)(f.A,{className:"h-12 w-12 text-gray-400 mb-4"}),(0,a.jsx)("h3",{className:"text-lg font-medium mb-2",children:"暂无历史记录"}),(0,a.jsx)("p",{className:"text-gray-600",children:"还没有执行过任何任务"})]})}):(0,a.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:t.map(e=>(0,a.jsx)(P,{execution:e},e.id))})})]}),(0,a.jsx)(N.lG,{open:T,onOpenChange:D,children:(0,a.jsxs)(N.Cf,{className:"max-w-4xl max-h-[80vh] overflow-y-auto",children:[(0,a.jsxs)(N.c7,{children:[(0,a.jsx)(N.L3,{children:"执行详情"}),(0,a.jsx)(N.rr,{children:"查看执行的详细信息和步骤"})]}),L&&(0,a.jsx)(e=>{let{execution:s}=e;return(0,a.jsxs)(v.tU,{defaultValue:"overview",className:"w-full",children:[(0,a.jsxs)(v.j7,{className:"grid w-full grid-cols-3",children:[(0,a.jsx)(v.Xi,{value:"overview",children:"概览"}),(0,a.jsx)(v.Xi,{value:"steps",children:"执行步骤"}),(0,a.jsx)(v.Xi,{value:"errors",children:"错误信息"})]}),(0,a.jsxs)(v.av,{value:"overview",className:"space-y-4",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)(n.Zp,{children:[(0,a.jsx)(n.aR,{className:"pb-2",children:(0,a.jsx)(n.ZB,{className:"text-sm",children:"执行状态"})}),(0,a.jsx)(n.Wu,{children:F(s.status)})]}),(0,a.jsxs)(n.Zp,{children:[(0,a.jsx)(n.aR,{className:"pb-2",children:(0,a.jsx)(n.ZB,{className:"text-sm",children:"进度"})}),(0,a.jsxs)(n.Wu,{children:[(0,a.jsxs)("div",{className:"text-2xl font-bold",children:[s.progress,"%"]}),(0,a.jsx)(c.k,{value:s.progress,className:"mt-2"})]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,a.jsxs)(n.Zp,{children:[(0,a.jsx)(n.aR,{className:"pb-2",children:(0,a.jsx)(n.ZB,{className:"text-sm",children:"成功更新"})}),(0,a.jsx)(n.Wu,{children:(0,a.jsx)("div",{className:"text-2xl font-bold text-green-600",children:s.metadata.successfulUpdates})})]}),(0,a.jsxs)(n.Zp,{children:[(0,a.jsx)(n.aR,{className:"pb-2",children:(0,a.jsx)(n.ZB,{className:"text-sm",children:"失败更新"})}),(0,a.jsx)(n.Wu,{children:(0,a.jsx)("div",{className:"text-2xl font-bold text-red-600",children:s.metadata.failedUpdates})})]})]}),(0,a.jsxs)(n.Zp,{children:[(0,a.jsx)(n.aR,{children:(0,a.jsx)(n.ZB,{className:"text-sm",children:"执行信息"})}),(0,a.jsxs)(n.Wu,{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"执行ID:"}),(0,a.jsx)("span",{className:"font-mono",children:s.id})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"配置ID:"}),(0,a.jsx)("span",{className:"font-mono",children:s.configurationId})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"当前步骤:"}),(0,a.jsx)("span",{children:s.currentStep})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"总步骤数:"}),(0,a.jsx)("span",{children:s.totalSteps})]})]})]})]}),(0,a.jsx)(v.av,{value:"steps",className:"space-y-4",children:0===s.results.length?(0,a.jsxs)(y.Fc,{children:[(0,a.jsx)(u.A,{className:"h-4 w-4"}),(0,a.jsx)(y.TN,{children:"暂无执行步骤记录"})]}):s.results.map((e,s)=>(0,a.jsxs)(n.Zp,{children:[(0,a.jsx)(n.aR,{className:"pb-2",children:(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)(n.ZB,{className:"text-sm",children:e.step}),(0,a.jsx)(i.E,{variant:"success"===e.status?"default":"destructive",children:"success"===e.status?"成功":"失败"})]})}),(0,a.jsx)(n.Wu,{children:(0,a.jsxs)("div",{className:"text-sm space-y-1",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"开始时间:"}),(0,a.jsx)("span",{children:new Date(e.startTime).toLocaleString()})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"结束时间:"}),(0,a.jsx)("span",{children:new Date(e.endTime).toLocaleString()})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"耗时:"}),(0,a.jsxs)("span",{children:[e.duration,"ms"]})]}),e.error&&(0,a.jsxs)("div",{className:"mt-2",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"错误信息:"}),(0,a.jsx)("p",{className:"text-red-600 text-xs mt-1",children:e.error})]})]})})]},s))}),(0,a.jsx)(v.av,{value:"errors",className:"space-y-4",children:0===s.errors.length?(0,a.jsxs)(y.Fc,{children:[(0,a.jsx)(x.A,{className:"h-4 w-4"}),(0,a.jsx)(y.TN,{children:"无错误记录"})]}):s.errors.map((e,s)=>(0,a.jsxs)(y.Fc,{variant:"destructive",children:[(0,a.jsx)(m.A,{className:"h-4 w-4"}),(0,a.jsx)(y.TN,{children:(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{children:"步骤:"})," ",e.step]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{children:"错误:"})," ",e.error]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{children:"时间:"})," ",new Date(e.timestamp).toLocaleString()]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{children:"可恢复:"})," ",e.recoverable?"是":"否"]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("strong",{children:"重试次数:"})," ",e.retryCount]})]})})]},s))})]})},{execution:L})]})})]})}}},e=>{var s=s=>e(e.s=s);e.O(0,[2076,4121,7358],()=>s(23245)),_N_E=e.O()}]);