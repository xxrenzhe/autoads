# 基于订阅套餐的速率限制系统

## 概述

系统已经实现了一个基于用户订阅套餐的速率限制机制，而不是单独设置每个用户的限制。用户的速率限制由其当前订阅的套餐决定。

## 实现细节

### 1. 核心设计原则

- **套餐驱动**：所有速率限制都基于用户订阅的套餐（FREE/PRO/MAX）
- **动态查询**：系统实时查询用户的套餐信息并应用相应的限制
- **统一管理**：管理员通过配置套餐来管理所有用户的限制

### 2. 套餐限制配置

每个套餐包含以下限制：

#### FREE 套餐
- API请求：30次/分钟，1000次/小时
- SiteRank查询：2次/分钟，50次/小时
- BatchGo任务：1个并发任务，5个任务/分钟

#### PRO 套餐
- API请求：100次/分钟，5000次/小时
- SiteRank查询：10次/分钟，200次/小时
- BatchGo任务：5个并发任务，20个任务/分钟

#### MAX 套餐
- API请求：500次/分钟，20000次/小时
- SiteRank查询：50次/分钟，1000次/小时
- BatchGo任务：20个并发任务，100个任务/分钟

### 3. 实现架构

#### RateLimitManager
- 查询用户的订阅信息（`PlanName`字段）
- 根据套餐类型应用相应的限制
- 使用令牌桶算法实现平滑限流
- 自动清理不活跃用户的限流器

#### 用户模型
```go
type User struct {
    // ... 其他字段
    PlanID         *string    `json:"plan_id"`
    PlanName      string     `json:"plan_name" gform:"default:'FREE'"`
    PlanExpiresAt  *time.Time `json:"plan_expires_at"`
    // ... 其他字段
}
```

### 4. 主要API端点

#### 套餐配置管理
- `GET /api/v1/admin/rate-limits/plan` - 获取所有套餐的限制配置
- `PUT /api/v1/admin/rate-limits/plan/{plan}` - 更新指定套餐的限制配置

#### 统计和监控
- `GET /api/v1/admin/rate-limits/user/{userId}/stats` - 获取用户速率限制统计（包含套餐信息）
- `GET /api/v1/admin/rate-limits/system/stats` - 获取系统整体统计
- `GET /api/v1/admin/rate-limits/active` - 查看活跃的限流器

### 5. 工作流程

1. **用户请求**：用户发起API请求
2. **套餐查询**：系统查询用户的当前套餐
3. **限制应用**：根据套餐配置应用相应的速率限制
4. **请求处理**：如果未超过限制，处理请求；否则拒绝
5. **统计更新**：更新使用统计

### 6. 套餐变更处理

- 当用户升级或降级套餐时，新的限制立即生效
- 系统会保留用户的当前限流器状态，但使用新的套餐限制
- 管理员可以手动重置用户的限流器

### 7. 数据库支持

Prisma schema中的Plan模型支持存储套餐配置：
```prisma
model Plan {
    id      String  @id @default(cuid())
    name    String
    limits  Json?   // 存储速率限制配置
    // ... 其他字段
}
```

### 8. 前端管理界面

管理员可以通过Web界面：
- 查看和编辑各套餐的限制配置
- 监控用户的使用情况
- 查看按套餐分布的统计信息
- 重置用户的限流器状态

## 优势

1. **简化管理**：管理员只需配置套餐，无需管理每个用户
2. **一致性**：同一套餐的所有用户享有相同的限制
3. **灵活性**：可以通过修改套餐配置快速调整限制
4. **可扩展性**：容易添加新的套餐类型

## 后续改进建议

1. **数据库集成**：实现从数据库加载套餐配置
2. **历史记录**：记录套餐变更和限制调整的历史
3. **通知系统**：当用户接近限制时发送通知
4. **临时调整**：支持为特定用户临时调整限制
5. **缓存优化**：缓存用户的套餐信息以减少数据库查询